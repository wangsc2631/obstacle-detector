<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="theme-color" content="#0ea5e9" />
  <meta name="description" content="æ™ºèƒ½ç”Ÿæ´»åŠ©æ‰‹ - ç›²äººè¼”åŠ©å°èˆªèˆ‡ç‰©å“è­˜åˆ¥ç³»çµ±" />
  <title>ğŸ§  æ™ºèƒ½ç”Ÿæ´»åŠ©æ‰‹ - ç›²äººè¼”åŠ©å°èˆª</title>
  
  <style>
    :root {
      --bg1: #0ea5e9;
      --bg2: #6366f1;
      --glass: rgba(255,255,255,0.12);
      --glass-strong: rgba(255,255,255,0.22);
      --text: #fff;
      --good: #22c55e;
      --warn: #f59e0b;
      --bad: #ef4444;
      --muted: #cbd5e1;
      --primary: #00b894;
      --secondary: #fd79a8;
      --accent: #6c5ce7;
    }
    
    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      overflow-x: hidden;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      color: var(--text);
      background: linear-gradient(135deg, var(--bg1), var(--bg2));
      touch-action: manipulation;
    }
    
    body {
      padding: 10px;
      padding-bottom: env(safe-area-inset-bottom, 10px);
    }
    
    .app {
      max-width: 100%;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .card {
      background: var(--glass);
      backdrop-filter: blur(12px);
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    }
    
    .header {
      text-align: center;
      margin-bottom: 0;
    }
    
    .header h1 {
      margin: 0;
      font-size: 24px;
    }
    
    .header .subtitle {
      font-size: 14px;
      color: var(--muted);
      margin-top: 5px;
    }
    
    .stats-badge {
      background: rgba(255,255,255,0.2);
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 12px;
      margin-top: 8px;
      display: inline-block;
    }
    
    .camera-container {
      position: relative;
      width: 100%;
      aspect-ratio: 16/9;
      background: #000;
      border-radius: 12px;
      overflow: hidden;
    }
    
    .camera-container video {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 12px;
    }
    
    .camera-preview {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #000;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 16px;
      z-index: 5;
      text-align: center;
      padding: 20px;
    }
    
    .controls {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-bottom: 15px;
    }
    
    button {
      padding: 16px 12px;
      border: none;
      border-radius: 14px;
      font-weight: 700;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
      min-height: 54px;
      user-select: none;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 5px;
    }
    
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    button:active:not(:disabled) {
      transform: translateY(2px) scale(0.98);
    }
    
    .btn-primary {
      background: var(--primary);
      color: #fff;
    }
    
    .btn-danger {
      background: var(--bad);
      color: #fff;
    }
    
    .btn-secondary {
      background: var(--glass-strong);
      color: var(--text);
    }
    
    .btn-accent {
      background: var(--accent);
      color: #fff;
    }
    
    .status-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin-bottom: 12px;
    }
    
    .status-item {
      background: var(--glass-strong);
      border-radius: 12px;
      padding: 12px;
      text-align: center;
    }
    
    .status-label {
      font-size: 11px;
      color: var(--muted);
      margin-bottom: 4px;
    }
    
    .status-value {
      font-weight: 800;
      font-size: 16px;
    }
    
    .voice-alert {
      background: rgba(0, 184, 148, 0.15);
      border: 1px solid rgba(0, 184, 148, 0.35);
      color: #fff;
      border-radius: 12px;
      padding: 16px;
      text-align: center;
      min-height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      margin-bottom: 15px;
    }
    
    .detection-list {
      max-height: 200px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    
    .detection-item {
      background: var(--glass-strong);
      padding: 10px;
      border-radius: 10px;
      font-size: 13px;
    }
    
    .items-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 10px;
      margin-top: 15px;
      max-height: 300px;
      overflow-y: auto;
    }
    
    .item-card {
      background: rgba(255,255,255,0.1);
      padding: 15px 10px;
      border-radius: 15px;
      text-align: center;
      border: 2px solid rgba(255,255,255,0.1);
      transition: all 0.3s ease;
    }
    
    .item-card.highlight {
      animation: pulse 2s ease-in-out;
      border-color: var(--primary);
    }
    
    .item-name {
      font-size: 16px;
      font-weight: bold;
      margin-bottom: 5px;
      color: var(--text);
    }
    
    .item-confidence {
      font-size: 12px;
      color: var(--muted);
    }
    
    .category-tag {
      display: inline-block;
      background: var(--accent);
      color: white;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 10px;
      margin-top: 5px;
    }
    
    .navigation-info {
      background: rgba(253, 203, 110, 0.15);
      border: 1px solid rgba(253, 203, 110, 0.35);
      padding: 20px;
      border-radius: 12px;
      margin: 15px 0;
      text-align: center;
    }
    
    .direction-arrow {
      font-size: 48px;
      margin: 10px 0;
      color: var(--bad);
    }
    
    .distance-display {
      font-size: 24px;
      font-weight: bold;
      margin: 10px 0;
      color: var(--text);
    }
    
    .instruction-text {
      font-size: 18px;
      color: var(--text);
      margin: 10px 0;
    }
    
    .mode-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
    }
    
    .mode-recording { background: var(--bad); }
    .mode-identifying { background: var(--primary); }
    .mode-navigating { background: var(--accent); }
    .mode-idle { background: var(--muted); }
    
    .search-box {
      margin: 15px 0;
      padding: 15px;
      background: rgba(255,255,255,0.1);
      border-radius: 15px;
    }
    
    .search-input {
      width: 100%;
      padding: 12px;
      border: 2px solid rgba(255,255,255,0.2);
      border-radius: 10px;
      font-size: 16px;
      background: rgba(255,255,255,0.1);
      color: var(--text);
    }
    
    .search-input::placeholder {
      color: var(--muted);
    }
    
    .category-filter {
      display: flex;
      gap: 8px;
      margin-top: 10px;
      flex-wrap: wrap;
    }
    
    .category-btn {
      padding: 6px 12px;
      background: rgba(255,255,255,0.1);
      border: none;
      border-radius: 15px;
      font-size: 12px;
      cursor: pointer;
      color: var(--text);
    }
    
    .category-btn.active {
      background: var(--accent);
      color: white;
    }
    
    .debug-info {
      background: rgba(0,0,0,0.8);
      color: #00ff00;
      padding: 8px;
      border-radius: 5px;
      font-size: 12px;
      margin-top: 8px;
      font-family: monospace;
    }
    
    .loading {
      background: linear-gradient(90deg, var(--bg1), var(--bg2), var(--bg1));
      background-size: 200% 100%;
      animation: loading 2s infinite;
    }
    
    @keyframes loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
    
    @keyframes pulse {
      0%, 100% { 
        transform: scale(1);
        box-shadow: 0 3px 10px rgba(0,0,0,0.1);
      }
      50% { 
        transform: scale(1.05);
        box-shadow: 0 5px 20px rgba(0, 184, 148, 0.4);
      }
    }
    
    .tab-container {
      display: flex;
      gap: 5px;
      margin-bottom: 15px;
    }
    
    .tab {
      flex: 1;
      padding: 12px;
      text-align: center;
      background: rgba(255,255,255,0.1);
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
    }
    
    .tab.active {
      background: var(--accent);
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .camera-controls {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    
    .camera-switch {
      flex: 1;
      padding: 10px;
      background: var(--glass-strong);
      border: none;
      border-radius: 10px;
      color: var(--text);
      font-size: 14px;
      cursor: pointer;
    }
    
    .error-message {
      background: rgba(239,68,68,0.15);
      border: 1px solid rgba(239,68,68,0.35);
      color: #fff;
      border-radius: 12px;
      padding: 16px;
      text-align: center;
      margin: 10px 0;
    }
    
    .progress-bar {
      width: 100%;
      height: 6px;
      background: rgba(255,255,255,0.1);
      border-radius: 3px;
      margin: 10px 0;
      overflow: hidden;
    }
    
    .progress-fill {
      height: 100%;
      background: var(--primary);
      border-radius: 3px;
      transition: width 0.3s ease;
      width: 0%;
    }
    
    .navigation-controls {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 15px;
    }
    
    .turn-instruction {
      font-size: 20px;
      font-weight: bold;
      text-align: center;
      margin: 10px 0;
      padding: 15px;
      background: rgba(255,255,255,0.1);
      border-radius: 12px;
    }
    
    .safety-alert {
      background: rgba(239,68,68,0.2);
      border: 1px solid rgba(239,68,68,0.4);
      color: #fff;
      border-radius: 12px;
      padding: 12px;
      text-align: center;
      margin: 10px 0;
      font-size: 14px;
    }
    
    .road-info {
      background: rgba(34,197,94,0.15);
      border: 1px solid rgba(34,197,94,0.35);
      color: #fff;
      border-radius: 12px;
      padding: 12px;
      text-align: center;
      margin: 10px 0;
      font-size: 14px;
    }

    /* æ–°å¢ï¼šæª¢æ¸¬æ¡†æ¨£å¼ */
    .detection-canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 10;
      pointer-events: none;
    }

    .detection-box {
      position: absolute;
      border: 3px solid #00ff00;
      background: rgba(0, 255, 0, 0.1);
      border-radius: 8px;
      pointer-events: none;
      box-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
    }

    .detection-label {
      position: absolute;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: bold;
      pointer-events: none;
      transform: translateY(-100%);
      white-space: nowrap;
    }

    /* æ–°å¢ï¼šçµæŸå°èˆªæŒ‰éˆ•æ¨£å¼ */
    .navigation-stop-btn {
      background: var(--bad);
      color: white;
      border: none;
      border-radius: 10px;
      padding: 12px;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 10px;
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 5px;
    }

    .performance-badge {
      background: rgba(255,255,255,0.2);
      padding: 4px 8px;
      border-radius: 10px;
      font-size: 10px;
      margin-left: 5px;
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- æ¨™é¡Œ -->
    <div class="card header">
      <h1>ğŸ§  æ™ºèƒ½ç”Ÿæ´»åŠ©æ‰‹</h1>
      <div class="subtitle">ç›²äººè¼”åŠ©å°èˆª â€¢ ç‰©å“è­˜åˆ¥ç³»çµ±</div>
      <div class="stats-badge">é«˜é€Ÿ COCO-SSD æ¨¡å‹ â€¢ å„ªåŒ–è¾¨è­˜æ€§èƒ½</div>
    </div>

    <!-- æ¨™ç±¤åˆ‡æ› -->
    <div class="card">
      <div class="tab-container">
        <div class="tab active" data-tab="navigation">å°èˆªæ¨¡å¼</div>
        <div class="tab" data-tab="recognition">ç‰©å“è­˜åˆ¥</div>
      </div>
    </div>

    <!-- èªéŸ³æç¤º -->
    <div id="voiceAlert" class="voice-alert">
      ç³»çµ±æº–å‚™ä¸­...
    </div>

    <!-- éŒ¯èª¤è¨Šæ¯ -->
    <div id="errorMessage" class="error-message" style="display: none;"></div>

    <!-- å°èˆªæ¨¡å¼å…§å®¹ -->
    <div id="navigationTab" class="tab-content active">
      <!-- ç›¸æ©Ÿç•«é¢ -->
      <div class="card">
        <div class="camera-container">
          <div id="cameraPreview" class="camera-preview">
            <div>
              <div style="font-size:48px; margin-bottom:10px;">ğŸ“·</div>
              <div>é»æ“Šã€Œé–‹å•Ÿç›¸æ©Ÿã€é–‹å§‹ä½¿ç”¨</div>
              <div style="font-size:12px; margin-top:10px; color:var(--muted);">
                é“è·¯è¾¨è­˜èˆ‡éšœç¤™ç‰©æª¢æ¸¬
              </div>
            </div>
          </div>
          <video id="video" autoplay playsinline muted></video>
          <!-- æª¢æ¸¬æ¡†ç•«å¸ƒ -->
          <canvas id="detectionCanvas" class="detection-canvas"></canvas>
        </div>
      </div>

      <!-- æ§åˆ¶é¢æ¿ -->
      <div class="card">
        <div class="controls">
          <button id="btnCamera" class="btn-primary">
            <span>ğŸ“·</span>
            <span>é–‹å•Ÿç›¸æ©Ÿ</span>
          </button>
          <button id="btnStart" class="btn-primary" disabled>
            <span>ğŸ”</span>
            <span>é–‹å§‹æª¢æ¸¬</span>
          </button>
          <button id="btnTest" class="btn-secondary" disabled>
            <span>ğŸ§ª</span>
            <span>æ¸¬è©¦åŠŸèƒ½</span>
          </button>
          <button id="btnStop" class="btn-danger" disabled>
            <span>â¹ï¸</span>
            <span>åœæ­¢</span>
          </button>
        </div>

        <div class="status-grid">
          <div class="status-item">
            <div class="status-label">ç³»çµ±ç‹€æ…‹</div>
            <div class="status-value" id="status">æº–å‚™ä¸­</div>
          </div>
          <div class="status-item">
            <div class="status-label">æª¢æ¸¬æ¨¡å¼</div>
            <div class="status-value" id="detectionMode">é“è·¯è¾¨è­˜</div>
          </div>
          <div class="status-item">
            <div class="status-label">ç›¸æ©Ÿç‹€æ…‹</div>
            <div class="status-value" id="cameraStatus">æœªé–‹å•Ÿ</div>
          </div>
          <div class="status-item">
            <div class="status-label">å°èˆªç‹€æ…‹</div>
            <div class="status-value" id="navigationStatus">æœªé–‹å§‹</div>
          </div>
        </div>

        <div id="debugInfo" class="debug-info" style="display:none;"></div>
      </div>

      <!-- å°èˆªæ§åˆ¶ -->
      <div class="card">
        <h3 style="margin:0 0 12px 0;">å°èˆªå›å®¶</h3>
        <div class="navigation-controls">
          <button class="btn-primary" onclick="startNavigationHome()" id="btnNavigateHome">
            <span>ğŸ§­</span>
            <span>é–‹å§‹å°èˆªå›å®¶</span>
          </button>
          <button class="btn-accent" onclick="openGoogleMaps()" id="btnGoogleMaps">
            <span>ğŸ—ºï¸</span>
            <span>é–‹å•ŸGoogleåœ°åœ–</span>
          </button>
        </div>
        <!-- çµæŸå°èˆªæŒ‰éˆ• -->
        <button class="navigation-stop-btn" onclick="stopNavigation()" id="btnStopNavigation" style="display: none;">
          <span>â¹ï¸</span>
          <span>çµæŸå°èˆª</span>
        </button>
      </div>

      <!-- å°èˆªè³‡è¨Š -->
      <div id="navigationPanel" class="navigation-info" style="display: none;">
        <div class="direction-arrow" id="directionArrow">â†‘</div>
        <div class="distance-display" id="distanceDisplay">-- å…¬å°º</div>
        <div class="turn-instruction" id="turnInstruction">
          æº–å‚™é–‹å§‹å°èˆª...
        </div>
        <div class="road-info" id="roadInfo">
          é“è·¯è¾¨è­˜ä¸­...
        </div>
        <div class="safety-alert" id="safetyAlert" style="display: none;">
          æ³¨æ„å‰æ–¹å®‰å…¨ï¼
        </div>
      </div>

      <!-- æª¢æ¸¬çµæœ -->
      <div class="card">
        <h3 style="margin:0 0 12px 0;">ç’°å¢ƒæª¢æ¸¬</h3>
        <div id="detectionList" class="detection-list">
          <div class="detection-item" style="text-align:center; color:var(--muted);">
            ç­‰å¾…é–‹å§‹åµæ¸¬â€¦
          </div>
        </div>
      </div>
    </div>

    <!-- ç‰©å“è­˜åˆ¥æ¨¡å¼å…§å®¹ -->
    <div id="recognitionTab" class="tab-content">
      <!-- é€²åº¦æ¢ -->
      <div id="modelProgress" class="card" style="display: none;">
        <div style="text-align: center; margin-bottom: 10px;">
          <div style="font-size: 18px; font-weight: bold;">æ­£åœ¨è¼‰å…¥AIæ¨¡å‹</div>
          <div style="font-size: 12px; color: var(--muted); margin-top: 5px;">å„ªåŒ–ç‰ˆ COCO-SSD â€¢ å¿«é€Ÿè¼‰å…¥</div>
        </div>
        <div class="progress-bar">
          <div id="progressFill" class="progress-fill"></div>
        </div>
        <div id="progressText" style="text-align: center; font-size: 12px; color: var(--muted); margin-top: 5px;">0%</div>
      </div>

      <!-- ç›¸æ©Ÿç•«é¢ -->
      <div class="card">
        <div class="camera-container">
          <div id="recognitionCameraPreview" class="camera-preview">
            <div>
              <div style="font-size:48px; margin-bottom:10px;">ğŸ“·</div>
              <div>é»æ“Šã€Œé–‹å•Ÿç›¸æ©Ÿã€é–‹å§‹ç‰©å“è­˜åˆ¥</div>
              <div style="font-size:12px; margin-top:10px; color:var(--muted);">
                é«˜é€Ÿè¾¨è­˜ â€¢ å³æ™‚æª¢æ¸¬æ¡†
              </div>
            </div>
          </div>
          <video id="recognitionVideo" autoplay playsinline muted></video>
          <!-- ç‰©å“è­˜åˆ¥æª¢æ¸¬æ¡†ç•«å¸ƒ -->
          <canvas id="recognitionCanvas" class="detection-canvas"></canvas>
        </div>
        <div class="camera-controls">
          <button class="camera-switch" onclick="switchRecognitionCamera()">
            <span>ğŸ”„</span>
            <span>åˆ‡æ›é¡é ­</span>
          </button>
        </div>
      </div>

      <!-- ä¸»è¦æ§åˆ¶æŒ‰éˆ• -->
      <div class="card">
        <div class="controls">
          <button class="btn-primary" onclick="startItemRecognition()" id="btnRecognition" disabled>
            <span>ğŸ”</span>
            <span>æ™ºèƒ½è­˜åˆ¥</span>
          </button>
          <button class="btn-accent" onclick="toggleContinuousMode()" id="continuousBtn">
            <span>ğŸ”„</span>
            <span>é€£çºŒè­˜åˆ¥</span>
          </button>
          <button class="btn-secondary" onclick="setHomeLocation()">
            <span>ğŸ </span>
            <span>è¨­å®šå®¶çš„ä½ç½®</span>
          </button>
          <button class="btn-danger" onclick="startNavigationHome()">
            <span>ğŸ§­</span>
            <span>å°èˆªå›å®¶</span>
          </button>
        </div>
      </div>

      <!-- æœå°‹å’Œåˆ†é¡ -->
      <div class="card search-box">
        <input type="text" class="search-input" placeholder="ğŸ” æœå°‹ç‰©å“åç¨±..." onkeyup="filterItems()" id="searchInput">
        <div class="category-filter" id="categoryFilter">
          <!-- åˆ†é¡æŒ‰éˆ•æœƒç”±JavaScriptå‹•æ…‹ç”Ÿæˆ -->
        </div>
      </div>

      <!-- ç‹€æ…‹é¢æ¿ -->
      <div class="card">
        <div class="status-grid">
          <div class="status-item">
            <div class="status-label">ç•¶å‰æ¨¡å¼</div>
            <div class="status-value"><span class="mode-indicator" id="modeIndicator"></span><span id="currentMode">å¾…æ©Ÿä¸­</span></div>
          </div>
          <div class="status-item">
            <div class="status-label">è­˜åˆ¥ç‰©å“æ•¸</div>
            <div class="status-value" id="itemCount">0</div>
          </div>
          <div class="status-item">
            <div class="status-label">å®¶çš„ä½ç½®</div>
            <div class="status-value" id="homeStatus">æœªè¨­å®š</div>
          </div>
          <div class="status-item">
            <div class="status-label">è¾¨è­˜é€Ÿåº¦</div>
            <div class="status-value" id="detectionSpeed">-- ms</div>
          </div>
        </div>
      </div>

      <!-- ç‰©å“è­˜åˆ¥çµæœ -->
      <div class="card">
        <h3 style="margin:0 0 12px 0;">ç‰©å“è­˜åˆ¥çµæœ <span class="performance-badge">é«˜é€Ÿæ¨¡å¼</span></h3>
        <div id="itemsContainer" class="items-grid">
          <div class="item-card" style="background: rgba(255,255,255,0.1); color: var(--muted);">
            <div class="item-name">ç­‰å¾…AIæ¨¡å‹è¼‰å…¥...</div>
            <div class="item-confidence">å„ªåŒ–ç‰ˆ COCO-SSD æ¨¡å‹</div>
          </div>
        </div>
      </div>

      <!-- è¼”åŠ©æ§åˆ¶ -->
      <div class="card">
        <div class="controls">
          <button class="btn-secondary" onclick="repeatInstruction()">
            <span>ğŸ”Š</span>
            <span>é‡è¤‡æç¤º</span>
          </button>
          <button class="btn-secondary" onclick="toggleVoice()" id="voiceToggleBtn">
            <span>ğŸ”‡</span>
            <span>é—œé–‰èªéŸ³</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/@tensorflow/tfjs@4.10.0/dist/tf.min.js"></script>
  <script src="https://unpkg.com/@tensorflow-models/coco-ssd@2.1.0/dist/coco-ssd.min.js"></script>
  <script src="itemDatabase.js"></script>
  <script>
    // å°èˆªç³»çµ±ç‹€æ…‹è®Šæ•¸
    let isDetecting = false;
    let currentStream = null;
    let detectionInterval = null;
    let lastDetectionTime = 0;

    // ç‰©å“è­˜åˆ¥ç³»çµ±ç‹€æ…‹è®Šæ•¸
    let recognitionStream = null;
    let recognitionCameraFacingMode = 'environment';
    let modelLoaded = false;

    // æ€§èƒ½å„ªåŒ–è®Šæ•¸
    let lastDetectionTimestamp = 0;
    const DETECTION_COOLDOWN = 500; // æª¢æ¸¬å†·å»æ™‚é–“(æ¯«ç§’)

    // æ™ºèƒ½åŠ©æ‰‹é¡ - å„ªåŒ–ç‰ˆæœ¬
    class SmartAssistant {
      constructor() {
        this.model = null;
        this.isRecognizing = false;
        this.continuousMode = false;
        this.voiceEnabled = true;
        this.homeLocation = null;
        this.isNavigating = false;
        this.watchId = null;
        this.lastItems = [];
        this.lastSpeechTime = 0;
        this.SPEECH_COOLDOWN = 3000; // ç¸®çŸ­èªéŸ³å†·å»æ™‚é–“
        this.currentCategory = 'å…¨éƒ¨';
        this.continuousInterval = null;
        
        // å°èˆªç›¸é—œå±¬æ€§
        this.currentLocation = null;
        this.lastLocation = null;
        this.heading = null;
        this.agpsEnabled = false;
        this.locationHistory = [];
        this.arrivalThreshold = 20;

        // æ€§èƒ½å„ªåŒ–å±¬æ€§
        this.detectionCount = 0;
        this.averageDetectionTime = 0;
        this.lastPerformanceLog = 0;
      }

      // åˆå§‹åŒ–AIæ¨¡å‹ - å„ªåŒ–ç‰ˆæœ¬
      async initModel() {
        try {
          updateVoice('æ­£åœ¨è¼‰å…¥å„ªåŒ–ç‰ˆAIæ¨¡å‹...');
          showModelProgress('åˆå§‹åŒ– TensorFlow å¼•æ“...', 20);
          
          if (typeof tf === 'undefined') {
            throw new Error('TensorFlow.js è¼‰å…¥å¤±æ•—');
          }
          
          // è¨­ç½® TensorFlow å¾Œç«¯ç‚º WebGL ä»¥ç²å¾—æœ€ä½³æ€§èƒ½
          await tf.setBackend('webgl');
          showModelProgress('WebGL å¾Œç«¯å·²å•Ÿç”¨', 40);
          
          if (typeof cocoSsd === 'undefined') {
            throw new Error('COCO-SSD æ¨¡å‹è¼‰å…¥å¤±æ•—');
          }

          showModelProgress('è¼‰å…¥ COCO-SSD æ¨¡å‹...', 60);
          
          // ä½¿ç”¨è¼•é‡ç´šæ¨¡å‹ä»¥ç²å¾—æ›´å¥½æ€§èƒ½
          this.model = await cocoSsd.load({
            base: 'lite_mobilenet_v2' // ä½¿ç”¨æ›´è¼•é‡çš„åŸºç¤ç¶²çµ¡
          });
          
          showModelProgress('æ¨¡å‹å„ªåŒ–ä¸­...', 80);
          
          // é ç†±æ¨¡å‹
          await this.warmUpModel();
          
          showModelProgress('æ¨¡å‹è¼‰å…¥å®Œæˆï¼', 100);
          modelLoaded = true;
          
          setTimeout(() => {
            hideModelProgress();
            const itemCount = Object.keys(itemNames).length;
            updateVoice(`ç³»çµ±æº–å‚™å®Œæˆï¼å„ªåŒ–ç‰ˆ COCO-SSD æ¨¡å‹ï¼Œå¯è­˜åˆ¥ ${itemCount} ç¨®ç‰©å“`);
            this.updateModeIndicator('idle');
            this.initCategoryFilter();
            
            document.getElementById('btnRecognition').disabled = false;
            document.getElementById('continuousBtn').disabled = false;
            
            document.getElementById('itemsContainer').innerHTML = `
              <div class="item-card" style="background: rgba(255,255,255,0.1); color: var(--muted); grid-column: 1/-1;">
                <div class="item-name">AIæ¨¡å‹è¼‰å…¥å®Œæˆ</div>
                <div class="item-confidence">å„ªåŒ–ç‰ˆ COCO-SSD | é»æ“Šã€Œæ™ºèƒ½è­˜åˆ¥ã€é–‹å§‹ç‰©å“è­˜åˆ¥</div>
              </div>
            `;
          }, 800);
          
        } catch (error) {
          console.error('æ¨¡å‹è¼‰å…¥å¤±æ•—:', error);
          modelLoaded = false;
          hideModelProgress();
          showError('AIæ¨¡å‹è¼‰å…¥å¤±æ•—ï¼š' + error.message);
          updateVoice('AIæ¨¡å‹è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£æ¥');
        }
      }

      // æ¨¡å‹é ç†± - æé«˜é¦–æ¬¡è­˜åˆ¥é€Ÿåº¦
      async warmUpModel() {
        const warmUpCanvas = document.createElement('canvas');
        warmUpCanvas.width = 300;
        warmUpCanvas.height = 300;
        const ctx = warmUpCanvas.getContext('2d');
        ctx.fillStyle = '#000000';
        ctx.fillRect(0, 0, 300, 300);
        
        try {
          // å¿«é€ŸåŸ·è¡Œä¸€æ¬¡æª¢æ¸¬ä¾†é ç†±æ¨¡å‹
          await this.model.detect(warmUpCanvas);
          console.log('æ¨¡å‹é ç†±å®Œæˆ');
        } catch (error) {
          console.log('æ¨¡å‹é ç†±è·³é:', error);
        }
      }

      // ç¹ªè£½æª¢æ¸¬æ¡† - å„ªåŒ–ç‰ˆæœ¬
      drawDetectionBoxes(predictions, canvasId, videoElement) {
        const canvas = document.getElementById(canvasId);
        const ctx = canvas.getContext('2d');
        
        if (!canvas || !videoElement) return;
        
        // è¨­ç½® canvas å°ºå¯¸èˆ‡å½±ç‰‡ä¸€è‡´
        if (canvas.width !== videoElement.videoWidth || canvas.height !== videoElement.videoHeight) {
          canvas.width = videoElement.videoWidth;
          canvas.height = videoElement.videoHeight;
        }
        
        // æ¸…é™¤ä¹‹å‰çš„ç¹ªè£½
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // åªç¹ªè£½é«˜ç½®ä¿¡åº¦çš„æª¢æ¸¬æ¡†
        const highConfidencePredictions = predictions.filter(pred => pred.score > 0.4);
        
        highConfidencePredictions.forEach(pred => {
          const [x, y, width, height] = pred.bbox;
          const className = pred.class;
          const confidence = pred.score;
          
          // ç¹ªè£½é‚Šæ¡†
          ctx.strokeStyle = '#00ff00';
          ctx.lineWidth = 2;
          ctx.strokeRect(x, y, width, height);
          
          // ç¹ªè£½æ¨™ç±¤èƒŒæ™¯
          ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
          const label = `${this.getItemName(className)} ${Math.round(confidence * 100)}%`;
          const textMetrics = ctx.measureText(label);
          const textWidth = textMetrics.width;
          ctx.fillRect(x, y - 20, textWidth + 10, 20);
          
          // ç¹ªè£½æ–‡å­—
          ctx.fillStyle = '#ffffff';
          ctx.font = '12px Arial';
          ctx.fillText(label, x + 5, y - 5);
        });
      }

      // ç²å–ç‰©å“ä¸­æ–‡åç¨±
      getItemName(className) {
        return itemNames[className] || className;
      }

      // é–‹å§‹ç‰©å“è­˜åˆ¥ - å„ªåŒ–ç‰ˆæœ¬
      async startItemRecognition() {
        if (!modelLoaded) {
          showError('AIæ¨¡å‹å°šæœªè¼‰å…¥å®Œæˆ');
          return;
        }

        // é˜²æ­¢éå¿«é€£çºŒé»æ“Š
        const now = Date.now();
        if (now - lastDetectionTimestamp < 300) {
          return;
        }
        lastDetectionTimestamp = now;

        const video = await this.setupRecognitionCamera();
        if (!video) return;

        this.isRecognizing = true;
        this.updateModeIndicator('identifying');
        updateVoice('é–‹å§‹è­˜åˆ¥ç‰©å“');

        const startTime = performance.now();
        
        try {
          const predictions = await this.model.detect(video);
          const endTime = performance.now();
          const detectionTime = endTime - startTime;
          
          // æ›´æ–°æ€§èƒ½é¡¯ç¤º
          this.updatePerformanceStats(detectionTime);
          
          // ç¹ªè£½æª¢æ¸¬æ¡†
          this.drawDetectionBoxes(predictions, 'recognitionCanvas', video);
          this.processRecognitionResults(predictions);
          
        } catch (error) {
          console.error('è­˜åˆ¥å¤±æ•—:', error);
          updateVoice('è­˜åˆ¥å¤±æ•—ï¼Œè«‹é‡è©¦');
        }

        this.isRecognizing = false;
        this.updateModeIndicator('idle');
      }

      // æ›´æ–°æ€§èƒ½çµ±è¨ˆ
      updatePerformanceStats(detectionTime) {
        this.detectionCount++;
        this.averageDetectionTime = (this.averageDetectionTime * (this.detectionCount - 1) + detectionTime) / this.detectionCount;
        
        document.getElementById('detectionSpeed').textContent = Math.round(detectionTime) + ' ms';
        
        // æ¯10æ¬¡æª¢æ¸¬è¨˜éŒ„ä¸€æ¬¡æ€§èƒ½
        if (this.detectionCount % 10 === 0) {
          console.log(`å¹³å‡æª¢æ¸¬æ™‚é–“: ${Math.round(this.averageDetectionTime)}ms`);
        }
      }

      // é€£çºŒè­˜åˆ¥å¾ªç’° - å„ªåŒ–ç‰ˆæœ¬
      async continuousRecognition(video) {
        if (!this.continuousMode) return;

        const startTime = performance.now();
        
        try {
          const predictions = await this.model.detect(video);
          const endTime = performance.now();
          const detectionTime = endTime - startTime;
          
          // æ›´æ–°æ€§èƒ½é¡¯ç¤º
          this.updatePerformanceStats(detectionTime);
          
          // ç¹ªè£½æª¢æ¸¬æ¡†
          this.drawDetectionBoxes(predictions, 'recognitionCanvas', video);
          this.processRecognitionResults(predictions);
          
          // å‹•æ…‹èª¿æ•´æª¢æ¸¬é–“éš”
          const interval = Math.max(800, Math.min(2000, detectionTime * 3));
          this.continuousInterval = setTimeout(() => this.continuousRecognition(video), interval);
          
        } catch (error) {
          console.error('é€£çºŒè­˜åˆ¥éŒ¯èª¤:', error);
          this.continuousInterval = setTimeout(() => this.continuousRecognition(video), 1000);
        }
      }

      // è™•ç†è­˜åˆ¥çµæœ - å„ªåŒ–ç‰ˆæœ¬
      processRecognitionResults(predictions) {
        // æé«˜ç½®ä¿¡åº¦é–¾å€¼ä»¥æ¸›å°‘èª¤æª¢ï¼Œä½†ä¿æŒæ›´å¤šçµæœ
        const highConfidenceItems = predictions
          .filter(pred => pred.score > 0.35) // é™ä½é–¾å€¼ä»¥ç²å¾—æ›´å¤šçµæœ
          .map(pred => ({
            class: pred.class,
            name: this.getItemName(pred.class),
            confidence: pred.score,
            category: itemCategories[pred.class] || 'å…¶ä»–'
          }))
          .filter((item, index, array) => 
            // å»é‡ï¼Œä½†ä¿ç•™æœ€é«˜ç½®ä¿¡åº¦çš„é …ç›®
            array.findIndex(i => i.class === item.class) === index
          )
          .sort((a, b) => b.confidence - a.confidence)
          .slice(0, 12); // é¡¯ç¤ºæ›´å¤šçµæœ

        this.lastItems = highConfidenceItems;
        this.filterDisplayedItems();
        this.provideItemVoiceGuidance(highConfidenceItems);
      }

      // åˆå§‹åŒ–åˆ†é¡ç¯©é¸å™¨
      initCategoryFilter() {
        const container = document.getElementById('categoryFilter');
        const categories = ['å…¨éƒ¨', ...Object.keys(itemDatabase)];
        
        container.innerHTML = categories.map(category => 
          `<button class="category-btn ${category === 'å…¨éƒ¨' ? 'active' : ''}" 
                  onclick="assistant.setCategory('${category}')">${category}</button>`
        ).join('');
      }

      // è¨­å®šåˆ†é¡
      setCategory(category) {
        this.currentCategory = category;
        
        document.querySelectorAll('.category-btn').forEach(btn => {
          btn.classList.remove('active');
        });
        event.target.classList.add('active');
        
        this.filterDisplayedItems();
      }

      // ç¯©é¸é¡¯ç¤ºçš„ç‰©å“
      filterDisplayedItems() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const filteredItems = this.lastItems.filter(item => {
          const matchesCategory = this.currentCategory === 'å…¨éƒ¨' || 
                                item.category === this.currentCategory;
          const matchesSearch = item.name.toLowerCase().includes(searchTerm) ||
                              item.class.toLowerCase().includes(searchTerm);
          return matchesCategory && matchesSearch;
        });
        
        this.updateItemsDisplay(filteredItems);
      }

      // æ›´æ–°ç‰©å“é¡¯ç¤º
      updateItemsDisplay(items) {
        const container = document.getElementById('itemsContainer');
        document.getElementById('itemCount').textContent = items.length;

        if (items.length === 0) {
          container.innerHTML = `
            <div class="item-card" style="background: rgba(255,255,255,0.1); color: var(--muted); grid-column: 1/-1;">
              <div class="item-name">æœªè­˜åˆ¥åˆ°ç‰©å“</div>
              <div class="item-confidence">è«‹èª¿æ•´é¡é ­æ–¹å‘æˆ–è·é›¢</div>
            </div>
          `;
          return;
        }

        container.innerHTML = items.map((item, index) => `
          <div class="item-card highlight" style="animation-delay: ${index * 0.05}s">
            <div class="item-name">${item.name}</div>
            <div class="item-confidence">å¯ä¿¡åº¦: ${Math.round(item.confidence * 100)}%</div>
            <div class="category-tag">${item.category}</div>
          </div>
        `).join('');
      }

      // æä¾›ç‰©å“èªéŸ³æç¤º - å„ªåŒ–ç‰ˆæœ¬
      provideItemVoiceGuidance(items) {
        const now = Date.now();
        if (now - this.lastSpeechTime < this.SPEECH_COOLDOWN || items.length === 0) return;

        // åªæ’­å ±æœ€é«˜ç½®ä¿¡åº¦çš„å‰2å€‹ç‰©å“
        const topItems = items.slice(0, 2);
        const itemNames = topItems.map(item => item.name).join('ã€');
        
        if (this.continuousMode) {
          // é€£çºŒæ¨¡å¼ä¸‹æ¸›å°‘èªéŸ³é »ç‡
          if (Math.random() < 0.4) {
            updateVoice(`çœ‹åˆ°ï¼š${itemNames}`);
            this.lastSpeechTime = now;
          }
        } else {
          updateVoice(`çœ‹åˆ°ï¼š${itemNames}`);
          this.lastSpeechTime = now;
        }
      }

      // é–‹å§‹çœŸå¯¦å°èˆªå›å®¶
      startNavigationHome() {
        if (!this.homeLocation) {
          updateVoice('è«‹å…ˆè¨­å®šå®¶çš„ä½ç½®');
          showError('è«‹å…ˆé»æ“Šã€Œè¨­å®šå®¶çš„ä½ç½®ã€è¨­å®šå›å®¶ç›®çš„åœ°');
          return;
        }

        this.isNavigating = true;
        this.updateModeIndicator('navigating');
        updateVoice('é–‹å§‹å°èˆªå›å®¶ï¼Œæ­£åœ¨è¨ˆç®—è·¯ç·š...');
        
        // é¡¯ç¤ºå°èˆªé¢æ¿å’ŒçµæŸæŒ‰éˆ•
        document.getElementById('navigationPanel').style.display = 'block';
        document.getElementById('btnStopNavigation').style.display = 'flex';
        document.getElementById('navigationStatus').textContent = 'å°èˆªä¸­';

        // é–‹å§‹çœŸå¯¦ä½ç½®è¿½è¹¤
        this.startRealTimeTracking();
      }

      // åœæ­¢å°èˆª
      stopNavigation() {
        this.isNavigating = false;
        this.updateModeIndicator('idle');
        
        // åœæ­¢ä½ç½®è¿½è¹¤
        if (this.watchId) {
          navigator.geolocation.clearWatch(this.watchId);
          this.watchId = null;
        }
        
        updateVoice('å°èˆªå·²çµæŸ');
        document.getElementById('navigationStatus').textContent = 'å·²çµæŸ';
        
        // éš±è—å°èˆªé¢æ¿å’ŒçµæŸæŒ‰éˆ•
        document.getElementById('btnStopNavigation').style.display = 'none';
        document.getElementById('navigationPanel').style.display = 'none';
      }

      // é–‹å§‹å¯¦æ™‚ä½ç½®è¿½è¹¤
      startRealTimeTracking() {
        if (!navigator.geolocation) {
          updateVoice('æ‚¨çš„è£ç½®ä¸æ”¯æ´GPSå®šä½');
          return;
        }

        this.watchId = navigator.geolocation.watchPosition(
          (position) => this.updateRealTimeNavigation(position),
          (error) => this.handleNavigationError(error),
          {
            enableHighAccuracy: true,
            timeout: 5000,
            maximumAge: 3000
          }
        );
      }

      // å¯¦æ™‚å°èˆªæ›´æ–°
      updateRealTimeNavigation(position) {
        this.lastLocation = this.currentLocation;
        
        this.currentLocation = {
          latitude: position.coords.latitude,
          longitude: position.coords.longitude,
          accuracy: position.coords.accuracy,
          altitude: position.coords.altitude,
          heading: position.coords.heading,
          speed: position.coords.speed,
          timestamp: position.timestamp
        };

        // è¨ˆç®—å°èˆªè³‡è¨Š
        const distance = this.calculateDistance(this.currentLocation, this.homeLocation);
        const bearing = this.calculateBearing(this.currentLocation, this.homeLocation);
        
        // æ›´æ–°é¡¯ç¤º
        this.updateRealNavigationDisplay(distance, bearing);
        
        // æä¾›èªéŸ³æŒ‡å¼•
        this.provideRealTimeGuidance(distance, bearing);
      }

      // è¨ˆç®—å…©é»é–“è·é›¢ (å…¬å°º)
      calculateDistance(point1, point2) {
        const R = 6371000;
        const lat1 = point1.latitude * Math.PI / 180;
        const lat2 = point2.latitude * Math.PI / 180;
        const deltaLat = (point2.latitude - point1.latitude) * Math.PI / 180;
        const deltaLon = (point2.longitude - point1.longitude) * Math.PI / 180;

        const a = Math.sin(deltaLat/2) * Math.sin(deltaLat/2) +
                  Math.cos(lat1) * Math.cos(lat2) *
                  Math.sin(deltaLon/2) * Math.sin(deltaLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        
        return R * c;
      }

      // è¨ˆç®—æ–¹ä½è§’
      calculateBearing(point1, point2) {
        const lat1 = point1.latitude * Math.PI / 180;
        const lat2 = point2.latitude * Math.PI / 180;
        const deltaLon = (point2.longitude - point1.longitude) * Math.PI / 180;

        const y = Math.sin(deltaLon) * Math.cos(lat2);
        const x = Math.cos(lat1) * Math.sin(lat2) -
                  Math.sin(lat1) * Math.cos(lat2) * Math.cos(deltaLon);
        
        return (Math.atan2(y, x) * 180 / Math.PI + 360) % 360;
      }

      // æ›´æ–°å¯¦æ™‚å°èˆªé¡¯ç¤º
      updateRealNavigationDisplay(distance, bearing) {
        const displayDistance = distance < 1000 ? 
          Math.round(distance) + ' å…¬å°º' : 
          (distance / 1000).toFixed(1) + ' å…¬é‡Œ';
        
        document.getElementById('distanceDisplay').textContent = displayDistance;
        
        const directionInfo = this.getDirectionFromBearing(bearing);
        document.getElementById('directionArrow').textContent = directionInfo.arrow;
        document.getElementById('turnInstruction').textContent = directionInfo.instruction;
        
        this.updateRoadInfo();
        
        document.getElementById('navigationStatus').textContent = 
          `å°èˆªä¸­ | ç²¾åº¦: ${this.currentLocation ? Math.round(this.currentLocation.accuracy) : '--'}m`;
        
        if (distance <= this.arrivalThreshold) {
          this.arriveAtDestination();
        }
      }

      // æ ¹æ“šæ–¹ä½è§’ç²å–æ–¹å‘è³‡è¨Š
      getDirectionFromBearing(bearing) {
        if (bearing >= 337.5 || bearing < 22.5) 
          return { arrow: 'â†‘', instruction: 'è«‹å‘åŒ—ç›´è¡Œ' };
        if (bearing >= 22.5 && bearing < 67.5) 
          return { arrow: 'â†—', instruction: 'è«‹å‘æ±åŒ—æ–¹å‘å‰é€²' };
        if (bearing >= 67.5 && bearing < 112.5) 
          return { arrow: 'â†’', instruction: 'è«‹å‘æ±ç›´è¡Œ' };
        if (bearing >= 112.5 && bearing < 157.5) 
          return { arrow: 'â†˜', instruction: 'è«‹å‘æ±å—æ–¹å‘å‰é€²' };
        if (bearing >= 157.5 && bearing < 202.5) 
          return { arrow: 'â†“', instruction: 'è«‹å‘å—ç›´è¡Œ' };
        if (bearing >= 202.5 && bearing < 247.5) 
          return { arrow: 'â†™', instruction: 'è«‹å‘è¥¿å—æ–¹å‘å‰é€²' };
        if (bearing >= 247.5 && bearing < 292.5) 
          return { arrow: 'â†', instruction: 'è«‹å‘è¥¿ç›´è¡Œ' };
        return { arrow: 'â†–', instruction: 'è«‹å‘è¥¿åŒ—æ–¹å‘å‰é€²' };
      }

      // æ›´æ–°é“è·¯è³‡è¨Š
      updateRoadInfo() {
        const accuracy = this.currentLocation ? this.currentLocation.accuracy : null;
        
        if (accuracy && accuracy > 50) {
          document.getElementById('roadInfo').textContent = 
            `å®šä½ç²¾åº¦è¼ƒä½ï¼š${Math.round(accuracy)}å…¬å°ºï¼Œå»ºè­°åœ¨é–‹é—Šåœ°ä½¿ç”¨`;
          document.getElementById('roadInfo').style.background = 'rgba(245,158,11,0.15)';
          document.getElementById('roadInfo').style.borderColor = 'rgba(245,158,11,0.35)';
        } else {
          document.getElementById('roadInfo').textContent = 
            `å®šä½æ­£å¸¸ï¼Œç²¾åº¦ï¼š${accuracy ? Math.round(accuracy) : '--'}å…¬å°º`;
          document.getElementById('roadInfo').style.background = 'rgba(34,197,94,0.15)';
          document.getElementById('roadInfo').style.borderColor = 'rgba(34,197,94,0.35)';
        }
      }

      // å¯¦æ™‚èªéŸ³æŒ‡å¼•
      provideRealTimeGuidance(distance, bearing) {
        const now = Date.now();
        if (now - this.lastSpeechTime < this.SPEECH_COOLDOWN) return;
        
        let guidance = '';
        
        if (distance <= this.arrivalThreshold) {
          guidance = 'å·²åˆ°é”ç›®çš„åœ°é™„è¿‘';
        } else if (distance < 50) {
          guidance = `å³å°‡åˆ°é”ï¼Œé‚„æœ‰${Math.round(distance)}å…¬å°º`;
        } else if (distance < 200) {
          const direction = this.getDirectionFromBearing(bearing);
          guidance = `${direction.instruction}ï¼Œè·é›¢${Math.round(distance)}å…¬å°º`;
        } else {
          if (now - this.lastSpeechTime > 25000) {
            guidance = `è·é›¢ç›®çš„åœ°é‚„æœ‰${Math.round(distance)}å…¬å°º`;
          }
        }
        
        if (guidance) {
          updateVoice(guidance);
          this.lastSpeechTime = now;
        }
      }

      // åˆ°é”ç›®çš„åœ°
      arriveAtDestination() {
        updateVoice('å·²åˆ°é”ç›®çš„åœ°ï¼å°èˆªçµæŸ');
        document.getElementById('turnInstruction').textContent = 'å·²åˆ°é”ç›®çš„åœ°';
        document.getElementById('directionArrow').textContent = 'ğŸ ';
        document.getElementById('distanceDisplay').textContent = '0 å…¬å°º';
        document.getElementById('roadInfo').textContent = 'å°èˆªå®Œæˆï¼Œå·²åˆ°é”ç›®çš„åœ°';
        
        setTimeout(() => {
          this.stopNavigation();
        }, 5000);
      }

      // è™•ç†å°èˆªéŒ¯èª¤
      handleNavigationError(error) {
        const errorMsg = this.getGeolocationError(error);
        updateVoice('å°èˆªéŒ¯èª¤ï¼š' + errorMsg);
        
        if (error.code === error.PERMISSION_DENIED) {
          this.stopNavigation();
        }
      }

      // è¨­å®šå®¶çš„ä½ç½®
      async setHomeLocation() {
        return new Promise((resolve, reject) => {
          if (!navigator.geolocation) {
            reject('æ‚¨çš„è£ç½®ä¸æ”¯æ´å®šä½åŠŸèƒ½');
            return;
          }

          updateVoice('æ­£åœ¨è¨˜éŒ„å®¶çš„ä½ç½®...');
          
          navigator.geolocation.getCurrentPosition(
            (position) => {
              this.homeLocation = {
                latitude: position.coords.latitude,
                longitude: position.coords.longitude,
                accuracy: position.coords.accuracy,
                address: 'å®¶çš„ä½ç½®'
              };
              
              localStorage.setItem('homeLocation', JSON.stringify(this.homeLocation));
              updateVoice('å®¶çš„ä½ç½®å·²æˆåŠŸè¨˜éŒ„ï¼ç²¾åº¦ï¼š' + Math.round(position.coords.accuracy) + 'å…¬å°º');
              document.getElementById('homeStatus').textContent = 'å·²è¨­å®š';
              resolve(this.homeLocation);
            },
            (error) => {
              const errorMsg = this.getGeolocationError(error);
              reject(errorMsg);
            },
            {
              enableHighAccuracy: true,
              timeout: 15000,
              maximumAge: 0
            }
          );
        });
      }

      // é–‹å•ŸGoogle Mapså°èˆª
      openGoogleMapsNavigation() {
        if (!this.homeLocation) {
          showError('è«‹å…ˆè¨­å®šå®¶çš„ä½ç½®');
          return;
        }

        const { latitude, longitude } = this.homeLocation;
        const mapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${latitude},${longitude}&travelmode=walking`;
        
        updateVoice('æ­£åœ¨é–‹å•ŸGoogleåœ°åœ–å°èˆª');
        window.open(mapsUrl, '_blank');
      }

      // è¨­ç½®ç‰©å“è­˜åˆ¥ç›¸æ©Ÿ
      async setupRecognitionCamera() {
        const video = document.getElementById('recognitionVideo');
        try {
          if (recognitionStream) {
            recognitionStream.getTracks().forEach(track => track.stop());
          }
          
          const stream = await navigator.mediaDevices.getUserMedia({
            video: { 
              facingMode: recognitionCameraFacingMode,
              width: { ideal: 640 },
              height: { ideal: 480 }
            }
          });
          
          recognitionStream = stream;
          video.srcObject = stream;
          document.getElementById('recognitionCameraPreview').style.display = 'none';
          
          return new Promise((resolve) => {
            video.onloadedmetadata = () => { 
              video.play();
              resolve(video); 
            };
          });
        } catch (error) {
          updateVoice('ç„¡æ³•é–‹å•Ÿç›¸æ©Ÿ');
          showError('ç„¡æ³•é–‹å•Ÿç›¸æ©Ÿï¼Œè«‹æª¢æŸ¥æ¬Šé™è¨­å®š');
          return null;
        }
      }

      // åˆ‡æ›é€£çºŒè­˜åˆ¥æ¨¡å¼
      async toggleContinuousMode() {
        if (this.continuousMode) {
          this.stopContinuousMode();
        } else {
          await this.startContinuousMode();
        }
      }

      // é–‹å§‹é€£çºŒè­˜åˆ¥
      async startContinuousMode() {
        if (!modelLoaded) {
          showError('AIæ¨¡å‹å°šæœªè¼‰å…¥å®Œæˆ');
          return;
        }

        const video = await this.setupRecognitionCamera();
        if (!video) return;

        this.continuousMode = true;
        this.isRecognizing = true;
        this.updateModeIndicator('identifying');
        updateVoice('é–‹å•Ÿé€£çºŒè­˜åˆ¥æ¨¡å¼');
        
        document.getElementById('continuousBtn').innerHTML = 
          '<span>â¹ï¸</span><span>åœæ­¢è­˜åˆ¥</span>';

        this.continuousRecognition(video);
      }

      // åœæ­¢é€£çºŒè­˜åˆ¥
      stopContinuousMode() {
        this.continuousMode = false;
        this.isRecognizing = false;
        this.updateModeIndicator('idle');
        updateVoice('å·²åœæ­¢é€£çºŒè­˜åˆ¥');
        
        document.getElementById('continuousBtn').innerHTML = 
          '<span>ğŸ”„</span><span>é€£çºŒè­˜åˆ¥</span>';

        if (this.continuousInterval) {
          clearInterval(this.continuousInterval);
          this.continuousInterval = null;
        }

        // æ¸…é™¤æª¢æ¸¬æ¡†
        const canvas = document.getElementById('recognitionCanvas');
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
      }

      // æ›´æ–°æ¨¡å¼æŒ‡ç¤ºå™¨
      updateModeIndicator(mode) {
        const indicator = document.getElementById('modeIndicator');
        const modeText = document.getElementById('currentMode');
        
        const modes = {
          'idle': { class: 'mode-idle', text: 'å¾…æ©Ÿä¸­' },
          'identifying': { class: 'mode-identifying', text: 'è­˜åˆ¥ç‰©å“ä¸­' },
          'navigating': { class: 'mode-navigating', text: 'å°èˆªä¸­' }
        };

        indicator.className = 'mode-indicator ' + modes[mode].class;
        modeText.textContent = modes[mode].text;
      }

      // è¼‰å…¥å„²å­˜çš„ä½ç½®
      loadSavedLocations() {
        const savedHome = localStorage.getItem('homeLocation');
        if (savedHome) {
          this.homeLocation = JSON.parse(savedHome);
          document.getElementById('homeStatus').textContent = 'å·²è¨­å®š';
        }
      }

      // ç²å–åœ°ç†å®šä½éŒ¯èª¤
      getGeolocationError(error) {
        switch(error.code) {
          case error.PERMISSION_DENIED: return 'è«‹å…è¨±ä½ç½®æ¬Šé™';
          case error.POSITION_UNAVAILABLE: return 'ç„¡æ³•ç²å–ä½ç½®è³‡è¨Š';
          case error.TIMEOUT: return 'å®šä½è¶…æ™‚';
          default: return 'å®šä½æœå‹™éŒ¯èª¤';
        }
      }
    }

    // å…¨åŸŸè®Šæ•¸
    const assistant = new SmartAssistant();
    let voiceEnabled = true;

    // åˆå§‹åŒ–
    function init() {
      assistant.loadSavedLocations();
      
      updateStatus('æº–å‚™å°±ç·’');
      updateVoice('ç³»çµ±åˆå§‹åŒ–å®Œæˆ');
      initEventListeners();
      initTabSystem();
      
      // ç«‹å³é–‹å§‹è¼‰å…¥æ¨¡å‹
      assistant.initModel();
    }

    // åˆå§‹åŒ–æ¨™ç±¤ç³»çµ±
    function initTabSystem() {
      const tabs = document.querySelectorAll('.tab');
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          const tabId = tab.getAttribute('data-tab');
          
          tabs.forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          
          document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
          });
          document.getElementById(tabId + 'Tab').classList.add('active');
          
          if (tabId === 'navigation') {
            updateVoice('åˆ‡æ›åˆ°å°èˆªæ¨¡å¼');
          } else {
            updateVoice('åˆ‡æ›åˆ°ç‰©å“è­˜åˆ¥æ¨¡å¼');
          }
        });
      });
    }

    // å°èˆªç³»çµ±å‡½æ•¸
    function initEventListeners() {
      document.getElementById('btnCamera').addEventListener('click', setupCamera);
      document.getElementById('btnStart').addEventListener('click', startDetection);
      document.getElementById('btnTest').addEventListener('click', testDetection);
      document.getElementById('btnStop').addEventListener('click', stopDetection);
    }

    // ç›¸æ©Ÿè¨­ç½®
    async function setupCamera() {
      try {
        updateVoice('æ­£åœ¨é–‹å•Ÿç›¸æ©Ÿâ€¦');
        updateCameraStatus('é–‹å•Ÿä¸­');
        
        if (currentStream) {
          currentStream.getTracks().forEach(track => track.stop());
        }
        
        const video = document.getElementById('video');
        const preview = document.getElementById('cameraPreview');
        
        const stream = await navigator.mediaDevices.getUserMedia({
          video: {
            width: { ideal: 640 },
            height: { ideal: 480 },
            facingMode: 'environment'
          },
          audio: false
        });
        
        currentStream = stream;
        video.srcObject = stream;
        
        await new Promise((resolve) => {
          video.onloadedmetadata = () => resolve(video);
        });
        
        await video.play();
        
        preview.style.display = 'none';
        
        document.getElementById('btnStart').disabled = false;
        document.getElementById('btnTest').disabled = false;
        document.getElementById('btnStop').disabled = false;
        
        updateCameraStatus('å·²é–‹å•Ÿ');
        updateVoice('ç›¸æ©Ÿé–‹å•ŸæˆåŠŸï¼');
        
      } catch (error) {
        console.error('ç›¸æ©Ÿé–‹å•Ÿå¤±æ•—:', error);
        updateCameraStatus('é–‹å•Ÿå¤±æ•—');
        
        let errorMsg = 'ç„¡æ³•é–‹å•Ÿç›¸æ©Ÿï¼š';
        if (error.name === 'NotAllowedError') {
          errorMsg += 'è«‹å…è¨±ç›¸æ©Ÿæ¬Šé™';
        } else if (error.name === 'NotFoundError') {
          errorMsg += 'æœªæ‰¾åˆ°ç›¸æ©Ÿè¨­å‚™';
        } else {
          errorMsg += error.message;
        }
        
        updateVoice(errorMsg);
        showError(errorMsg);
      }
    }

    // é–‹å§‹æª¢æ¸¬
    function startDetection() {
      updateVoice('å¯¦æ™‚é“è·¯æª¢æ¸¬å·²å•Ÿå‹•');
      updateStatus('å¯¦æ™‚æª¢æ¸¬ä¸­');
    }

    // æ¸¬è©¦æª¢æ¸¬
    function testDetection() {
      updateVoice('åŸ·è¡ŒåŠŸèƒ½æ¸¬è©¦');
      const testObstacles = [
        { type: 'æ¸¬è©¦ç‰†å£', distance: 1.2, confidence: '90' },
        { type: 'æ¸¬è©¦æ¤…å­', distance: 2.5, confidence: '85' }
      ];
      updateDetectionDisplay(testObstacles);
      updateVoice('åŠŸèƒ½æ¸¬è©¦å®Œæˆ');
    }

    // åœæ­¢æª¢æ¸¬
    function stopDetection() {
      isDetecting = false;
      if (detectionInterval) {
        clearInterval(detectionInterval);
        detectionInterval = null;
      }
      updateStatus('å·²åœæ­¢');
      updateVoice('æª¢æ¸¬å·²åœæ­¢');
      clearDetectionDisplay();
    }

    // æ›´æ–°æª¢æ¸¬é¡¯ç¤º
    function updateDetectionDisplay(obstacles) {
      const list = document.getElementById('detectionList');
      list.innerHTML = '<div class="detection-item" style="text-align:center; color:var(--muted);">é“è·¯ç’°å¢ƒå®‰å…¨</div>';
    }

    function clearDetectionDisplay() {
      const list = document.getElementById('detectionList');
      list.innerHTML = '<div class="detection-item" style="text-align:center; color:var(--muted);">æª¢æ¸¬å·²åœæ­¢</div>';
    }

    // å°èˆªç›¸é—œå‡½æ•¸
    function startNavigationHome() {
      assistant.startNavigationHome();
    }

    function stopNavigation() {
      assistant.stopNavigation();
    }

    function openGoogleMaps() {
      assistant.openGoogleMapsNavigation();
    }

    function setHomeLocation() {
      assistant.setHomeLocation().catch(error => {
        updateVoice(error);
        showError(error);
      });
    }

    // åˆ‡æ›ç‰©å“è­˜åˆ¥ç›¸æ©Ÿ
    function switchRecognitionCamera() {
      recognitionCameraFacingMode = recognitionCameraFacingMode === 'environment' ? 'user' : 'environment';
      updateVoice(`åˆ‡æ›åˆ°${recognitionCameraFacingMode === 'environment' ? 'å¾Œç½®' : 'å‰ç½®'}é¡é ­`);
      
      if (recognitionStream) {
        recognitionStream.getTracks().forEach(track => track.stop());
        recognitionStream = null;
      }
      
      document.getElementById('recognitionCameraPreview').style.display = 'flex';
      document.getElementById('recognitionCameraPreview').innerHTML = `
        <div>
          <div style="font-size:48px; margin-bottom:10px;">ğŸ”„</div>
          <div>æ­£åœ¨åˆ‡æ›é¡é ­...</div>
        </div>
      `;
      
      setTimeout(() => {
        assistant.setupRecognitionCamera();
      }, 500);
    }

    // å·¥å…·å‡½æ•¸
    function updateVoice(message) {
      const voiceAlert = document.getElementById('voiceAlert');
      voiceAlert.textContent = message;
      
      voiceAlert.classList.remove('loading');
      
      if (voiceEnabled && window.speechSynthesis) {
        try {
          window.speechSynthesis.cancel();
          const utterance = new SpeechSynthesisUtterance(message);
          utterance.lang = 'zh-TW';
          utterance.rate = 0.9;
          utterance.volume = 1.0;
          window.speechSynthesis.speak(utterance);
        } catch (error) {
          console.log('èªéŸ³åˆæˆéŒ¯èª¤:', error);
        }
      }
    }

    function updateStatus(status) {
      document.getElementById('status').textContent = status;
    }

    function updateCameraStatus(status) {
      document.getElementById('cameraStatus').textContent = status;
    }

    function showError(message) {
      const errorElement = document.getElementById('errorMessage');
      errorElement.textContent = message;
      errorElement.style.display = 'block';
    }

    function showModelProgress(message, percent) {
      const progressElement = document.getElementById('modelProgress');
      const progressFill = document.getElementById('progressFill');
      const progressText = document.getElementById('progressText');
      
      progressElement.style.display = 'block';
      progressFill.style.width = percent + '%';
      progressText.textContent = percent + '% - ' + message;
    }

    function hideModelProgress() {
      const progressElement = document.getElementById('modelProgress');
      progressElement.style.display = 'none';
    }

    // åŒ…è£å‡½æ•¸
    function startItemRecognition() {
      assistant.startItemRecognition();
    }

    function toggleContinuousMode() {
      assistant.toggleContinuousMode();
    }

    function toggleVoice() {
      voiceEnabled = !voiceEnabled;
      const button = document.getElementById('voiceToggleBtn');
      if (voiceEnabled) {
        button.innerHTML = '<span>ğŸ”‡</span><span>é—œé–‰èªéŸ³</span>';
        updateVoice('èªéŸ³æç¤ºå·²é–‹å•Ÿ');
      } else {
        button.innerHTML = '<span>ğŸ”Š</span><span>é–‹å•ŸèªéŸ³</span>';
        window.speechSynthesis.cancel();
      }
    }

    function repeatInstruction() {
      const voiceAlert = document.getElementById('voiceAlert');
      if (voiceAlert.textContent && voiceEnabled) {
        updateVoice(voiceAlert.textContent);
      }
    }

    function filterItems() {
      assistant.filterDisplayedItems();
    }

    // æ¨¡æ“¬è½‰å‘å‡½æ•¸
    function simulateTurn(direction) {
      const directions = {
        'left': { arrow: 'â†°', instruction: 'è«‹å‘å·¦è½‰' },
        'right': { arrow: 'â†±', instruction: 'è«‹å‘å³è½‰' }
      };
      
      const turn = directions[direction];
      if (turn) {
        document.getElementById('directionArrow').textContent = turn.arrow;
        document.getElementById('turnInstruction').textContent = turn.instruction;
        updateVoice(turn.instruction);
      }
    }

    // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>