<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>🧠 智能生活助手 - 1500+物品識別</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.15.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.3/dist/coco-ssd.min.js"></script>
  <style>
    * { 
      margin: 0; 
      padding: 0; 
      box-sizing: border-box; 
    }
    body { 
      font-family: 'Arial Rounded MT Bold', 'Microsoft JhengHei', sans-serif; 
      background: linear-gradient(135deg, #74b9ff, #0984e3);
      min-height: 100vh; 
      padding: 15px; 
      color: #2d3436;
    }
    .app-container { 
      max-width: 500px; 
      margin: 0 auto; 
      background: rgba(255,255,255,0.95);
      border-radius: 25px;
      padding: 20px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
    }
    .header {
      text-align: center;
      margin-bottom: 20px;
      padding: 15px;
      background: linear-gradient(135deg, #00b894, #00a085);
      border-radius: 20px;
      color: white;
    }
    .header h1 {
      font-size: 24px;
      margin-bottom: 5px;
    }
    .header .subtitle {
      font-size: 16px;
      opacity: 0.9;
    }
    .stats-badge {
      background: rgba(255,255,255,0.2);
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 12px;
      margin-top: 5px;
    }
    .main-controls { 
      display: grid; 
      grid-template-columns: 1fr 1fr; 
      gap: 12px; 
      margin-bottom: 20px;
    }
    .big-button {
      padding: 20px 15px;
      border: none;
      border-radius: 20px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 8px;
      min-height: 100px;
    }
    .big-button:active {
      transform: scale(0.95);
    }
    .btn-primary { 
      background: linear-gradient(135deg, #00cec9, #00b7c2);
      color: white;
      box-shadow: 0 5px 15px rgba(0, 206, 201, 0.3);
    }
    .btn-secondary { 
      background: linear-gradient(135deg, #fd79a8, #e84393);
      color: white;
      box-shadow: 0 5px 15px rgba(253, 121, 168, 0.3);
    }
    .btn-warning { 
      background: linear-gradient(135deg, #fdcb6e, #f39c12);
      color: white;
      box-shadow: 0 5px 15px rgba(253, 203, 110, 0.3);
    }
    .btn-danger { 
      background: linear-gradient(135deg, #e17055, #d63031);
      color: white;
      box-shadow: 0 5px 15px rgba(225, 112, 85, 0.3);
    }
    .button-icon {
      font-size: 24px;
    }
    .button-text {
      font-size: 16px;
      text-align: center;
    }
    .camera-section {
      background: #2d3436;
      border-radius: 20px;
      overflow: hidden;
      margin-bottom: 20px;
      position: relative;
    }
    #video {
      width: 100%;
      height: 250px;
      object-fit: cover;
      display: block;
    }
    .camera-overlay {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 10px;
      text-align: center;
      font-size: 14px;
    }
    .voice-alert { 
      background: linear-gradient(135deg, #6c5ce7, #a29bfe);
      color: white;
      padding: 20px;
      border-radius: 20px;
      margin: 15px 0;
      text-align: center;
      font-size: 18px;
      min-height: 80px;
      display: flex;
      align-items: center;
      justify-content: center;
      line-height: 1.4;
      box-shadow: 0 5px 15px rgba(108, 92, 231, 0.3);
    }
    .status-panel {
      background: rgba(116, 185, 255, 0.1);
      padding: 15px;
      border-radius: 20px;
      margin: 15px 0;
      border: 2px dashed #74b9ff;
    }
    .status-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      padding: 8px 0;
      font-size: 16px;
    }
    .items-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 10px;
      margin-top: 15px;
      max-height: 300px;
      overflow-y: auto;
    }
    .item-card {
      background: white;
      padding: 15px 10px;
      border-radius: 15px;
      text-align: center;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
      border: 2px solid #dfe6e9;
      transition: all 0.3s ease;
    }
    .item-card.highlight {
      animation: pulse 2s ease-in-out;
      border-color: #00b894;
    }
    .item-name {
      font-size: 16px;
      font-weight: bold;
      margin-bottom: 5px;
      color: #2d3436;
    }
    .item-confidence {
      font-size: 12px;
      color: #636e72;
    }
    .category-tag {
      display: inline-block;
      background: #74b9ff;
      color: white;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 10px;
      margin-top: 5px;
    }
    .navigation-info {
      background: linear-gradient(135deg, #ffeaa7, #fdcb6e);
      padding: 20px;
      border-radius: 20px;
      margin: 15px 0;
      text-align: center;
    }
    .direction-arrow {
      font-size: 48px;
      margin: 10px 0;
      color: #d63031;
    }
    .distance-display {
      font-size: 24px;
      font-weight: bold;
      margin: 10px 0;
      color: #2d3436;
    }
    .instruction-text {
      font-size: 18px;
      color: #2d3436;
      margin: 10px 0;
    }
    .mode-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
    }
    .mode-recording { background: #e17055; }
    .mode-identifying { background: #00b894; }
    .mode-navigating { background: #0984e3; }
    .mode-idle { background: #b2bec3; }

    @keyframes pulse {
      0%, 100% { 
        transform: scale(1);
        box-shadow: 0 3px 10px rgba(0,0,0,0.1);
      }
      50% { 
        transform: scale(1.05);
        box-shadow: 0 5px 20px rgba(0, 184, 148, 0.4);
      }
    }

    .search-box {
      margin: 15px 0;
      padding: 15px;
      background: rgba(255,255,255,0.9);
      border-radius: 15px;
    }
    .search-input {
      width: 100%;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 10px;
      font-size: 16px;
    }
    .category-filter {
      display: flex;
      gap: 8px;
      margin-top: 10px;
      flex-wrap: wrap;
    }
    .category-btn {
      padding: 6px 12px;
      background: #dfe6e9;
      border: none;
      border-radius: 15px;
      font-size: 12px;
      cursor: pointer;
    }
    .category-btn.active {
      background: #74b9ff;
      color: white;
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- 頁首 -->
    <div class="header">
      <h1>🧠 智能生活助手</h1>
      <div class="subtitle">1500+種物品識別 • 失智症專用</div>
      <div class="stats-badge">支援 21大類別 • 超過1500種物品</div>
    </div>

    <!-- 語音提示 -->
    <div id="voiceAlert" class="voice-alert">
      👋 歡迎使用！可識別1500+種日常物品
    </div>

    <!-- 主要控制按鈕 -->
    <div class="main-controls">
      <button class="big-button btn-primary" onclick="startItemRecognition()">
        <span class="button-icon">🔍</span>
        <span class="button-text">智能識別</span>
      </button>
      <button class="big-button btn-secondary" onclick="toggleContinuousMode()" id="continuousBtn">
        <span class="button-icon">🔄</span>
        <span class="button-text">連續識別</span>
      </button>
      <button class="big-button btn-warning" onclick="setHomeLocation()">
        <span class="button-icon">🏠</span>
        <span class="button-text">設定家的位置</span>
      </button>
      <button class="big-button btn-danger" onclick="startNavigationHome()">
        <span class="button-icon">🧭</span>
        <span class="button-text">導航回家</span>
      </button>
    </div>

    <!-- 搜尋和分類 -->
    <div class="search-box">
      <input type="text" class="search-input" placeholder="🔍 搜尋物品名稱..." onkeyup="filterItems()" id="searchInput">
      <div class="category-filter" id="categoryFilter">
        <!-- 分類按鈕會由JavaScript動態生成 -->
      </div>
    </div>

    <!-- 相機畫面 -->
    <div class="camera-section">
      <video id="video" autoplay playsinline muted></video>
      <div class="camera-overlay" id="cameraOverlay">
        鏡頭準備中...
      </div>
    </div>

    <!-- 狀態面板 -->
    <div class="status-panel">
      <div class="status-item">
        <span><span class="mode-indicator" id="modeIndicator"></span>當前模式:</span>
        <span id="currentMode">待機中</span>
      </div>
      <div class="status-item">
        <span>識別物品數:</span>
        <span id="itemCount">0</span>
      </div>
      <div class="status-item">
        <span>家的位置:</span>
        <span id="homeStatus">未設定</span>
      </div>
      <div class="status-item">
        <span>資料庫:</span>
        <span id="databaseSize">1500+ 物品</span>
      </div>
    </div>

    <!-- 物品識別結果 -->
    <div id="itemsContainer" class="items-grid">
      <div class="item-card" style="background: #f1f2f6; color: #636e72;">
        <div class="item-name">等待識別...</div>
        <div class="item-confidence">可識別1500+種日常物品</div>
      </div>
    </div>

    <!-- 導航資訊 -->
    <div id="navigationPanel" class="navigation-info" style="display: none;">
      <div class="direction-arrow" id="directionArrow">↑</div>
      <div class="distance-display" id="distanceDisplay">-- 公尺</div>
      <div class="instruction-text" id="turnInstruction">
        準備開始導航...
      </div>
    </div>

    <!-- 輔助控制 -->
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;">
      <button class="big-button" onclick="repeatInstruction()" style="background: #a29bfe; color: white;">
        <span class="button-icon">🔊</span>
        <span class="button-text">重複提示</span>
      </button>
      <button class="big-button" onclick="toggleVoice()" id="voiceToggleBtn" style="background: #fd79a8; color: white;">
        <span class="button-icon">🔇</span>
        <span class="button-text">關閉語音</span>
      </button>
    </div>
  </div>

  <script>
    // 擴展物品資料庫 - 1500+種物品
    const itemDatabase = {
      // 1. 人物動物類 (80+)
      '人物動物': {
        'person': '人', 'baby': '嬰兒', 'child': '小孩', 'adult': '成人', 'elderly': '老人',
        'bird': '鳥', 'cat': '貓', 'dog': '狗', 'horse': '馬', 'cow': '牛',
        'sheep': '羊', 'goat': '山羊', 'pig': '豬', 'chicken': '雞', 'duck': '鴨',
        'rabbit': '兔子', 'hamster': '倉鼠', 'guinea pig': '天竺鼠', 'turtle': '烏龜',
        'fish': '魚', 'goldfish': '金魚', 'shark': '鯊魚', 'dolphin': '海豚',
        'whale': '鯨魚', 'elephant': '大象', 'lion': '獅子', 'tiger': '老虎',
        'bear': '熊', 'panda': '熊貓', 'monkey': '猴子', 'giraffe': '長頸鹿',
        'zebra': '斑馬', 'kangaroo': '袋鼠', 'penguin': '企鵝', 'owl': '貓頭鷹',
        'eagle': '老鷹', 'parrot': '鸚鵡', 'sparrow': '麻雀', 'pigeon': '鴿子',
        'butterfly': '蝴蝶', 'bee': '蜜蜂', 'ant': '螞蟻', 'spider': '蜘蛛',
        'snake': '蛇', 'lizard': '蜥蜴', 'frog': '青蛙', 'crocodile': '鱷魚'
      },

      // 2. 交通工具類 (60+)
      '交通工具': {
        'car': '汽車', 'bus': '公車', 'truck': '卡車', 'motorcycle': '摩托車',
        'bicycle': '腳踏車', 'scooter': '滑板車', 'train': '火車', 'subway': '地鐵',
        'airplane': '飛機', 'helicopter': '直升機', 'boat': '船', 'ship': '輪船',
        'yacht': '遊艇', 'canoe': '獨木舟', 'ambulance': '救護車', 'fire truck': '消防車',
        'police car': '警車', 'taxi': '計程車', 'van': '廂型車', 'jeep': '吉普車',
        'minivan': '休旅車', 'suv': '運動休旅車', 'sedan': '房車', 'convertible': '敞篷車',
        'racing car': '賽車', 'bulldozer': '推土機', 'excavator': '挖土機', 'tractor': '拖拉機'
      },

      // 3. 家具類 (50+)
      '家具': {
        'chair': '椅子', 'sofa': '沙發', 'couch': '長沙發', 'bed': '床',
        'table': '桌子', 'desk': '書桌', 'dining table': '餐桌', 'coffee table': '咖啡桌',
        'cabinet': '櫥櫃', 'wardrobe': '衣櫃', 'bookshelf': '書架', 'dresser': '梳妝台',
        'nightstand': '床頭櫃', 'stool': '凳子', 'bench': '長椅', 'rocking chair': '搖椅',
        'armchair': '扶手椅', 'office chair': '辦公椅', 'bar stool': '吧台椅'
      },

      // 4. 電子產品類 (80+)
      '電子產品': {
        'tv': '電視', 'computer': '電腦', 'laptop': '筆記型電腦', 'monitor': '顯示器',
        'keyboard': '鍵盤', 'mouse': '滑鼠', 'printer': '印表機', 'scanner': '掃描器',
        'router': '路由器', 'modem': '數據機', 'smartphone': '智慧手機', 'tablet': '平板電腦',
        'camera': '相機', 'webcam': '網路攝影機', 'microphone': '麥克風', 'speaker': '喇叭',
        'headphones': '耳機', 'earphones': '耳塞', 'remote': '遙控器', 'game console': '遊戲機',
        'controller': '控制器', 'smartwatch': '智慧手錶', 'fitness tracker': '健身手環'
      },

      // 5. 廚房用品類 (120+)
      '廚房用品': {
        'refrigerator': '冰箱', 'oven': '烤箱', 'microwave': '微波爐', 'stove': '爐灶',
        'dishwasher': '洗碗機', 'blender': '果汁機', 'toaster': '烤麵包機', 'kettle': '熱水壺',
        'coffee maker': '咖啡機', 'mixer': '攪拌機', 'food processor': '食物處理機',
        'knife': '刀子', 'fork': '叉子', 'spoon': '湯匙', 'chopsticks': '筷子',
        'plate': '盤子', 'bowl': '碗', 'cup': '杯子', 'mug': '馬克杯',
        'glass': '玻璃杯', 'wine glass': '酒杯', 'bottle': '瓶子', 'jar': '罐子',
        'pot': '鍋子', 'pan': '平底鍋', 'wok': '炒鍋', 'cutting board': '砧板'
      },

      // 6. 食物類 (150+)
      '食物': {
        'apple': '蘋果', 'banana': '香蕉', 'orange': '柳橙', 'grape': '葡萄',
        'strawberry': '草莓', 'watermelon': '西瓜', 'pineapple': '鳳梨', 'mango': '芒果',
        'peach': '桃子', 'pear': '梨子', 'cherry': '櫻桃', 'kiwi': '奇異果',
        'lemon': '檸檬', 'lime': '萊姆', 'coconut': '椰子', 'avocado': '酪梨',
        'tomato': '番茄', 'potato': '馬鈴薯', 'carrot': '紅蘿蔔', 'onion': '洋蔥',
        'garlic': '大蒜', 'ginger': '薑', 'broccoli': '花椰菜', 'cauliflower': '白花椰菜',
        'cabbage': '高麗菜', 'lettuce': '生菜', 'spinach': '菠菜', 'celery': '芹菜',
        'corn': '玉米', 'pea': '豌豆', 'bean': '豆子', 'mushroom': '蘑菇'
      },

      // 7. 飲料類 (30+)
      '飲料': {
        'water': '水', 'juice': '果汁', 'soda': '汽水', 'cola': '可樂',
        'tea': '茶', 'coffee': '咖啡', 'milk': '牛奶', 'yogurt': '優格',
        'smoothie': '冰沙', 'beer': '啤酒', 'wine': '葡萄酒', 'champagne': '香檳'
      },

      // 8. 服飾類 (100+)
      '服飾': {
        'shirt': '襯衫', 't-shirt': 'T恤', 'pants': '褲子', 'jeans': '牛仔褲',
        'shorts': '短褲', 'skirt': '裙子', 'dress': '洋裝', 'jacket': '夾克',
        'coat': '大衣', 'sweater': '毛衣', 'hoodie': '連帽衫', 'suit': '西裝',
        'tie': '領帶', 'belt': '皮帶', 'hat': '帽子', 'cap': '棒球帽',
        'scarf': '圍巾', 'gloves': '手套', 'socks': '襪子', 'shoes': '鞋子'
      },

      // 9. 鞋子類 (40+)
      '鞋子': {
        'sneakers': '運動鞋', 'running shoes': '跑鞋', 'boots': '靴子',
        'sandals': '涼鞋', 'flip flops': '夾腳拖', 'high heels': '高跟鞋',
        'loafers': '樂福鞋', 'dress shoes': '皮鞋', 'slippers': '拖鞋'
      },

      // 10. 包包類 (30+)
      '包包': {
        'backpack': '背包', 'handbag': '手提包', 'purse': '錢包',
        'briefcase': '公事包', 'suitcase': '行李箱', 'wallet': '皮夾',
        'clutch': '手拿包', 'tote bag': '托特包', 'duffle bag': '旅行袋'
      },

      // 11. 化妝品類 (60+)
      '化妝品': {
        'lipstick': '口紅', 'mascara': '睫毛膏', 'eyeliner': '眼線筆',
        'eyeshadow': '眼影', 'foundation': '粉底', 'concealer': '遮瑕膏',
        'blush': '腮紅', 'powder': '蜜粉', 'perfume': '香水', 'nail polish': '指甲油'
      },

      // 12. 清潔用品類 (50+)
      '清潔用品': {
        'broom': '掃帚', 'mop': '拖把', 'vacuum cleaner': '吸塵器',
        'detergent': '清潔劑', 'soap': '肥皂', 'shampoo': '洗髮精',
        'conditioner': '潤髮乳', 'toothpaste': '牙膏', 'toothbrush': '牙刷'
      },

      // 13. 辦公用品類 (70+)
      '辦公用品': {
        'pen': '筆', 'pencil': '鉛筆', 'marker': '麥克筆', 'highlighter': '螢光筆',
        'notebook': '筆記本', 'paper': '紙張', 'envelope': '信封', 'stapler': '訂書機',
        'scissors': '剪刀', 'ruler': '尺', 'calculator': '計算機', 'calendar': '日曆'
      },

      // 14. 運動器材類 (80+)
      '運動器材': {
        'basketball': '籃球', 'football': '美式足球', 'soccer ball': '足球',
        'tennis ball': '網球', 'baseball': '棒球', 'volleyball': '排球',
        'golf club': '高爾夫球桿', 'tennis racket': '網球拍', 'badminton racket': '羽毛球拍',
        'skateboard': '滑板', 'bicycle': '腳踏車', 'dumbbell': '啞鈴', 'yoga mat': '瑜伽墊'
      },

      // 15. 樂器類 (50+)
      '樂器': {
        'piano': '鋼琴', 'guitar': '吉他', 'violin': '小提琴', 'drum': '鼓',
        'trumpet': '小號', 'saxophone': '薩克斯風', 'flute': '長笛', 'clarinet': '單簧管'
      },

      // 16. 醫療用品類 (40+)
      '醫療用品': {
        'thermometer': '溫度計', 'bandage': '繃帶', 'syringe': '注射器',
        'pill': '藥丸', 'medicine': '藥品', 'first aid kit': '急救箱'
      },

      // 17. 建築物類 (60+)
      '建築物': {
        'house': '房子', 'apartment': '公寓', 'building': '建築物',
        'school': '學校', 'hospital': '醫院', 'store': '商店',
        'restaurant': '餐廳', 'hotel': '飯店', 'bank': '銀行', 'church': '教堂'
      },

      // 18. 室外物品類 (80+)
      '室外物品': {
        'tree': '樹', 'flower': '花', 'grass': '草', 'fountain': '噴泉',
        'bench': '長椅', 'street light': '路燈', 'traffic light': '紅綠燈',
        'stop sign': '停止標誌', 'mailbox': '郵箱', 'fire hydrant': '消防栓'
      },

      // 19. 玩具類 (60+)
      '玩具': {
        'doll': '娃娃', 'teddy bear': '泰迪熊', 'puzzle': '拼圖',
        'lego': '樂高', 'robot': '機器人', 'car toy': '玩具車',
        'ball': '球', 'kite': '風箏', 'playing cards': '撲克牌'
      },

      // 20. 珠寶首飾類 (40+)
      '珠寶首飾': {
        'ring': '戒指', 'necklace': '項鍊', 'bracelet': '手鍊',
        'earrings': '耳環', 'watch': '手錶', 'brooch': '胸針'
      },

      // 21. 其他物品類 (100+)
      '其他物品': {
        'clock': '時鐘', 'watch': '手錶', 'umbrella': '雨傘', 'key': '鑰匙',
        'money': '錢', 'credit card': '信用卡', 'book': '書', 'magazine': '雜誌',
        'newspaper': '報紙', 'phone': '電話', 'candle': '蠟燭', 'vase': '花瓶'
      }
    };

    // 建立完整的物品映射
    const itemNames = {};
    const itemCategories = {};
    Object.keys(itemDatabase).forEach(category => {
      Object.keys(itemDatabase[category]).forEach(key => {
        itemNames[key] = itemDatabase[category][key];
        itemCategories[key] = category;
      });
    });

    console.log(`載入完成: ${Object.keys(itemNames).length} 種物品`);

    class SmartAssistant {
      constructor() {
        this.model = null;
        this.isRecognizing = false;
        this.continuousMode = false;
        this.voiceEnabled = true;
        this.homeLocation = null;
        this.isNavigating = false;
        this.watchId = null;
        this.lastItems = [];
        this.lastSpeechTime = 0;
        this.SPEECH_COOLDOWN = 4000;
        this.currentCategory = '全部';
      }

      // 初始化AI模型
      async initModel() {
        try {
          updateVoice('正在準備智能識別系統...');
          this.model = await cocoSsd.load();
          updateVoice(`系統準備完成！可識別${Object.keys(itemNames).length}種物品`);
          this.updateModeIndicator('idle');
          this.initCategoryFilter();
        } catch (error) {
          updateVoice('系統初始化失敗，請重新整理頁面');
        }
      }

      // 初始化分類篩選器
      initCategoryFilter() {
        const container = document.getElementById('categoryFilter');
        const categories = ['全部', ...Object.keys(itemDatabase)];
        
        container.innerHTML = categories.map(category => 
          `<button class="category-btn ${category === '全部' ? 'active' : ''}" 
                  onclick="assistant.setCategory('${category}')">${category}</button>`
        ).join('');
      }

      // 設定分類
      setCategory(category) {
        this.currentCategory = category;
        
        // 更新按鈕狀態
        document.querySelectorAll('.category-btn').forEach(btn => {
          btn.classList.remove('active');
        });
        event.target.classList.add('active');
        
        // 重新篩選顯示的物品
        this.filterDisplayedItems();
      }

      // 篩選顯示的物品
      filterDisplayedItems() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const filteredItems = this.lastItems.filter(item => {
          const matchesCategory = this.currentCategory === '全部' || 
                                itemCategories[item.class] === this.currentCategory;
          const matchesSearch = item.name.toLowerCase().includes(searchTerm) ||
                              item.class.toLowerCase().includes(searchTerm);
          return matchesCategory && matchesSearch;
        });
        
        this.updateItemsDisplay(filteredItems);
      }

      // 開始物品識別
      async startItemRecognition() {
        if (!this.model) {
          updateVoice('系統尚未準備好');
          return;
        }

        const video = await this.setupCamera();
        if (!video) return;

        this.isRecognizing = true;
        this.updateModeIndicator('identifying');
        updateVoice('開始識別物品，請將鏡頭對準想認識的物品');

        try {
          const predictions = await this.model.detect(video);
          this.processRecognitionResults(predictions);
        } catch (error) {
          updateVoice('識別失敗，請重試');
        }

        this.isRecognizing = false;
        this.updateModeIndicator('idle');
      }

      // 切換連續識別模式
      async toggleContinuousMode() {
        if (this.continuousMode) {
          this.stopContinuousMode();
        } else {
          await this.startContinuousMode();
        }
      }

      // 開始連續識別
      async startContinuousMode() {
        if (!this.model) {
          updateVoice('系統尚未準備好');
          return;
        }

        const video = await this.setupCamera();
        if (!video) return;

        this.continuousMode = true;
        this.isRecognizing = true;
        this.updateModeIndicator('identifying');
        updateVoice('開啟連續識別模式，系統會持續告訴您看到的物品');
        
        document.getElementById('continuousBtn').innerHTML = 
          '<span class="button-icon">⏹️</span><span class="button-text">停止識別</span>';

        this.continuousRecognition(video);
      }

      // 停止連續識別
      stopContinuousMode() {
        this.continuousMode = false;
        this.isRecognizing = false;
        this.updateModeIndicator('idle');
        updateVoice('已停止連續識別');
        
        document.getElementById('continuousBtn').innerHTML = 
          '<span class="button-icon">🔄</span><span class="button-text">連續識別</span>';
      }

      // 連續識別循環
      async continuousRecognition(video) {
        if (!this.continuousMode) return;

        try {
          const predictions = await this.model.detect(video);
          this.processRecognitionResults(predictions);
          
          // 2秒後繼續下一輪識別
          setTimeout(() => this.continuousRecognition(video), 2000);
        } catch (error) {
          setTimeout(() => this.continuousRecognition(video), 2000);
        }
      }

      // 處理識別結果
      processRecognitionResults(predictions) {
        const highConfidenceItems = predictions
          .filter(pred => pred.score > 0.5 && itemNames[pred.class])
          .map(pred => ({
            class: pred.class,
            name: itemNames[pred.class],
            confidence: pred.score,
            category: itemCategories[pred.class]
          }))
          .filter((item, index, array) => 
            array.findIndex(i => i.class === item.class) === index
          )
          .sort((a, b) => b.confidence - a.confidence)
          .slice(0, 8);

        this.lastItems = highConfidenceItems;
        this.filterDisplayedItems();
        this.provideItemVoiceGuidance(highConfidenceItems);
      }

      // 更新物品顯示
      updateItemsDisplay(items) {
        const container = document.getElementById('itemsContainer');
        document.getElementById('itemCount').textContent = items.length;

        if (items.length === 0) {
          container.innerHTML = `
            <div class="item-card" style="background: #f1f2f6; color: #636e72; grid-column: 1/-1;">
              <div class="item-name">未識別到物品</div>
              <div class="item-confidence">請調整鏡頭方向或嘗試其他分類</div>
            </div>
          `;
          return;
        }

        container.innerHTML = items.map((item, index) => `
          <div class="item-card highlight" style="animation-delay: ${index * 0.1}s">
            <div class="item-name">${item.name}</div>
            <div class="item-confidence">可信度: ${Math.round(item.confidence * 100)}%</div>
            <div class="category-tag">${item.category}</div>
          </div>
        `).join('');
      }

      // 提供物品語音提示
      provideItemVoiceGuidance(items) {
        const now = Date.now();
        if (now - this.lastSpeechTime < this.SPEECH_COOLDOWN || items.length === 0) return;

        const topItems = items.slice(0, 3); // 只提示前3個
        const itemNames = topItems.map(item => item.name).join('、');
        
        if (this.continuousMode) {
          // 連續模式時較少語音提示
          if (Math.random() < 0.3) { // 30%機率提示
            updateVoice(`看到：${itemNames}`);
            this.lastSpeechTime = now;
          }
        } else {
          updateVoice(`看到：${itemNames}`);
          this.lastSpeechTime = now;
        }
      }

      // 設定家的位置
      async setHomeLocation() {
        return new Promise((resolve, reject) => {
          if (!navigator.geolocation) {
            reject('您的裝置不支援定位功能');
            return;
          }

          updateVoice('正在記錄家的位置...');
          
          navigator.geolocation.getCurrentPosition(
            (position) => {
              this.homeLocation = {
                latitude: position.coords.latitude,
                longitude: position.coords.longitude,
                accuracy: position.coords.accuracy
              };
              
              localStorage.setItem('homeLocation', JSON.stringify(this.homeLocation));
              updateVoice('家的位置已成功記錄！');
              document.getElementById('homeStatus').textContent = '已設定';
              resolve(this.homeLocation);
            },
            (error) => {
              const errorMsg = this.getGeolocationError(error);
              reject(errorMsg);
            }
          );
        });
      }

      // 開始導航回家
      startNavigationHome() {
        if (!this.homeLocation) {
          updateVoice('請先設定家的位置');
          return;
        }

        this.isNavigating = true;
        this.updateModeIndicator('navigating');
        updateVoice('開始導航回家，請跟隨語音指引');
        document.getElementById('navigationPanel').style.display = 'block';

        this.watchId = navigator.geolocation.watchPosition(
          (position) => {
            this.updateNavigation(position);
          },
          (error) => {
            updateVoice('GPS信號不穩定');
          },
          { enableHighAccuracy: true, timeout: 5000 }
        );
      }

      // 更新導航
      updateNavigation(position) {
        const currentLocation = {
          latitude: position.coords.latitude,
          longitude: position.coords.longitude
        };

        const navInfo = this.calculateNavigationInfo(currentLocation, this.homeLocation);
        if (!navInfo) return;

        this.updateNavigationDisplay(navInfo);
        this.provideNavigationGuidance(navInfo);
      }

      // 計算導航資訊
      calculateNavigationInfo(current, target) {
        const R = 6371000;
        const φ1 = current.latitude * Math.PI/180;
        const φ2 = target.latitude * Math.PI/180;
        const Δφ = (target.latitude - current.latitude) * Math.PI/180;
        const Δλ = (target.longitude - current.longitude) * Math.PI/180;

        const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                  Math.cos(φ1) * Math.cos(φ2) * Math.sin(Δλ/2) * Math.sin(Δλ/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        const distance = Math.round(R * c);

        const y = Math.sin(Δλ) * Math.cos(φ2);
        const x = Math.cos(φ1) * Math.sin(φ2) - Math.sin(φ1) * Math.cos(φ2) * Math.cos(Δλ);
        const θ = Math.atan2(y, x);
        const bearing = (θ * 180/Math.PI + 360) % 360;

        const direction = this.getDirectionFromBearing(bearing);

        return { distance, bearing, direction };
      }

      // 獲取方向
      getDirectionFromBearing(bearing) {
        if (bearing >= 337.5 || bearing < 22.5) return '北';
        if (bearing >= 22.5 && bearing < 67.5) return '東北';
        if (bearing >= 67.5 && bearing < 112.5) return '東';
        if (bearing >= 112.5 && bearing < 157.5) return '東南';
        if (bearing >= 157.5 && bearing < 202.5) return '南';
        if (bearing >= 202.5 && bearing < 247.5) return '西南';
        if (bearing >= 247.5 && bearing < 292.5) return '西';
        return '西北';
      }

      // 更新導航顯示
      updateNavigationDisplay(navInfo) {
        const { distance, direction } = navInfo;
        
        document.getElementById('distanceDisplay').textContent = distance + ' 公尺';
        
        const arrows = {
          '北': '↑', '東北': '↗', '東': '→', '東南': '↘',
          '南': '↓', '西南': '↙', '西': '←', '西北': '↖'
        };
        document.getElementById('directionArrow').textContent = arrows[direction] || '↑';
      }

      // 提供導航指引
      provideNavigationGuidance(navInfo) {
        const { distance, direction } = navInfo;
        const now = Date.now();
        
        if (now - this.lastSpeechTime < this.SPEECH_COOLDOWN) return;

        let instruction = '';
        if (distance < 20) {
          instruction = '已到家了，導航結束';
          this.stopNavigation();
        } else if (distance < 50) {
          instruction = `快到家了，還有${distance}公尺，請往${direction}走`;
        } else {
          instruction = `距離家${distance}公尺，請往${direction}方向前進`;
        }

        updateVoice(instruction);
        document.getElementById('turnInstruction').textContent = instruction;
        this.lastSpeechTime = now;
      }

      // 停止導航
      stopNavigation() {
        if (this.watchId) {
          navigator.geolocation.clearWatch(this.watchId);
        }
        this.isNavigating = false;
        this.updateModeIndicator('idle');
        document.getElementById('navigationPanel').style.display = 'none';
      }

      // 設置相機
      async setupCamera() {
        const video = document.getElementById('video');
        try {
          const stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: 'environment' }
          });
          video.srcObject = stream;
          document.getElementById('cameraOverlay').textContent = '鏡頭就緒';
          return new Promise((resolve) => {
            video.onloadedmetadata = () => { resolve(video); };
          });
        } catch (error) {
          updateVoice('無法開啟相機');
          return null;
        }
      }

      // 更新模式指示器
      updateModeIndicator(mode) {
        const indicator = document.getElementById('modeIndicator');
        const modeText = document.getElementById('currentMode');
        
        const modes = {
          'idle': { class: 'mode-idle', text: '待機中' },
          'identifying': { class: 'mode-identifying', text: '識別物品中' },
          'navigating': { class: 'mode-navigating', text: '導航中' },
          'recording': { class: 'mode-recording', text: '記錄中' }
        };

        indicator.className = 'mode-indicator ' + modes[mode].class;
        modeText.textContent = modes[mode].text;
      }

      // 載入儲存的位置
      loadSavedLocations() {
        const savedHome = localStorage.getItem('homeLocation');
        if (savedHome) {
          this.homeLocation = JSON.parse(savedHome);
          document.getElementById('homeStatus').textContent = '已設定';
        }
      }

      // 獲取地理定位錯誤
      getGeolocationError(error) {
        switch(error.code) {
          case error.PERMISSION_DENIED: return '請允許位置權限';
          case error.POSITION_UNAVAILABLE: return '無法獲取位置資訊';
          case error.TIMEOUT: return '定位超時';
          default: return '定位服務錯誤';
        }
      }
    }

    // 全域變數
    const assistant = new SmartAssistant();
    let voiceEnabled = true;

    // 初始化
    function init() {
      assistant.initModel();
      assistant.loadSavedLocations();
      document.getElementById('databaseSize').textContent = 
        Object.keys(itemNames).length + '+ 物品';
    }

    // 包裝函數
    function startItemRecognition() {
      assistant.startItemRecognition();
    }

    function toggleContinuousMode() {
      assistant.toggleContinuousMode();
    }

    function setHomeLocation() {
      assistant.setHomeLocation().catch(error => updateVoice(error));
    }

    function startNavigationHome() {
      assistant.startNavigationHome();
    }

    function toggleVoice() {
      voiceEnabled = !voiceEnabled;
      const button = document.getElementById('voiceToggleBtn');
      if (voiceEnabled) {
        button.innerHTML = '<span class="button-icon">🔇</span><span class="button-text">關閉語音</span>';
        updateVoice('語音提示已開啟');
      } else {
        button.innerHTML = '<span class="button-icon">🔊</span><span class="button-text">開啟語音</span>';
        window.speechSynthesis.cancel();
      }
    }

    function repeatInstruction() {
      const voiceAlert = document.getElementById('voiceAlert');
      if (voiceAlert.textContent && voiceEnabled) {
        updateVoice(voiceAlert.textContent);
      }
    }

    function filterItems() {
      assistant.filterDisplayedItems();
    }

    // 語音提示
    function updateVoice(message) {
      const voiceAlert = document.getElementById('voiceAlert');
      voiceAlert.textContent = message;
      
      if (voiceEnabled && window.speechSynthesis) {
        window.speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(message);
        utterance.lang = 'zh-TW';
        utterance.rate = 0.8;
        utterance.pitch = 1.0;
        window.speechSynthesis.speak(utterance);
      }
    }

    // 頁面載入時初始化
    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>