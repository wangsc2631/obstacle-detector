<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="theme-color" content="#0ea5e9" />
  <meta name="description" content="盲人輔助導航 - 即時障礙物檢測" />
  <title>🧭 盲人輔助導航</title>
  
  <!-- TensorFlow.js 和 COCO-SSD -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.15.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.3/dist/coco-ssd.min.js"></script>
  
  <style>
    :root {
      --bg1: #0ea5e9;
      --bg2: #6366f1;
      --glass: rgba(255,255,255,0.12);
      --glass-strong: rgba(255,255,255,0.22);
      --text: #fff;
      --good: #22c55e;
      --warn: #f59e0b;
      --bad: #ef4444;
      --muted: #cbd5e1;
    }
    
    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      color: var(--text);
      background: linear-gradient(135deg, var(--bg1), var(--bg2));
      touch-action: manipulation;
    }
    
    body {
      padding: 10px;
    }
    
    .container {
      max-width: 100%;
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }
    
    .camera-container {
      position: relative;
      width: 100%;
      height: 50vh;
      background: #000;
      border-radius: 15px;
      overflow: hidden;
      margin-bottom: 15px;
    }
    
    #video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transform: scaleX(1);
    }
    
    .controls {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 15px;
    }
    
    .btn {
      padding: 16px 12px;
      border: none;
      border-radius: 14px;
      font-weight: 700;
      font-size: 14px;
      cursor: pointer;
      min-height: 54px;
    }
    
    .btn-primary { background: var(--good); color: white; }
    .btn-warning { background: var(--warn); color: white; }
    .btn-danger { background: var(--bad); color: white; }
    .btn-secondary { background: var(--glass-strong); color: var(--text); }
    
    .voice-alert {
      background: rgba(239,68,68,0.15);
      border: 1px solid rgba(239,68,68,0.35);
      color: #fff;
      border-radius: 12px;
      padding: 16px;
      text-align: center;
      min-height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      margin: 10px 0;
    }
    
    .status-panel {
      background: rgba(0,0,0,0.3);
      padding: 12px;
      border-radius: 10px;
      margin-bottom: 15px;
    }
    
    .status-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      padding: 5px 0;
    }
    
    .detection-info {
      background: rgba(0,0,0,0.2);
      padding: 10px;
      border-radius: 10px;
      font-size: 14px;
    }
    
    .loading {
      background: linear-gradient(90deg, var(--bg1), var(--bg2), var(--bg1));
      background-size: 200% 100%;
      animation: loading 2s infinite;
    }
    
    @keyframes loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
    
    .no-select {
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }
  </style>
</head>
<body class="no-select">
  <div class="container">
    <h2 style="text-align: center; margin-bottom: 15px;">🧭 盲人即時導航輔助</h2>
    
    <div class="camera-container">
      <video id="video" autoplay playsinline muted></video>
    </div>
    
    <div id="voiceAlert" class="voice-alert loading">系統啟動中...</div>
    
    <div class="controls">
      <button class="btn btn-primary" onclick="startDetection()">開始檢測</button>
      <button class="btn btn-secondary" onclick="toggleVoice()" id="voiceBtn">語音開啟</button>
      <button class="btn btn-warning" onclick="toggleDetectionMode()" id="modeBtn">詳細模式</button>
      <button class="btn btn-danger" onclick="stopDetection()">停止檢測</button>
    </div>

    <div class="status-panel">
      <div class="status-item">
        <span>檢測狀態:</span>
        <span id="detectionStatus">未開始</span>
      </div>
      <div class="status-item">
        <span>障礙物數量:</span>
        <span id="obstacleCount">0</span>
      </div>
      <div class="status-item">
        <span>最近障礙物:</span>
        <span id="closestObstacle">無</span>
      </div>
      <div class="status-item">
        <span>檢測模式:</span>
        <span id="detectionMode">簡潔模式</span>
      </div>
    </div>

    <div class="detection-info" id="detectionInfo">
      <div style="text-align: center; color: #ccc;">
        等待開始檢測...
      </div>
    </div>
  </div>

  <script>
    /**********************
     * 1) 核心參數設定
     **********************/
    let model = null;
    let isDetecting = false;
    let voiceEnabled = true;
    let detailedMode = false;
    let lastSpeechTime = 0;
    const SPEECH_COOLDOWN = 3000; // 3秒冷卻

    // 重要的障礙物類別（移除不必要的類別）
    const importantObstacles = {
      'person': '行人',
      'car': '汽車',
      'motorcycle': '摩托車',
      'bus': '公車',
      'truck': '卡車',
      'bicycle': '腳踏車',
      'chair': '椅子',
      'couch': '沙發',
      'bed': '床',
      'dining table': '桌子',
      'tv': '電視',
      'laptop': '電腦',
      'bottle': '瓶子',
      'cup': '杯子',
      'book': '書本'
    };

    /**********************
     * 2) 模型初始化
     **********************/
    async function initModel() {
      try {
        updateVoice('正在載入AI檢測模型...');
        model = await cocoSsd.load();
        updateVoice('模型載入成功！請點擊開始檢測');
        console.log('COCO-SSD 模型載入成功');
      } catch (error) {
        console.error('模型載入失敗:', error);
        updateVoice('模型載入失敗，請刷新頁面重試');
      }
    }

    /**********************
     * 3) 相機設置
     **********************/
    async function setupCamera() {
      const video = document.getElementById('video');
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { 
            facingMode: 'environment',
            width: { ideal: 640 },
            height: { ideal: 480 }
          }
        });
        video.srcObject = stream;
        return new Promise((resolve) => {
          video.onloadedmetadata = () => { resolve(video); };
        });
      } catch (error) {
        updateVoice('無法開啟相機: ' + error.message);
        return null;
      }
    }

    /**********************
     * 4) 主要檢測功能
     **********************/
    async function startDetection() {
      if (!model) {
        updateVoice('模型尚未載入完成');
        return;
      }
      
      const video = await setupCamera();
      if (!video) return;
      
      isDetecting = true;
      updateDetectionStatus('檢測中');
      updateVoice('開始即時障礙物檢測');
      
      detectFrame(video);
    }

    async function detectFrame(video) {
      if (!isDetecting) return;
      
      try {
        const predictions = await model.detect(video);
        processDetections(predictions, video.videoWidth, video.videoHeight);
        
        // 繼續下一幀檢測
        setTimeout(() => detectFrame(video), 200); // 5 FPS 避免過載
      } catch (error) {
        console.error('檢測錯誤:', error);
      }
    }

    function processDetections(predictions, width, height) {
      // 過濾重要的障礙物
      const obstacles = predictions.filter(pred => 
        importantObstacles[pred.class] && pred.score > 0.5
      ).map(pred => ({
        ...pred,
        name: importantObstacles[pred.class],
        distance: calculateDistance(pred.bbox[2], pred.bbox[3], pred.class),
        position: analyzePosition(pred.bbox, width, height)
      }));

      updateDisplay(obstacles);
      provideVoiceGuidance(obstacles);
    }

    function calculateDistance(width, height, className) {
      const area = width * height;
      let referenceSize = 10000; // 默認參考大小
      
      // 根據物體類型調整參考大小
      const sizeMap = {
        'person': 8000,
        'car': 40000,
        'chair': 6000,
        'bottle': 2000
      };
      
      referenceSize = sizeMap[className] || referenceSize;
      return Math.max(0.5, Math.sqrt(referenceSize / area) * 5);
    }

    function analyzePosition(bbox, screenWidth, screenHeight) {
      const [x, y, w, h] = bbox;
      const centerX = x + w/2;
      const centerY = y + h/2;
      
      // 分析物體在畫面中的位置
      const horizontal = centerX < screenWidth * 0.4 ? '左側' : 
                        centerX > screenWidth * 0.6 ? '右側' : '前方';
      
      const vertical = centerY < screenHeight * 0.4 ? '遠處' : 
                      centerY > screenHeight * 0.7 ? '近處' : '中距離';
      
      return { horizontal, vertical, centerX, centerY };
    }

    /**********************
     * 5) 語音導航系統
     **********************/
    function provideVoiceGuidance(obstacles) {
      const now = Date.now();
      if (now - lastSpeechTime < SPEECH_COOLDOWN) return;
      
      if (obstacles.length === 0) {
        // 沒有障礙物時，偶爾提示環境安全
        if (Math.random() < 0.1) { // 10% 機率
          updateVoice('前方環境安全，請繼續前進');
          lastSpeechTime = now;
        }
        return;
      }

      // 找到最近的障礙物
      const closest = obstacles.reduce((prev, curr) => 
        curr.distance < prev.distance ? curr : prev
      );

      if (closest.distance < 2) {
        // 緊急情況
        const guidance = generateEmergencyGuidance(closest);
        updateVoice(guidance);
        lastSpeechTime = now;
      } else if (closest.distance < 5) {
        // 中等距離警告
        const guidance = generateWarningGuidance(closest);
        updateVoice(guidance);
        lastSpeechTime = now;
      }
    }

    function generateEmergencyGuidance(obstacle) {
      const directions = [];
      
      if (obstacle.position.horizontal === '左側') {
        directions.push('立即向右閃避');
      } else if (obstacle.position.horizontal === '右側') {
        directions.push('立即向左閃避');
      } else {
        directions.push('立即停止前進');
      }
      
      return `緊急！${obstacle.position.vertical}${obstacle.position.horizontal}有${obstacle.name}，距離${obstacle.distance.toFixed(1)}公尺，${directions.join('，')}！`;
    }

    function generateWarningGuidance(obstacle) {
      const actions = [];
      
      if (obstacle.position.horizontal === '左側') {
        actions.push('請靠右行走');
      } else if (obstacle.position.horizontal === '右側') {
        actions.push('請靠左行走');
      } else {
        actions.push('請注意前方');
      }
      
      return `注意！${obstacle.position.vertical}${obstacle.position.horizontal}有${obstacle.name}，距離${obstacle.distance.toFixed(1)}公尺，${actions.join('，')}`;
    }

    /**********************
     * 6) 顯示更新
     **********************/
    function updateDisplay(obstacles) {
      // 更新狀態顯示
      document.getElementById('obstacleCount').textContent = obstacles.length;
      
      if (obstacles.length > 0) {
        const closest = obstacles.reduce((prev, curr) => 
          curr.distance < prev.distance ? curr : prev
        );
        document.getElementById('closestObstacle').textContent = 
          `${closest.name} (${closest.distance.toFixed(1)}m)`;
      } else {
        document.getElementById('closestObstacle').textContent = '無';
      }
      
      // 更新詳細資訊
      updateDetectionInfo(obstacles);
    }

    function updateDetectionInfo(obstacles) {
      const infoElement = document.getElementById('detectionInfo');
      
      if (obstacles.length === 0) {
        infoElement.innerHTML = '<div style="text-align: center; color: #4CAF50;">✓ 環境安全，無障礙物</div>';
        return;
      }
      
      if (!detailedMode) {
        // 簡潔模式：只顯示最重要的資訊
        const closest = obstacles.reduce((prev, curr) => 
          curr.distance < prev.distance ? curr : prev
        );
        
        let statusColor = '#4CAF50';
        if (closest.distance < 2) statusColor = '#f44336';
        else if (closest.distance < 5) statusColor = '#FF9800';
        
        infoElement.innerHTML = `
          <div style="text-align: center; color: ${statusColor}; font-weight: bold;">
            ⚠️ 檢測到 ${obstacles.length} 個障礙物<br>
            最近: ${closest.name} (${closest.distance.toFixed(1)}公尺)
          </div>
        `;
      } else {
        // 詳細模式：顯示所有障礙物
        const obstaclesHTML = obstacles
          .sort((a, b) => a.distance - b.distance)
          .map(obs => {
            let color = '#4CAF50';
            if (obs.distance < 2) color = '#f44336';
            else if (obs.distance < 5) color = '#FF9800';
            
            return `
              <div style="margin: 5px 0; padding: 8px; background: rgba(255,255,255,0.1); border-radius: 5px; border-left: 4px solid ${color};">
                <strong>${obs.name}</strong><br>
                距離: ${obs.distance.toFixed(1)}公尺 | 位置: ${obs.position.vertical}${obs.position.horizontal}
              </div>
            `;
          })
          .join('');
        
        infoElement.innerHTML = obstaclesHTML;
      }
    }

    /**********************
     * 7) 工具函數
     **********************/
    function updateVoice(message) {
      const voiceAlert = document.getElementById('voiceAlert');
      voiceAlert.textContent = message;
      
      if (voiceEnabled && window.speechSynthesis) {
        window.speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(message);
        utterance.lang = 'zh-TW';
        utterance.rate = 0.9;
        window.speechSynthesis.speak(utterance);
      }
    }

    function updateDetectionStatus(status) {
      document.getElementById('detectionStatus').textContent = status;
    }

    function toggleVoice() {
      voiceEnabled = !voiceEnabled;
      const button = document.getElementById('voiceBtn');
      
      if (voiceEnabled) {
        button.textContent = '語音關閉';
        updateVoice('語音提示已開啟');
      } else {
        button.textContent = '語音開啟';
        window.speechSynthesis.cancel();
      }
    }

    function toggleDetectionMode() {
      detailedMode = !detailedMode;
      const button = document.getElementById('modeBtn');
      const modeText = document.getElementById('detectionMode');
      
      if (detailedMode) {
        button.textContent = '簡潔模式';
        modeText.textContent = '詳細模式';
        updateVoice('切換到詳細檢測模式');
      } else {
        button.textContent = '詳細模式';
        modeText.textContent = '簡潔模式';
        updateVoice('切換到簡潔檢測模式');
      }
    }

    function stopDetection() {
      isDetecting = false;
      updateDetectionStatus('已停止');
      const video = document.getElementById('video');
      if (video.srcObject) {
        video.srcObject.getTracks().forEach(track => track.stop());
      }
      updateVoice('檢測已停止');
    }

    /**********************
     * 8) 初始化
     **********************/
    window.addEventListener('DOMContentLoaded', function() {
      initModel();
    });

    // 防止頁面休眠
    let wakeLock = null;
    async function requestWakeLock() {
      try {
        if ('wakeLock' in navigator) {
          wakeLock = await navigator.wakeLock.request('screen');
        }
      } catch (err) {
        console.log('Wake Lock 失敗:', err.message);
      }
    }

    document.addEventListener('visibilitychange', async () => {
      if (document.visibilityState === 'visible' && isDetecting) {
        await requestWakeLock();
      }
    });

    requestWakeLock();
  </script>
</body>
</html>