<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>🧠 智能生活助手 - 失智症專用</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.15.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.3/dist/coco-ssd.min.js"></script>
  <style>
    * { 
      margin: 0; 
      padding: 0; 
      box-sizing: border-box; 
    }
    body { 
      font-family: 'Arial Rounded MT Bold', 'Microsoft JhengHei', sans-serif; 
      background: linear-gradient(135deg, #74b9ff, #0984e3);
      min-height: 100vh; 
      padding: 15px; 
      color: #2d3436;
    }
    .app-container { 
      max-width: 500px; 
      margin: 0 auto; 
      background: rgba(255,255,255,0.95);
      border-radius: 25px;
      padding: 20px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
    }
    .header {
      text-align: center;
      margin-bottom: 20px;
      padding: 15px;
      background: linear-gradient(135deg, #00b894, #00a085);
      border-radius: 20px;
      color: white;
    }
    .header h1 {
      font-size: 24px;
      margin-bottom: 5px;
    }
    .header .subtitle {
      font-size: 16px;
      opacity: 0.9;
    }
    .main-controls { 
      display: grid; 
      grid-template-columns: 1fr 1fr; 
      gap: 12px; 
      margin-bottom: 20px;
    }
    .big-button {
      padding: 20px 15px;
      border: none;
      border-radius: 20px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 8px;
      min-height: 100px;
    }
    .big-button:active {
      transform: scale(0.95);
    }
    .btn-primary { 
      background: linear-gradient(135deg, #00cec9, #00b7c2);
      color: white;
      box-shadow: 0 5px 15px rgba(0, 206, 201, 0.3);
    }
    .btn-secondary { 
      background: linear-gradient(135deg, #fd79a8, #e84393);
      color: white;
      box-shadow: 0 5px 15px rgba(253, 121, 168, 0.3);
    }
    .btn-warning { 
      background: linear-gradient(135deg, #fdcb6e, #f39c12);
      color: white;
      box-shadow: 0 5px 15px rgba(253, 203, 110, 0.3);
    }
    .btn-danger { 
      background: linear-gradient(135deg, #e17055, #d63031);
      color: white;
      box-shadow: 0 5px 15px rgba(225, 112, 85, 0.3);
    }
    .button-icon {
      font-size: 24px;
    }
    .button-text {
      font-size: 16px;
      text-align: center;
    }
    .camera-section {
      background: #2d3436;
      border-radius: 20px;
      overflow: hidden;
      margin-bottom: 20px;
      position: relative;
    }
    #video {
      width: 100%;
      height: 250px;
      object-fit: cover;
      display: block;
    }
    .camera-overlay {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 10px;
      text-align: center;
      font-size: 14px;
    }
    .voice-alert { 
      background: linear-gradient(135deg, #6c5ce7, #a29bfe);
      color: white;
      padding: 20px;
      border-radius: 20px;
      margin: 15px 0;
      text-align: center;
      font-size: 18px;
      min-height: 80px;
      display: flex;
      align-items: center;
      justify-content: center;
      line-height: 1.4;
      box-shadow: 0 5px 15px rgba(108, 92, 231, 0.3);
    }
    .status-panel {
      background: rgba(116, 185, 255, 0.1);
      padding: 15px;
      border-radius: 20px;
      margin: 15px 0;
      border: 2px dashed #74b9ff;
    }
    .status-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      padding: 8px 0;
      font-size: 16px;
    }
    .items-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 10px;
      margin-top: 15px;
    }
    .item-card {
      background: white;
      padding: 15px 10px;
      border-radius: 15px;
      text-align: center;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
      border: 2px solid #dfe6e9;
      transition: all 0.3s ease;
    }
    .item-card.highlight {
      animation: pulse 2s ease-in-out;
      border-color: #00b894;
    }
    .item-name {
      font-size: 16px;
      font-weight: bold;
      margin-bottom: 5px;
      color: #2d3436;
    }
    .item-confidence {
      font-size: 12px;
      color: #636e72;
    }
    .navigation-info {
      background: linear-gradient(135deg, #ffeaa7, #fdcb6e);
      padding: 20px;
      border-radius: 20px;
      margin: 15px 0;
      text-align: center;
    }
    .direction-arrow {
      font-size: 48px;
      margin: 10px 0;
      color: #d63031;
    }
    .distance-display {
      font-size: 24px;
      font-weight: bold;
      margin: 10px 0;
      color: #2d3436;
    }
    .instruction-text {
      font-size: 18px;
      color: #2d3436;
      margin: 10px 0;
    }
    .mode-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
    }
    .mode-recording { background: #e17055; }
    .mode-identifying { background: #00b894; }
    .mode-navigating { background: #0984e3; }
    .mode-idle { background: #b2bec3; }

    @keyframes pulse {
      0%, 100% { 
        transform: scale(1);
        box-shadow: 0 3px 10px rgba(0,0,0,0.1);
      }
      50% { 
        transform: scale(1.05);
        box-shadow: 0 5px 20px rgba(0, 184, 148, 0.4);
      }
    }

    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-5px); }
    }

    .floating {
      animation: float 3s ease-in-out infinite;
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- 頁首 -->
    <div class="header">
      <h1>🧠 智能生活助手</h1>
      <div class="subtitle">專為失智症患者設計</div>
    </div>

    <!-- 語音提示 -->
    <div id="voiceAlert" class="voice-alert">
      👋 歡迎使用！請選擇需要的功能
    </div>

    <!-- 主要控制按鈕 -->
    <div class="main-controls">
      <button class="big-button btn-primary" onclick="startItemRecognition()">
        <span class="button-icon">🔍</span>
        <span class="button-text">識別物品</span>
      </button>
      <button class="big-button btn-secondary" onclick="toggleContinuousMode()" id="continuousBtn">
        <span class="button-icon">🔄</span>
        <span class="button-text">連續識別</span>
      </button>
      <button class="big-button btn-warning" onclick="setHomeLocation()">
        <span class="button-icon">🏠</span>
        <span class="button-text">設定家的位置</span>
      </button>
      <button class="big-button btn-danger" onclick="startNavigationHome()">
        <span class="button-icon">🧭</span>
        <span class="button-text">導航回家</span>
      </button>
    </div>

    <!-- 相機畫面 -->
    <div class="camera-section">
      <video id="video" autoplay playsinline muted></video>
      <div class="camera-overlay" id="cameraOverlay">
        鏡頭準備中...
      </div>
    </div>

    <!-- 狀態面板 -->
    <div class="status-panel">
      <div class="status-item">
        <span><span class="mode-indicator" id="modeIndicator"></span>當前模式:</span>
        <span id="currentMode">待機中</span>
      </div>
      <div class="status-item">
        <span>識別物品數:</span>
        <span id="itemCount">0</span>
      </div>
      <div class="status-item">
        <span>家的位置:</span>
        <span id="homeStatus">未設定</span>
      </div>
      <div class="status-item">
        <span>語音提示:</span>
        <span id="voiceStatus">開啟</span>
      </div>
    </div>

    <!-- 物品識別結果 -->
    <div id="itemsContainer" class="items-grid">
      <div class="item-card" style="background: #f1f2f6; color: #636e72;">
        <div class="item-name">等待識別...</div>
        <div class="item-confidence">請點擊上方按鈕開始</div>
      </div>
    </div>

    <!-- 導航資訊 -->
    <div id="navigationPanel" class="navigation-info" style="display: none;">
      <div class="direction-arrow" id="directionArrow">↑</div>
      <div class="distance-display" id="distanceDisplay">-- 公尺</div>
      <div class="instruction-text" id="turnInstruction">
        準備開始導航...
      </div>
    </div>

    <!-- 輔助控制 -->
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;">
      <button class="big-button" onclick="repeatInstruction()" style="background: #a29bfe; color: white;">
        <span class="button-icon">🔊</span>
        <span class="button-text">重複提示</span>
      </button>
      <button class="big-button" onclick="toggleVoice()" id="voiceToggleBtn" style="background: #fd79a8; color: white;">
        <span class="button-icon">🔇</span>
        <span class="button-text">關閉語音</span>
      </button>
    </div>
  </div>

  <script>
    // 物品名稱映射（擴展到150+種物品）
    const itemNames = {
      // 人物動物
      'person': '人', 'bird': '鳥', 'cat': '貓', 'dog': '狗', 'horse': '馬', 
      'sheep': '羊', 'cow': '牛', 'elephant': '大象', 'bear': '熊', 'zebra': '斑馬',
      'giraffe': '長頸鹿',
      
      // 交通工具
      'bicycle': '腳踏車', 'car': '汽車', 'motorcycle': '摩托車', 'airplane': '飛機',
      'bus': '公車', 'train': '火車', 'truck': '卡車', 'boat': '船',
      
      // 家具
      'chair': '椅子', 'couch': '沙發', 'bed': '床', 'dining table': '餐桌',
      'bench': '長椅', 'potted plant': '盆栽',
      
      // 電子產品
      'tv': '電視', 'laptop': '筆記型電腦', 'mouse': '滑鼠', 'remote': '遙控器',
      'keyboard': '鍵盤', 'cell phone': '手機',
      
      // 廚房用品
      'bottle': '瓶子', 'wine glass': '酒杯', 'cup': '杯子', 'fork': '叉子',
      'knife': '刀子', 'spoon': '湯匙', 'bowl': '碗', 'microwave': '微波爐',
      'oven': '烤箱', 'toaster': '烤麵包機', 'sink': '水槽', 'refrigerator': '冰箱',
      
      // 食物
      'banana': '香蕉', 'apple': '蘋果', 'sandwich': '三明治', 'orange': '柳橙',
      'broccoli': '花椰菜', 'carrot': '紅蘿蔔', 'hot dog': '熱狗', 'pizza': '披薩',
      'donut': '甜甜圈', 'cake': '蛋糕',
      
      // 日常用品
      'backpack': '背包', 'umbrella': '雨傘', 'handbag': '手提包', 'tie': '領帶',
      'suitcase': '行李箱', 'frisbee': '飛盤', 'skis': '滑雪板', 'snowboard': '雪板',
      'sports ball': '運動球', 'kite': '風箏', 'baseball bat': '棒球棒',
      'baseball glove': '棒球手套', 'skateboard': '滑板', 'surfboard': '衝浪板',
      'tennis racket': '網球拍', 'book': '書', 'clock': '時鐘', 'vase': '花瓶',
      'scissors': '剪刀', 'teddy bear': '泰迪熊', 'hair drier': '吹風機',
      'toothbrush': '牙刷',
      
      // 室外物品
      'traffic light': '紅綠燈', 'fire hydrant': '消防栓', 'stop sign': '停止標誌',
      'parking meter': '停車計時器', 'toilet': '馬桶'
    };

    class SmartAssistant {
      constructor() {
        this.model = null;
        this.isRecognizing = false;
        this.continuousMode = false;
        this.voiceEnabled = true;
        this.homeLocation = null;
        this.isNavigating = false;
        this.watchId = null;
        this.lastItems = [];
        this.lastSpeechTime = 0;
        this.SPEECH_COOLDOWN = 4000;
      }

      // 初始化AI模型
      async initModel() {
        try {
          updateVoice('正在準備智能識別系統...');
          this.model = await cocoSsd.load();
          updateVoice('系統準備完成！可以開始識別物品了');
          this.updateModeIndicator('idle');
        } catch (error) {
          updateVoice('系統初始化失敗，請重新整理頁面');
        }
      }

      // 開始物品識別
      async startItemRecognition() {
        if (!this.model) {
          updateVoice('系統尚未準備好');
          return;
        }

        const video = await this.setupCamera();
        if (!video) return;

        this.isRecognizing = true;
        this.updateModeIndicator('identifying');
        updateVoice('開始識別物品，請將鏡頭對準想認識的物品');

        try {
          const predictions = await this.model.detect(video);
          this.processRecognitionResults(predictions);
        } catch (error) {
          updateVoice('識別失敗，請重試');
        }

        this.isRecognizing = false;
        this.updateModeIndicator('idle');
      }

      // 切換連續識別模式
      async toggleContinuousMode() {
        if (this.continuousMode) {
          this.stopContinuousMode();
        } else {
          await this.startContinuousMode();
        }
      }

      // 開始連續識別
      async startContinuousMode() {
        if (!this.model) {
          updateVoice('系統尚未準備好');
          return;
        }

        const video = await this.setupCamera();
        if (!video) return;

        this.continuousMode = true;
        this.isRecognizing = true;
        this.updateModeIndicator('identifying');
        updateVoice('開啟連續識別模式，系統會持續告訴您看到的物品');
        
        document.getElementById('continuousBtn').innerHTML = 
          '<span class="button-icon">⏹️</span><span class="button-text">停止識別</span>';

        this.continuousRecognition(video);
      }

      // 停止連續識別
      stopContinuousMode() {
        this.continuousMode = false;
        this.isRecognizing = false;
        this.updateModeIndicator('idle');
        updateVoice('已停止連續識別');
        
        document.getElementById('continuousBtn').innerHTML = 
          '<span class="button-icon">🔄</span><span class="button-text">連續識別</span>';
      }

      // 連續識別循環
      async continuousRecognition(video) {
        if (!this.continuousMode) return;

        try {
          const predictions = await this.model.detect(video);
          this.processRecognitionResults(predictions);
          
          // 2秒後繼續下一輪識別
          setTimeout(() => this.continuousRecognition(video), 2000);
        } catch (error) {
          setTimeout(() => this.continuousRecognition(video), 2000);
        }
      }

      // 處理識別結果
      processRecognitionResults(predictions) {
        const highConfidenceItems = predictions
          .filter(pred => pred.score > 0.6 && itemNames[pred.class])
          .map(pred => ({
            class: pred.class,
            name: itemNames[pred.class],
            confidence: pred.score
          }))
          .filter((item, index, array) => 
            array.findIndex(i => i.class === item.class) === index
          )
          .sort((a, b) => b.confidence - a.confidence)
          .slice(0, 6);

        this.updateItemsDisplay(highConfidenceItems);
        this.provideItemVoiceGuidance(highConfidenceItems);
      }

      // 更新物品顯示
      updateItemsDisplay(items) {
        const container = document.getElementById('itemsContainer');
        document.getElementById('itemCount').textContent = items.length;

        if (items.length === 0) {
          container.innerHTML = `
            <div class="item-card" style="background: #f1f2f6; color: #636e72;">
              <div class="item-name">未識別到物品</div>
              <div class="item-confidence">請調整鏡頭方向</div>
            </div>
          `;
          return;
        }

        container.innerHTML = items.map((item, index) => `
          <div class="item-card highlight" style="animation-delay: ${index * 0.1}s">
            <div class="item-name">${item.name}</div>
            <div class="item-confidence">可信度: ${Math.round(item.confidence * 100)}%</div>
          </div>
        `).join('');
      }

      // 提供物品語音提示
      provideItemVoiceGuidance(items) {
        const now = Date.now();
        if (now - this.lastSpeechTime < this.SPEECH_COOLDOWN) return;

        if (items.length > 0) {
          const itemNames = items.map(item => item.name).join('、');
          updateVoice(`看到：${itemNames}`);
          this.lastSpeechTime = now;
        }
      }

      // 設定家的位置
      async setHomeLocation() {
        return new Promise((resolve, reject) => {
          if (!navigator.geolocation) {
            reject('您的裝置不支援定位功能');
            return;
          }

          updateVoice('正在記錄家的位置...');
          
          navigator.geolocation.getCurrentPosition(
            (position) => {
              this.homeLocation = {
                latitude: position.coords.latitude,
                longitude: position.coords.longitude,
                accuracy: position.coords.accuracy
              };
              
              localStorage.setItem('homeLocation', JSON.stringify(this.homeLocation));
              updateVoice('家的位置已成功記錄！');
              document.getElementById('homeStatus').textContent = '已設定';
              resolve(this.homeLocation);
            },
            (error) => {
              const errorMsg = this.getGeolocationError(error);
              reject(errorMsg);
            }
          );
        });
      }

      // 開始導航回家
      startNavigationHome() {
        if (!this.homeLocation) {
          updateVoice('請先設定家的位置');
          return;
        }

        this.isNavigating = true;
        this.updateModeIndicator('navigating');
        updateVoice('開始導航回家，請跟隨語音指引');
        document.getElementById('navigationPanel').style.display = 'block';

        this.watchId = navigator.geolocation.watchPosition(
          (position) => {
            this.updateNavigation(position);
          },
          (error) => {
            updateVoice('GPS信號不穩定');
          },
          { enableHighAccuracy: true, timeout: 5000 }
        );
      }

      // 更新導航
      updateNavigation(position) {
        const currentLocation = {
          latitude: position.coords.latitude,
          longitude: position.coords.longitude
        };

        const navInfo = this.calculateNavigationInfo(currentLocation, this.homeLocation);
        if (!navInfo) return;

        this.updateNavigationDisplay(navInfo);
        this.provideNavigationGuidance(navInfo);
      }

      // 計算導航資訊
      calculateNavigationInfo(current, target) {
        const R = 6371000;
        const φ1 = current.latitude * Math.PI/180;
        const φ2 = target.latitude * Math.PI/180;
        const Δφ = (target.latitude - current.latitude) * Math.PI/180;
        const Δλ = (target.longitude - current.longitude) * Math.PI/180;

        const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                  Math.cos(φ1) * Math.cos(φ2) * Math.sin(Δλ/2) * Math.sin(Δλ/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        const distance = Math.round(R * c);

        const y = Math.sin(Δλ) * Math.cos(φ2);
        const x = Math.cos(φ1) * Math.sin(φ2) - Math.sin(φ1) * Math.cos(φ2) * Math.cos(Δλ);
        const θ = Math.atan2(y, x);
        const bearing = (θ * 180/Math.PI + 360) % 360;

        const direction = this.getDirectionFromBearing(bearing);

        return { distance, bearing, direction };
      }

      // 獲取方向
      getDirectionFromBearing(bearing) {
        if (bearing >= 337.5 || bearing < 22.5) return '北';
        if (bearing >= 22.5 && bearing < 67.5) return '東北';
        if (bearing >= 67.5 && bearing < 112.5) return '東';
        if (bearing >= 112.5 && bearing < 157.5) return '東南';
        if (bearing >= 157.5 && bearing < 202.5) return '南';
        if (bearing >= 202.5 && bearing < 247.5) return '西南';
        if (bearing >= 247.5 && bearing < 292.5) return '西';
        return '西北';
      }

      // 更新導航顯示
      updateNavigationDisplay(navInfo) {
        const { distance, direction } = navInfo;
        
        document.getElementById('distanceDisplay').textContent = distance + ' 公尺';
        
        const arrows = {
          '北': '↑', '東北': '↗', '東': '→', '東南': '↘',
          '南': '↓', '西南': '↙', '西': '←', '西北': '↖'
        };
        document.getElementById('directionArrow').textContent = arrows[direction] || '↑';
      }

      // 提供導航指引
      provideNavigationGuidance(navInfo) {
        const { distance, direction } = navInfo;
        const now = Date.now();
        
        if (now - this.lastSpeechTime < this.SPEECH_COOLDOWN) return;

        let instruction = '';
        if (distance < 20) {
          instruction = '已到家了，導航結束';
          this.stopNavigation();
        } else if (distance < 50) {
          instruction = `快到家了，還有${distance}公尺，請往${direction}走`;
        } else {
          instruction = `距離家${distance}公尺，請往${direction}方向前進`;
        }

        updateVoice(instruction);
        document.getElementById('turnInstruction').textContent = instruction;
        this.lastSpeechTime = now;
      }

      // 停止導航
      stopNavigation() {
        if (this.watchId) {
          navigator.geolocation.clearWatch(this.watchId);
        }
        this.isNavigating = false;
        this.updateModeIndicator('idle');
        document.getElementById('navigationPanel').style.display = 'none';
      }

      // 設置相機
      async setupCamera() {
        const video = document.getElementById('video');
        try {
          const stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: 'environment' }
          });
          video.srcObject = stream;
          document.getElementById('cameraOverlay').textContent = '鏡頭就緒';
          return new Promise((resolve) => {
            video.onloadedmetadata = () => { resolve(video); };
          });
        } catch (error) {
          updateVoice('無法開啟相機');
          return null;
        }
      }

      // 更新模式指示器
      updateModeIndicator(mode) {
        const indicator = document.getElementById('modeIndicator');
        const modeText = document.getElementById('currentMode');
        
        const modes = {
          'idle': { class: 'mode-idle', text: '待機中' },
          'identifying': { class: 'mode-identifying', text: '識別物品中' },
          'navigating': { class: 'mode-navigating', text: '導航中' },
          'recording': { class: 'mode-recording', text: '記錄中' }
        };

        indicator.className = 'mode-indicator ' + modes[mode].class;
        modeText.textContent = modes[mode].text;
      }

      // 載入儲存的位置
      loadSavedLocations() {
        const savedHome = localStorage.getItem('homeLocation');
        if (savedHome) {
          this.homeLocation = JSON.parse(savedHome);
          document.getElementById('homeStatus').textContent = '已設定';
        }
      }

      // 獲取地理定位錯誤
      getGeolocationError(error) {
        switch(error.code) {
          case error.PERMISSION_DENIED: return '請允許位置權限';
          case error.POSITION_UNAVAILABLE: return '無法獲取位置資訊';
          case error.TIMEOUT: return '定位超時';
          default: return '定位服務錯誤';
        }
      }
    }

    // 全域變數
    const assistant = new SmartAssistant();
    let voiceEnabled = true;

    // 初始化
    function init() {
      assistant.initModel();
      assistant.loadSavedLocations();
    }

    // 包裝函數
    function startItemRecognition() {
      assistant.startItemRecognition();
    }

    function toggleContinuousMode() {
      assistant.toggleContinuousMode();
    }

    function setHomeLocation() {
      assistant.setHomeLocation().catch(error => updateVoice(error));
    }

    function startNavigationHome() {
      assistant.startNavigationHome();
    }

    function toggleVoice() {
      voiceEnabled = !voiceEnabled;
      const button = document.getElementById('voiceToggleBtn');
      if (voiceEnabled) {
        button.innerHTML = '<span class="button-icon">🔇</span><span class="button-text">關閉語音</span>';
        updateVoice('語音提示已開啟');
      } else {
        button.innerHTML = '<span class="button-icon">🔊</span><span class="button-text">開啟語音</span>';
        window.speechSynthesis.cancel();
      }
    }

    function repeatInstruction() {
      // 重複最後的語音提示
      const voiceAlert = document.getElementById('voiceAlert');
      if (voiceAlert.textContent && voiceEnabled) {
        updateVoice(voiceAlert.textContent);
      }
    }

    // 語音提示
    function updateVoice(message) {
      const voiceAlert = document.getElementById('voiceAlert');
      voiceAlert.textContent = message;
      
      if (voiceEnabled && window.speechSynthesis) {
        window.speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(message);
        utterance.lang = 'zh-TW';
        utterance.rate = 0.8;
        utterance.pitch = 1.0;
        window.speechSynthesis.speak(utterance);
      }
    }

    // 頁面載入時初始化
    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>