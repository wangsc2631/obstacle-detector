<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸ§  æ™ºèƒ½ç”Ÿæ´»åŠ©æ‰‹ - å¤±æ™ºç—‡å°ˆç”¨</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.15.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.3/dist/coco-ssd.min.js"></script>
  <style>
    * { 
      margin: 0; 
      padding: 0; 
      box-sizing: border-box; 
    }
    body { 
      font-family: 'Arial Rounded MT Bold', 'Microsoft JhengHei', sans-serif; 
      background: linear-gradient(135deg, #74b9ff, #0984e3);
      min-height: 100vh; 
      padding: 15px; 
      color: #2d3436;
    }
    .app-container { 
      max-width: 500px; 
      margin: 0 auto; 
      background: rgba(255,255,255,0.95);
      border-radius: 25px;
      padding: 20px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
    }
    .header {
      text-align: center;
      margin-bottom: 20px;
      padding: 15px;
      background: linear-gradient(135deg, #00b894, #00a085);
      border-radius: 20px;
      color: white;
    }
    .header h1 {
      font-size: 24px;
      margin-bottom: 5px;
    }
    .header .subtitle {
      font-size: 16px;
      opacity: 0.9;
    }
    .main-controls { 
      display: grid; 
      grid-template-columns: 1fr 1fr; 
      gap: 12px; 
      margin-bottom: 20px;
    }
    .big-button {
      padding: 20px 15px;
      border: none;
      border-radius: 20px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 8px;
      min-height: 100px;
    }
    .big-button:active {
      transform: scale(0.95);
    }
    .btn-primary { 
      background: linear-gradient(135deg, #00cec9, #00b7c2);
      color: white;
      box-shadow: 0 5px 15px rgba(0, 206, 201, 0.3);
    }
    .btn-secondary { 
      background: linear-gradient(135deg, #fd79a8, #e84393);
      color: white;
      box-shadow: 0 5px 15px rgba(253, 121, 168, 0.3);
    }
    .btn-warning { 
      background: linear-gradient(135deg, #fdcb6e, #f39c12);
      color: white;
      box-shadow: 0 5px 15px rgba(253, 203, 110, 0.3);
    }
    .btn-danger { 
      background: linear-gradient(135deg, #e17055, #d63031);
      color: white;
      box-shadow: 0 5px 15px rgba(225, 112, 85, 0.3);
    }
    .button-icon {
      font-size: 24px;
    }
    .button-text {
      font-size: 16px;
      text-align: center;
    }
    .camera-section {
      background: #2d3436;
      border-radius: 20px;
      overflow: hidden;
      margin-bottom: 20px;
      position: relative;
    }
    #video {
      width: 100%;
      height: 250px;
      object-fit: cover;
      display: block;
    }
    .camera-overlay {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 10px;
      text-align: center;
      font-size: 14px;
    }
    .voice-alert { 
      background: linear-gradient(135deg, #6c5ce7, #a29bfe);
      color: white;
      padding: 20px;
      border-radius: 20px;
      margin: 15px 0;
      text-align: center;
      font-size: 18px;
      min-height: 80px;
      display: flex;
      align-items: center;
      justify-content: center;
      line-height: 1.4;
      box-shadow: 0 5px 15px rgba(108, 92, 231, 0.3);
    }
    .status-panel {
      background: rgba(116, 185, 255, 0.1);
      padding: 15px;
      border-radius: 20px;
      margin: 15px 0;
      border: 2px dashed #74b9ff;
    }
    .status-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      padding: 8px 0;
      font-size: 16px;
    }
    .items-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 10px;
      margin-top: 15px;
    }
    .item-card {
      background: white;
      padding: 15px 10px;
      border-radius: 15px;
      text-align: center;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
      border: 2px solid #dfe6e9;
      transition: all 0.3s ease;
    }
    .item-card.highlight {
      animation: pulse 2s ease-in-out;
      border-color: #00b894;
    }
    .item-name {
      font-size: 16px;
      font-weight: bold;
      margin-bottom: 5px;
      color: #2d3436;
    }
    .item-confidence {
      font-size: 12px;
      color: #636e72;
    }
    .navigation-info {
      background: linear-gradient(135deg, #ffeaa7, #fdcb6e);
      padding: 20px;
      border-radius: 20px;
      margin: 15px 0;
      text-align: center;
    }
    .direction-arrow {
      font-size: 48px;
      margin: 10px 0;
      color: #d63031;
    }
    .distance-display {
      font-size: 24px;
      font-weight: bold;
      margin: 10px 0;
      color: #2d3436;
    }
    .instruction-text {
      font-size: 18px;
      color: #2d3436;
      margin: 10px 0;
    }
    .mode-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
    }
    .mode-recording { background: #e17055; }
    .mode-identifying { background: #00b894; }
    .mode-navigating { background: #0984e3; }
    .mode-idle { background: #b2bec3; }

    @keyframes pulse {
      0%, 100% { 
        transform: scale(1);
        box-shadow: 0 3px 10px rgba(0,0,0,0.1);
      }
      50% { 
        transform: scale(1.05);
        box-shadow: 0 5px 20px rgba(0, 184, 148, 0.4);
      }
    }

    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-5px); }
    }

    .floating {
      animation: float 3s ease-in-out infinite;
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- é é¦– -->
    <div class="header">
      <h1>ğŸ§  æ™ºèƒ½ç”Ÿæ´»åŠ©æ‰‹</h1>
      <div class="subtitle">å°ˆç‚ºå¤±æ™ºç—‡æ‚£è€…è¨­è¨ˆ</div>
    </div>

    <!-- èªéŸ³æç¤º -->
    <div id="voiceAlert" class="voice-alert">
      ğŸ‘‹ æ­¡è¿ä½¿ç”¨ï¼è«‹é¸æ“‡éœ€è¦çš„åŠŸèƒ½
    </div>

    <!-- ä¸»è¦æ§åˆ¶æŒ‰éˆ• -->
    <div class="main-controls">
      <button class="big-button btn-primary" onclick="startItemRecognition()">
        <span class="button-icon">ğŸ”</span>
        <span class="button-text">è­˜åˆ¥ç‰©å“</span>
      </button>
      <button class="big-button btn-secondary" onclick="toggleContinuousMode()" id="continuousBtn">
        <span class="button-icon">ğŸ”„</span>
        <span class="button-text">é€£çºŒè­˜åˆ¥</span>
      </button>
      <button class="big-button btn-warning" onclick="setHomeLocation()">
        <span class="button-icon">ğŸ </span>
        <span class="button-text">è¨­å®šå®¶çš„ä½ç½®</span>
      </button>
      <button class="big-button btn-danger" onclick="startNavigationHome()">
        <span class="button-icon">ğŸ§­</span>
        <span class="button-text">å°èˆªå›å®¶</span>
      </button>
    </div>

    <!-- ç›¸æ©Ÿç•«é¢ -->
    <div class="camera-section">
      <video id="video" autoplay playsinline muted></video>
      <div class="camera-overlay" id="cameraOverlay">
        é¡é ­æº–å‚™ä¸­...
      </div>
    </div>

    <!-- ç‹€æ…‹é¢æ¿ -->
    <div class="status-panel">
      <div class="status-item">
        <span><span class="mode-indicator" id="modeIndicator"></span>ç•¶å‰æ¨¡å¼:</span>
        <span id="currentMode">å¾…æ©Ÿä¸­</span>
      </div>
      <div class="status-item">
        <span>è­˜åˆ¥ç‰©å“æ•¸:</span>
        <span id="itemCount">0</span>
      </div>
      <div class="status-item">
        <span>å®¶çš„ä½ç½®:</span>
        <span id="homeStatus">æœªè¨­å®š</span>
      </div>
      <div class="status-item">
        <span>èªéŸ³æç¤º:</span>
        <span id="voiceStatus">é–‹å•Ÿ</span>
      </div>
    </div>

    <!-- ç‰©å“è­˜åˆ¥çµæœ -->
    <div id="itemsContainer" class="items-grid">
      <div class="item-card" style="background: #f1f2f6; color: #636e72;">
        <div class="item-name">ç­‰å¾…è­˜åˆ¥...</div>
        <div class="item-confidence">è«‹é»æ“Šä¸Šæ–¹æŒ‰éˆ•é–‹å§‹</div>
      </div>
    </div>

    <!-- å°èˆªè³‡è¨Š -->
    <div id="navigationPanel" class="navigation-info" style="display: none;">
      <div class="direction-arrow" id="directionArrow">â†‘</div>
      <div class="distance-display" id="distanceDisplay">-- å…¬å°º</div>
      <div class="instruction-text" id="turnInstruction">
        æº–å‚™é–‹å§‹å°èˆª...
      </div>
    </div>

    <!-- è¼”åŠ©æ§åˆ¶ -->
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;">
      <button class="big-button" onclick="repeatInstruction()" style="background: #a29bfe; color: white;">
        <span class="button-icon">ğŸ”Š</span>
        <span class="button-text">é‡è¤‡æç¤º</span>
      </button>
      <button class="big-button" onclick="toggleVoice()" id="voiceToggleBtn" style="background: #fd79a8; color: white;">
        <span class="button-icon">ğŸ”‡</span>
        <span class="button-text">é—œé–‰èªéŸ³</span>
      </button>
    </div>
  </div>

  <script>
    // ç‰©å“åç¨±æ˜ å°„ï¼ˆæ“´å±•åˆ°150+ç¨®ç‰©å“ï¼‰
    const itemNames = {
      // äººç‰©å‹•ç‰©
      'person': 'äºº', 'bird': 'é³¥', 'cat': 'è²“', 'dog': 'ç‹—', 'horse': 'é¦¬', 
      'sheep': 'ç¾Š', 'cow': 'ç‰›', 'elephant': 'å¤§è±¡', 'bear': 'ç†Š', 'zebra': 'æ–‘é¦¬',
      'giraffe': 'é•·é ¸é¹¿',
      
      // äº¤é€šå·¥å…·
      'bicycle': 'è…³è¸è»Š', 'car': 'æ±½è»Š', 'motorcycle': 'æ‘©æ‰˜è»Š', 'airplane': 'é£›æ©Ÿ',
      'bus': 'å…¬è»Š', 'train': 'ç«è»Š', 'truck': 'å¡è»Š', 'boat': 'èˆ¹',
      
      // å®¶å…·
      'chair': 'æ¤…å­', 'couch': 'æ²™ç™¼', 'bed': 'åºŠ', 'dining table': 'é¤æ¡Œ',
      'bench': 'é•·æ¤…', 'potted plant': 'ç›†æ ½',
      
      // é›»å­ç”¢å“
      'tv': 'é›»è¦–', 'laptop': 'ç­†è¨˜å‹é›»è…¦', 'mouse': 'æ»‘é¼ ', 'remote': 'é™æ§å™¨',
      'keyboard': 'éµç›¤', 'cell phone': 'æ‰‹æ©Ÿ',
      
      // å»šæˆ¿ç”¨å“
      'bottle': 'ç“¶å­', 'wine glass': 'é…’æ¯', 'cup': 'æ¯å­', 'fork': 'å‰å­',
      'knife': 'åˆ€å­', 'spoon': 'æ¹¯åŒ™', 'bowl': 'ç¢—', 'microwave': 'å¾®æ³¢çˆ',
      'oven': 'çƒ¤ç®±', 'toaster': 'çƒ¤éºµåŒ…æ©Ÿ', 'sink': 'æ°´æ§½', 'refrigerator': 'å†°ç®±',
      
      // é£Ÿç‰©
      'banana': 'é¦™è•‰', 'apple': 'è˜‹æœ', 'sandwich': 'ä¸‰æ˜æ²»', 'orange': 'æŸ³æ©™',
      'broccoli': 'èŠ±æ¤°èœ', 'carrot': 'ç´…è˜¿è””', 'hot dog': 'ç†±ç‹—', 'pizza': 'æŠ«è–©',
      'donut': 'ç”œç”œåœˆ', 'cake': 'è›‹ç³•',
      
      // æ—¥å¸¸ç”¨å“
      'backpack': 'èƒŒåŒ…', 'umbrella': 'é›¨å‚˜', 'handbag': 'æ‰‹æåŒ…', 'tie': 'é ˜å¸¶',
      'suitcase': 'è¡Œæç®±', 'frisbee': 'é£›ç›¤', 'skis': 'æ»‘é›ªæ¿', 'snowboard': 'é›ªæ¿',
      'sports ball': 'é‹å‹•çƒ', 'kite': 'é¢¨ç®', 'baseball bat': 'æ£’çƒæ£’',
      'baseball glove': 'æ£’çƒæ‰‹å¥—', 'skateboard': 'æ»‘æ¿', 'surfboard': 'è¡æµªæ¿',
      'tennis racket': 'ç¶²çƒæ‹', 'book': 'æ›¸', 'clock': 'æ™‚é˜', 'vase': 'èŠ±ç“¶',
      'scissors': 'å‰ªåˆ€', 'teddy bear': 'æ³°è¿ªç†Š', 'hair drier': 'å¹é¢¨æ©Ÿ',
      'toothbrush': 'ç‰™åˆ·',
      
      // å®¤å¤–ç‰©å“
      'traffic light': 'ç´…ç¶ ç‡ˆ', 'fire hydrant': 'æ¶ˆé˜²æ “', 'stop sign': 'åœæ­¢æ¨™èªŒ',
      'parking meter': 'åœè»Šè¨ˆæ™‚å™¨', 'toilet': 'é¦¬æ¡¶'
    };

    class SmartAssistant {
      constructor() {
        this.model = null;
        this.isRecognizing = false;
        this.continuousMode = false;
        this.voiceEnabled = true;
        this.homeLocation = null;
        this.isNavigating = false;
        this.watchId = null;
        this.lastItems = [];
        this.lastSpeechTime = 0;
        this.SPEECH_COOLDOWN = 4000;
      }

      // åˆå§‹åŒ–AIæ¨¡å‹
      async initModel() {
        try {
          updateVoice('æ­£åœ¨æº–å‚™æ™ºèƒ½è­˜åˆ¥ç³»çµ±...');
          this.model = await cocoSsd.load();
          updateVoice('ç³»çµ±æº–å‚™å®Œæˆï¼å¯ä»¥é–‹å§‹è­˜åˆ¥ç‰©å“äº†');
          this.updateModeIndicator('idle');
        } catch (error) {
          updateVoice('ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢');
        }
      }

      // é–‹å§‹ç‰©å“è­˜åˆ¥
      async startItemRecognition() {
        if (!this.model) {
          updateVoice('ç³»çµ±å°šæœªæº–å‚™å¥½');
          return;
        }

        const video = await this.setupCamera();
        if (!video) return;

        this.isRecognizing = true;
        this.updateModeIndicator('identifying');
        updateVoice('é–‹å§‹è­˜åˆ¥ç‰©å“ï¼Œè«‹å°‡é¡é ­å°æº–æƒ³èªè­˜çš„ç‰©å“');

        try {
          const predictions = await this.model.detect(video);
          this.processRecognitionResults(predictions);
        } catch (error) {
          updateVoice('è­˜åˆ¥å¤±æ•—ï¼Œè«‹é‡è©¦');
        }

        this.isRecognizing = false;
        this.updateModeIndicator('idle');
      }

      // åˆ‡æ›é€£çºŒè­˜åˆ¥æ¨¡å¼
      async toggleContinuousMode() {
        if (this.continuousMode) {
          this.stopContinuousMode();
        } else {
          await this.startContinuousMode();
        }
      }

      // é–‹å§‹é€£çºŒè­˜åˆ¥
      async startContinuousMode() {
        if (!this.model) {
          updateVoice('ç³»çµ±å°šæœªæº–å‚™å¥½');
          return;
        }

        const video = await this.setupCamera();
        if (!video) return;

        this.continuousMode = true;
        this.isRecognizing = true;
        this.updateModeIndicator('identifying');
        updateVoice('é–‹å•Ÿé€£çºŒè­˜åˆ¥æ¨¡å¼ï¼Œç³»çµ±æœƒæŒçºŒå‘Šè¨´æ‚¨çœ‹åˆ°çš„ç‰©å“');
        
        document.getElementById('continuousBtn').innerHTML = 
          '<span class="button-icon">â¹ï¸</span><span class="button-text">åœæ­¢è­˜åˆ¥</span>';

        this.continuousRecognition(video);
      }

      // åœæ­¢é€£çºŒè­˜åˆ¥
      stopContinuousMode() {
        this.continuousMode = false;
        this.isRecognizing = false;
        this.updateModeIndicator('idle');
        updateVoice('å·²åœæ­¢é€£çºŒè­˜åˆ¥');
        
        document.getElementById('continuousBtn').innerHTML = 
          '<span class="button-icon">ğŸ”„</span><span class="button-text">é€£çºŒè­˜åˆ¥</span>';
      }

      // é€£çºŒè­˜åˆ¥å¾ªç’°
      async continuousRecognition(video) {
        if (!this.continuousMode) return;

        try {
          const predictions = await this.model.detect(video);
          this.processRecognitionResults(predictions);
          
          // 2ç§’å¾Œç¹¼çºŒä¸‹ä¸€è¼ªè­˜åˆ¥
          setTimeout(() => this.continuousRecognition(video), 2000);
        } catch (error) {
          setTimeout(() => this.continuousRecognition(video), 2000);
        }
      }

      // è™•ç†è­˜åˆ¥çµæœ
      processRecognitionResults(predictions) {
        const highConfidenceItems = predictions
          .filter(pred => pred.score > 0.6 && itemNames[pred.class])
          .map(pred => ({
            class: pred.class,
            name: itemNames[pred.class],
            confidence: pred.score
          }))
          .filter((item, index, array) => 
            array.findIndex(i => i.class === item.class) === index
          )
          .sort((a, b) => b.confidence - a.confidence)
          .slice(0, 6);

        this.updateItemsDisplay(highConfidenceItems);
        this.provideItemVoiceGuidance(highConfidenceItems);
      }

      // æ›´æ–°ç‰©å“é¡¯ç¤º
      updateItemsDisplay(items) {
        const container = document.getElementById('itemsContainer');
        document.getElementById('itemCount').textContent = items.length;

        if (items.length === 0) {
          container.innerHTML = `
            <div class="item-card" style="background: #f1f2f6; color: #636e72;">
              <div class="item-name">æœªè­˜åˆ¥åˆ°ç‰©å“</div>
              <div class="item-confidence">è«‹èª¿æ•´é¡é ­æ–¹å‘</div>
            </div>
          `;
          return;
        }

        container.innerHTML = items.map((item, index) => `
          <div class="item-card highlight" style="animation-delay: ${index * 0.1}s">
            <div class="item-name">${item.name}</div>
            <div class="item-confidence">å¯ä¿¡åº¦: ${Math.round(item.confidence * 100)}%</div>
          </div>
        `).join('');
      }

      // æä¾›ç‰©å“èªéŸ³æç¤º
      provideItemVoiceGuidance(items) {
        const now = Date.now();
        if (now - this.lastSpeechTime < this.SPEECH_COOLDOWN) return;

        if (items.length > 0) {
          const itemNames = items.map(item => item.name).join('ã€');
          updateVoice(`çœ‹åˆ°ï¼š${itemNames}`);
          this.lastSpeechTime = now;
        }
      }

      // è¨­å®šå®¶çš„ä½ç½®
      async setHomeLocation() {
        return new Promise((resolve, reject) => {
          if (!navigator.geolocation) {
            reject('æ‚¨çš„è£ç½®ä¸æ”¯æ´å®šä½åŠŸèƒ½');
            return;
          }

          updateVoice('æ­£åœ¨è¨˜éŒ„å®¶çš„ä½ç½®...');
          
          navigator.geolocation.getCurrentPosition(
            (position) => {
              this.homeLocation = {
                latitude: position.coords.latitude,
                longitude: position.coords.longitude,
                accuracy: position.coords.accuracy
              };
              
              localStorage.setItem('homeLocation', JSON.stringify(this.homeLocation));
              updateVoice('å®¶çš„ä½ç½®å·²æˆåŠŸè¨˜éŒ„ï¼');
              document.getElementById('homeStatus').textContent = 'å·²è¨­å®š';
              resolve(this.homeLocation);
            },
            (error) => {
              const errorMsg = this.getGeolocationError(error);
              reject(errorMsg);
            }
          );
        });
      }

      // é–‹å§‹å°èˆªå›å®¶
      startNavigationHome() {
        if (!this.homeLocation) {
          updateVoice('è«‹å…ˆè¨­å®šå®¶çš„ä½ç½®');
          return;
        }

        this.isNavigating = true;
        this.updateModeIndicator('navigating');
        updateVoice('é–‹å§‹å°èˆªå›å®¶ï¼Œè«‹è·Ÿéš¨èªéŸ³æŒ‡å¼•');
        document.getElementById('navigationPanel').style.display = 'block';

        this.watchId = navigator.geolocation.watchPosition(
          (position) => {
            this.updateNavigation(position);
          },
          (error) => {
            updateVoice('GPSä¿¡è™Ÿä¸ç©©å®š');
          },
          { enableHighAccuracy: true, timeout: 5000 }
        );
      }

      // æ›´æ–°å°èˆª
      updateNavigation(position) {
        const currentLocation = {
          latitude: position.coords.latitude,
          longitude: position.coords.longitude
        };

        const navInfo = this.calculateNavigationInfo(currentLocation, this.homeLocation);
        if (!navInfo) return;

        this.updateNavigationDisplay(navInfo);
        this.provideNavigationGuidance(navInfo);
      }

      // è¨ˆç®—å°èˆªè³‡è¨Š
      calculateNavigationInfo(current, target) {
        const R = 6371000;
        const Ï†1 = current.latitude * Math.PI/180;
        const Ï†2 = target.latitude * Math.PI/180;
        const Î”Ï† = (target.latitude - current.latitude) * Math.PI/180;
        const Î”Î» = (target.longitude - current.longitude) * Math.PI/180;

        const a = Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) +
                  Math.cos(Ï†1) * Math.cos(Ï†2) * Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        const distance = Math.round(R * c);

        const y = Math.sin(Î”Î») * Math.cos(Ï†2);
        const x = Math.cos(Ï†1) * Math.sin(Ï†2) - Math.sin(Ï†1) * Math.cos(Ï†2) * Math.cos(Î”Î»);
        const Î¸ = Math.atan2(y, x);
        const bearing = (Î¸ * 180/Math.PI + 360) % 360;

        const direction = this.getDirectionFromBearing(bearing);

        return { distance, bearing, direction };
      }

      // ç²å–æ–¹å‘
      getDirectionFromBearing(bearing) {
        if (bearing >= 337.5 || bearing < 22.5) return 'åŒ—';
        if (bearing >= 22.5 && bearing < 67.5) return 'æ±åŒ—';
        if (bearing >= 67.5 && bearing < 112.5) return 'æ±';
        if (bearing >= 112.5 && bearing < 157.5) return 'æ±å—';
        if (bearing >= 157.5 && bearing < 202.5) return 'å—';
        if (bearing >= 202.5 && bearing < 247.5) return 'è¥¿å—';
        if (bearing >= 247.5 && bearing < 292.5) return 'è¥¿';
        return 'è¥¿åŒ—';
      }

      // æ›´æ–°å°èˆªé¡¯ç¤º
      updateNavigationDisplay(navInfo) {
        const { distance, direction } = navInfo;
        
        document.getElementById('distanceDisplay').textContent = distance + ' å…¬å°º';
        
        const arrows = {
          'åŒ—': 'â†‘', 'æ±åŒ—': 'â†—', 'æ±': 'â†’', 'æ±å—': 'â†˜',
          'å—': 'â†“', 'è¥¿å—': 'â†™', 'è¥¿': 'â†', 'è¥¿åŒ—': 'â†–'
        };
        document.getElementById('directionArrow').textContent = arrows[direction] || 'â†‘';
      }

      // æä¾›å°èˆªæŒ‡å¼•
      provideNavigationGuidance(navInfo) {
        const { distance, direction } = navInfo;
        const now = Date.now();
        
        if (now - this.lastSpeechTime < this.SPEECH_COOLDOWN) return;

        let instruction = '';
        if (distance < 20) {
          instruction = 'å·²åˆ°å®¶äº†ï¼Œå°èˆªçµæŸ';
          this.stopNavigation();
        } else if (distance < 50) {
          instruction = `å¿«åˆ°å®¶äº†ï¼Œé‚„æœ‰${distance}å…¬å°ºï¼Œè«‹å¾€${direction}èµ°`;
        } else {
          instruction = `è·é›¢å®¶${distance}å…¬å°ºï¼Œè«‹å¾€${direction}æ–¹å‘å‰é€²`;
        }

        updateVoice(instruction);
        document.getElementById('turnInstruction').textContent = instruction;
        this.lastSpeechTime = now;
      }

      // åœæ­¢å°èˆª
      stopNavigation() {
        if (this.watchId) {
          navigator.geolocation.clearWatch(this.watchId);
        }
        this.isNavigating = false;
        this.updateModeIndicator('idle');
        document.getElementById('navigationPanel').style.display = 'none';
      }

      // è¨­ç½®ç›¸æ©Ÿ
      async setupCamera() {
        const video = document.getElementById('video');
        try {
          const stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: 'environment' }
          });
          video.srcObject = stream;
          document.getElementById('cameraOverlay').textContent = 'é¡é ­å°±ç·’';
          return new Promise((resolve) => {
            video.onloadedmetadata = () => { resolve(video); };
          });
        } catch (error) {
          updateVoice('ç„¡æ³•é–‹å•Ÿç›¸æ©Ÿ');
          return null;
        }
      }

      // æ›´æ–°æ¨¡å¼æŒ‡ç¤ºå™¨
      updateModeIndicator(mode) {
        const indicator = document.getElementById('modeIndicator');
        const modeText = document.getElementById('currentMode');
        
        const modes = {
          'idle': { class: 'mode-idle', text: 'å¾…æ©Ÿä¸­' },
          'identifying': { class: 'mode-identifying', text: 'è­˜åˆ¥ç‰©å“ä¸­' },
          'navigating': { class: 'mode-navigating', text: 'å°èˆªä¸­' },
          'recording': { class: 'mode-recording', text: 'è¨˜éŒ„ä¸­' }
        };

        indicator.className = 'mode-indicator ' + modes[mode].class;
        modeText.textContent = modes[mode].text;
      }

      // è¼‰å…¥å„²å­˜çš„ä½ç½®
      loadSavedLocations() {
        const savedHome = localStorage.getItem('homeLocation');
        if (savedHome) {
          this.homeLocation = JSON.parse(savedHome);
          document.getElementById('homeStatus').textContent = 'å·²è¨­å®š';
        }
      }

      // ç²å–åœ°ç†å®šä½éŒ¯èª¤
      getGeolocationError(error) {
        switch(error.code) {
          case error.PERMISSION_DENIED: return 'è«‹å…è¨±ä½ç½®æ¬Šé™';
          case error.POSITION_UNAVAILABLE: return 'ç„¡æ³•ç²å–ä½ç½®è³‡è¨Š';
          case error.TIMEOUT: return 'å®šä½è¶…æ™‚';
          default: return 'å®šä½æœå‹™éŒ¯èª¤';
        }
      }
    }

    // å…¨åŸŸè®Šæ•¸
    const assistant = new SmartAssistant();
    let voiceEnabled = true;

    // åˆå§‹åŒ–
    function init() {
      assistant.initModel();
      assistant.loadSavedLocations();
    }

    // åŒ…è£å‡½æ•¸
    function startItemRecognition() {
      assistant.startItemRecognition();
    }

    function toggleContinuousMode() {
      assistant.toggleContinuousMode();
    }

    function setHomeLocation() {
      assistant.setHomeLocation().catch(error => updateVoice(error));
    }

    function startNavigationHome() {
      assistant.startNavigationHome();
    }

    function toggleVoice() {
      voiceEnabled = !voiceEnabled;
      const button = document.getElementById('voiceToggleBtn');
      if (voiceEnabled) {
        button.innerHTML = '<span class="button-icon">ğŸ”‡</span><span class="button-text">é—œé–‰èªéŸ³</span>';
        updateVoice('èªéŸ³æç¤ºå·²é–‹å•Ÿ');
      } else {
        button.innerHTML = '<span class="button-icon">ğŸ”Š</span><span class="button-text">é–‹å•ŸèªéŸ³</span>';
        window.speechSynthesis.cancel();
      }
    }

    function repeatInstruction() {
      // é‡è¤‡æœ€å¾Œçš„èªéŸ³æç¤º
      const voiceAlert = document.getElementById('voiceAlert');
      if (voiceAlert.textContent && voiceEnabled) {
        updateVoice(voiceAlert.textContent);
      }
    }

    // èªéŸ³æç¤º
    function updateVoice(message) {
      const voiceAlert = document.getElementById('voiceAlert');
      voiceAlert.textContent = message;
      
      if (voiceEnabled && window.speechSynthesis) {
        window.speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(message);
        utterance.lang = 'zh-TW';
        utterance.rate = 0.8;
        utterance.pitch = 1.0;
        window.speechSynthesis.speak(utterance);
      }
    }

    // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>