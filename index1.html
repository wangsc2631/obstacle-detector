<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="theme-color" content="#0ea5e9" />
  <meta name="description" content="盲人輔助導航系統 - 即時障礙物檢測" />
  <title>🧭 盲人輔助導航系統</title>
  
  <style>
    :root {
      --bg1: #0ea5e9;
      --bg2: #6366f1;
      --glass: rgba(255,255,255,0.12);
      --glass-strong: rgba(255,255,255,0.22);
      --text: #fff;
      --good: #22c55e;
      --warn: #f59e0b;
      --bad: #ef4444;
      --muted: #cbd5e1;
    }
    
    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      overflow-x: hidden;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      color: var(--text);
      background: linear-gradient(135deg, var(--bg1), var(--bg2));
      touch-action: manipulation;
    }
    
    body {
      padding: 10px;
      padding-bottom: env(safe-area-inset-bottom, 10px);
    }
    
    .app {
      max-width: 100%;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .card {
      background: var(--glass);
      backdrop-filter: blur(12px);
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    }
    
    .camera-container {
      position: relative;
      width: 100%;
      aspect-ratio: 16/9;
      background: #000;
      border-radius: 12px;
      overflow: hidden;
    }
    
    .camera-container video {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 12px;
      transform: scaleX(-1);
    }
    
    .camera-preview {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #000;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 16px;
      z-index: 5;
      text-align: center;
      padding: 20px;
    }
    
    .controls {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-bottom: 15px;
    }
    
    button {
      padding: 16px 12px;
      border: none;
      border-radius: 14px;
      font-weight: 700;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
      min-height: 54px;
      user-select: none;
    }
    
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    button:active:not(:disabled) {
      transform: translateY(2px) scale(0.98);
    }
    
    .btn-primary {
      background: var(--good);
      color: #fff;
    }
    
    .btn-danger {
      background: var(--bad);
      color: #fff;
    }
    
    .btn-secondary {
      background: var(--glass-strong);
      color: var(--text);
    }
    
    .status-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin-bottom: 12px;
    }
    
    .status-item {
      background: var(--glass-strong);
      border-radius: 12px;
      padding: 12px;
      text-align: center;
    }
    
    .status-label {
      font-size: 11px;
      color: var(--muted);
      margin-bottom: 4px;
    }
    
    .status-value {
      font-weight: 800;
      font-size: 16px;
    }
    
    .voice-alert {
      background: rgba(239,68,68,0.15);
      border: 1px solid rgba(239,68,68,0.35);
      color: #fff;
      border-radius: 12px;
      padding: 16px;
      text-align: center;
      min-height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      margin-bottom: 15px;
    }
    
    .detection-list {
      max-height: 200px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    
    .detection-item {
      background: var(--glass-strong);
      padding: 10px;
      border-radius: 10px;
      font-size: 13px;
    }
    
    .debug-info {
      background: rgba(0,0,0,0.8);
      color: #00ff00;
      padding: 8px;
      border-radius: 5px;
      font-size: 12px;
      margin-top: 8px;
      font-family: monospace;
    }
    
    .loading {
      background: linear-gradient(90deg, var(--bg1), var(--bg2), var(--bg1));
      background-size: 200% 100%;
      animation: loading 2s infinite;
    }
    
    @keyframes loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- 標題 -->
    <div class="card">
      <h1 style="margin:0; text-align:center;">🧭 盲人輔助導航</h1>
      <p style="text-align:center; margin:8px 0 0 0; color:var(--muted); font-size:14px;">無需AI模型的簡易版本</p>
    </div>

    <!-- 相機畫面 -->
    <div class="card">
      <div class="camera-container">
        <div id="cameraPreview" class="camera-preview">
          <div>
            <div style="font-size:48px; margin-bottom:10px;">📷</div>
            <div>點擊「開啟相機」開始使用</div>
            <div style="font-size:12px; margin-top:10px; color:var(--muted);">
              此版本使用簡易距離檢測，無需AI模型
            </div>
          </div>
        </div>
        <video id="video" autoplay playsinline muted></video>
      </div>
    </div>

    <!-- 控制面板 -->
    <div class="card">
      <div id="voiceAlert" class="voice-alert">系統準備中…</div>
      
      <div class="controls">
        <button id="btnCamera" class="btn-primary">開啟相機</button>
        <button id="btnStart" class="btn-primary" disabled>開始檢測</button>
        <button id="btnTest" class="btn-secondary" disabled>測試功能</button>
        <button id="btnStop" class="btn-danger" disabled>停止</button>
      </div>

      <div class="status-grid">
        <div class="status-item">
          <div class="status-label">系統狀態</div>
          <div class="status-value" id="status">準備中</div>
        </div>
        <div class="status-item">
          <div class="status-label">檢測模式</div>
          <div class="status-value" id="detectionMode">簡易模式</div>
        </div>
        <div class="status-item">
          <div class="status-label">相機狀態</div>
          <div class="status-value" id="cameraStatus">未開啟</div>
        </div>
        <div class="status-item">
          <div class="status-label">檢測狀態</div>
          <div class="status-value" id="detectionStatus">未開始</div>
        </div>
      </div>

      <div id="debugInfo" class="debug-info" style="display:none;"></div>
    </div>

    <!-- 檢測結果 -->
    <div class="card">
      <h3 style="margin:0 0 12px 0;">障礙物檢測</h3>
      <div id="detectionList" class="detection-list">
        <div class="detection-item" style="text-align:center; color:var(--muted);">
          等待開始偵測…
        </div>
      </div>
    </div>

    <!-- 使用說明 -->
    <div class="card">
      <h4 style="margin:0 0 8px 0;">使用說明</h4>
      <div style="font-size:12px; color:var(--muted); line-height:1.4;">
        <div>1. 點擊「開啟相機」授權相機使用</div>
        <div>2. 點擊「開始檢測」啟動障礙物偵測</div>
        <div>3. 將手機對準前方，系統會估算距離</div>
        <div>4. 聽到語音警告時請停止移動</div>
      </div>
    </div>
  </div>

  <script>
    // 狀態變數
    let isDetecting = false;
    let currentStream = null;
    let detectionInterval = null;
    let lastDetectionTime = 0;

    // 初始化
    function init() {
      updateStatus('準備就緒');
      updateVoice('系統準備完成，請開啟相機開始使用');
      initEventListeners();
      
      // 顯示除錯信息（可選）
      showDebugInfo('簡易模式已啟動 - 使用超聲波模擬檢測');
    }

    function initEventListeners() {
      document.getElementById('btnCamera').addEventListener('click', setupCamera);
      document.getElementById('btnStart').addEventListener('click', startDetection);
      document.getElementById('btnTest').addEventListener('click', testDetection);
      document.getElementById('btnStop').addEventListener('click', stopDetection);
    }

    // 相機設置
    async function setupCamera() {
      try {
        updateVoice('正在開啟相機…');
        updateCameraStatus('開啟中');
        
        // 停止之前的串流
        if (currentStream) {
          currentStream.getTracks().forEach(track => track.stop());
        }
        
        const video = document.getElementById('video');
        const preview = document.getElementById('cameraPreview');
        
        // 請求相機權限
        const stream = await navigator.mediaDevices.getUserMedia({
          video: {
            width: { ideal: 640 },
            height: { ideal: 480 },
            facingMode: 'environment'
          },
          audio: false
        });
        
        currentStream = stream;
        video.srcObject = stream;
        
        // 等待影片載入
        await new Promise((resolve) => {
          video.onloadedmetadata = () => resolve(video);
        });
        
        await video.play();
        
        // 隱藏預覽畫面
        preview.style.display = 'none';
        
        // 啟用按鈕
        document.getElementById('btnStart').disabled = false;
        document.getElementById('btnTest').disabled = false;
        document.getElementById('btnStop').disabled = false;
        
        updateCameraStatus('已開啟');
        updateVoice('相機開啟成功！可以開始檢測');
        
        showDebugInfo('相機開啟成功 - 分辨率: ' + video.videoWidth + 'x' + video.videoHeight);
        
      } catch (error) {
        console.error('相機開啟失敗:', error);
        updateCameraStatus('開啟失敗');
        
        let errorMsg = '無法開啟相機：';
        if (error.name === 'NotAllowedError') {
          errorMsg += '請允許相機權限';
        } else if (error.name === 'NotFoundError') {
          errorMsg += '未找到相機設備';
        } else {
          errorMsg += error.message;
        }
        
        updateVoice(errorMsg);
      }
    }

    // 開始檢測
    function startDetection() {
      const video = document.getElementById('video');
      if (!video.srcObject) {
        updateVoice('請先開啟相機');
        return;
      }
      
      isDetecting = true;
      updateStatus('檢測中');
      updateDetectionStatus('運行中');
      updateVoice('開始障礙物檢測，請緩慢移動手機');
      
      // 開始檢測循環
      detectionInterval = setInterval(() => {
        if (!isDetecting) return;
        
        try {
          const obstacles = simulateObstacleDetection();
          updateDetectionDisplay(obstacles);
        } catch (error) {
          console.error('檢測錯誤:', error);
        }
      }, 1000); // 每秒檢測一次
    }

    // 模擬障礙物檢測
    function simulateObstacleDetection() {
      const now = Date.now();
      
      // 模擬隨機檢測結果（實際應用中這裡會是真正的檢測邏輯）
      const obstacles = [];
      const obstacleTypes = ['牆壁', '家具', '行人', '樓梯', '門框'];
      
      // 30% 機率檢測到障礙物
      if (Math.random() < 0.3) {
        const distance = (Math.random() * 5 + 0.5).toFixed(1); // 0.5-5.5 公尺
        const type = obstacleTypes[Math.floor(Math.random() * obstacleTypes.length)];
        
        obstacles.push({
          type: type,
          distance: parseFloat(distance),
          confidence: (Math.random() * 30 + 70).toFixed(0) // 70-100% 置信度
        });
      }
      
      // 每5秒強制檢測到一個近距離障礙物（用於測試）
      if (now - lastDetectionTime > 5000) {
        obstacles.push({
          type: '測試障礙物',
          distance: (Math.random() * 1 + 0.5).toFixed(1), // 0.5-1.5 公尺
          confidence: '95'
        });
        lastDetectionTime = now;
      }
      
      return obstacles;
    }

    // 測試檢測
    function testDetection() {
      updateVoice('執行功能測試');
      
      // 模擬測試結果
      const testObstacles = [
        { type: '測試牆壁', distance: 1.2, confidence: '90' },
        { type: '測試椅子', distance: 2.5, confidence: '85' }
      ];
      
      updateDetectionDisplay(testObstacles);
      updateVoice('功能測試完成，檢測到 ' + testObstacles.length + ' 個測試障礙物');
    }

    // 停止檢測
    function stopDetection() {
      isDetecting = false;
      if (detectionInterval) {
        clearInterval(detectionInterval);
        detectionInterval = null;
      }
      updateStatus('已停止');
      updateDetectionStatus('已停止');
      updateVoice('檢測已停止');
      clearDetectionDisplay();
    }

    // 更新檢測顯示
    function updateDetectionDisplay(obstacles) {
      const list = document.getElementById('detectionList');
      
      if (obstacles.length === 0) {
        list.innerHTML = '<div class="detection-item" style="text-align:center; color:var(--muted);">前方安全，未偵測到障礙物</div>';
        return;
      }
      
      // 按距離排序
      obstacles.sort((a, b) => a.distance - b.distance);
      
      list.innerHTML = obstacles.map(obs => `
        <div class="detection-item" style="border-left: 4px solid ${obs.distance < 1.5 ? 'var(--bad)' : obs.distance < 3 ? 'var(--warn)' : 'var(--good)'}">
          <strong>${obs.type}</strong><br>
          距離: ${obs.distance}公尺 | 置信度: ${obs.confidence}%
        </div>
      `).join('');
      
      // 語音提示最近的障礙物
      const closest = obstacles[0];
      if (closest.distance < 1.0) {
        updateVoice(`緊急停止！${closest.type}非常接近，僅${closest.distance}公尺`);
      } else if (closest.distance < 2.0) {
        updateVoice(`注意！${closest.type}接近，距離${closest.distance}公尺`);
      } else if (closest.distance < 3.5) {
        updateVoice(`前方${closest.distance}公尺有${closest.type}`);
      }
      
      showDebugInfo(`檢測到 ${obstacles.length} 個障礙物，最近: ${closest.distance}公尺`);
    }

    function clearDetectionDisplay() {
      const list = document.getElementById('detectionList');
      list.innerHTML = '<div class="detection-item" style="text-align:center; color:var(--muted);">檢測已停止</div>';
    }

    // 工具函數
    function updateVoice(message) {
      const voiceAlert = document.getElementById('voiceAlert');
      voiceAlert.textContent = message;
      
      // 移除載入動畫（如果有的話）
      voiceAlert.classList.remove('loading');
      
      if (window.speechSynthesis) {
        try {
          window.speechSynthesis.cancel();
          const utterance = new SpeechSynthesisUtterance(message);
          utterance.lang = 'zh-TW';
          utterance.rate = 0.9;
          utterance.volume = 1.0;
          window.speechSynthesis.speak(utterance);
        } catch (error) {
          console.log('語音合成錯誤:', error);
        }
      }
    }

    function updateStatus(status) {
      document.getElementById('status').textContent = status;
    }

    function updateCameraStatus(status) {
      document.getElementById('cameraStatus').textContent = status;
    }

    function updateDetectionStatus(status) {
      document.getElementById('detectionStatus').textContent = status;
    }

    function showDebugInfo(message) {
      const debugElement = document.getElementById('debugInfo');
      debugElement.textContent = '除錯: ' + message;
      debugElement.style.display = 'block';
      console.log(message);
    }

    // 啟動應用
    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>