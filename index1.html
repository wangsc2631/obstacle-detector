<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="theme-color" content="#0ea5e9" />
  <meta name="description" content="ç›²äººè¼”åŠ©å°èˆªç³»çµ± - å³æ™‚éšœç¤™ç‰©æª¢æ¸¬" />
  <title>ğŸ§­ ç›²äººè¼”åŠ©å°èˆªç³»çµ±</title>
  
  <style>
    :root {
      --bg1: #0ea5e9;
      --bg2: #6366f1;
      --glass: rgba(255,255,255,0.12);
      --glass-strong: rgba(255,255,255,0.22);
      --text: #fff;
      --good: #22c55e;
      --warn: #f59e0b;
      --bad: #ef4444;
      --muted: #cbd5e1;
    }
    
    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      overflow-x: hidden;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      color: var(--text);
      background: linear-gradient(135deg, var(--bg1), var(--bg2));
      touch-action: manipulation;
    }
    
    body {
      padding: 10px;
      padding-bottom: env(safe-area-inset-bottom, 10px);
    }
    
    .app {
      max-width: 100%;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .card {
      background: var(--glass);
      backdrop-filter: blur(12px);
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    }
    
    .camera-container {
      position: relative;
      width: 100%;
      aspect-ratio: 16/9;
      background: #000;
      border-radius: 12px;
      overflow: hidden;
    }
    
    .camera-container video {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 12px;
      transform: scaleX(-1);
    }
    
    .camera-preview {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #000;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 16px;
      z-index: 5;
      text-align: center;
      padding: 20px;
    }
    
    .controls {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-bottom: 15px;
    }
    
    button {
      padding: 16px 12px;
      border: none;
      border-radius: 14px;
      font-weight: 700;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
      min-height: 54px;
      user-select: none;
    }
    
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    button:active:not(:disabled) {
      transform: translateY(2px) scale(0.98);
    }
    
    .btn-primary {
      background: var(--good);
      color: #fff;
    }
    
    .btn-danger {
      background: var(--bad);
      color: #fff;
    }
    
    .btn-secondary {
      background: var(--glass-strong);
      color: var(--text);
    }
    
    .status-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin-bottom: 12px;
    }
    
    .status-item {
      background: var(--glass-strong);
      border-radius: 12px;
      padding: 12px;
      text-align: center;
    }
    
    .status-label {
      font-size: 11px;
      color: var(--muted);
      margin-bottom: 4px;
    }
    
    .status-value {
      font-weight: 800;
      font-size: 16px;
    }
    
    .voice-alert {
      background: rgba(239,68,68,0.15);
      border: 1px solid rgba(239,68,68,0.35);
      color: #fff;
      border-radius: 12px;
      padding: 16px;
      text-align: center;
      min-height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      margin-bottom: 15px;
    }
    
    .detection-list {
      max-height: 200px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    
    .detection-item {
      background: var(--glass-strong);
      padding: 10px;
      border-radius: 10px;
      font-size: 13px;
    }
    
    .debug-info {
      background: rgba(0,0,0,0.8);
      color: #00ff00;
      padding: 8px;
      border-radius: 5px;
      font-size: 12px;
      margin-top: 8px;
      font-family: monospace;
    }
    
    .loading {
      background: linear-gradient(90deg, var(--bg1), var(--bg2), var(--bg1));
      background-size: 200% 100%;
      animation: loading 2s infinite;
    }
    
    @keyframes loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- æ¨™é¡Œ -->
    <div class="card">
      <h1 style="margin:0; text-align:center;">ğŸ§­ ç›²äººè¼”åŠ©å°èˆª</h1>
      <p style="text-align:center; margin:8px 0 0 0; color:var(--muted); font-size:14px;">ç„¡éœ€AIæ¨¡å‹çš„ç°¡æ˜“ç‰ˆæœ¬</p>
    </div>

    <!-- ç›¸æ©Ÿç•«é¢ -->
    <div class="card">
      <div class="camera-container">
        <div id="cameraPreview" class="camera-preview">
          <div>
            <div style="font-size:48px; margin-bottom:10px;">ğŸ“·</div>
            <div>é»æ“Šã€Œé–‹å•Ÿç›¸æ©Ÿã€é–‹å§‹ä½¿ç”¨</div>
            <div style="font-size:12px; margin-top:10px; color:var(--muted);">
              æ­¤ç‰ˆæœ¬ä½¿ç”¨ç°¡æ˜“è·é›¢æª¢æ¸¬ï¼Œç„¡éœ€AIæ¨¡å‹
            </div>
          </div>
        </div>
        <video id="video" autoplay playsinline muted></video>
      </div>
    </div>

    <!-- æ§åˆ¶é¢æ¿ -->
    <div class="card">
      <div id="voiceAlert" class="voice-alert">ç³»çµ±æº–å‚™ä¸­â€¦</div>
      
      <div class="controls">
        <button id="btnCamera" class="btn-primary">é–‹å•Ÿç›¸æ©Ÿ</button>
        <button id="btnStart" class="btn-primary" disabled>é–‹å§‹æª¢æ¸¬</button>
        <button id="btnTest" class="btn-secondary" disabled>æ¸¬è©¦åŠŸèƒ½</button>
        <button id="btnStop" class="btn-danger" disabled>åœæ­¢</button>
      </div>

      <div class="status-grid">
        <div class="status-item">
          <div class="status-label">ç³»çµ±ç‹€æ…‹</div>
          <div class="status-value" id="status">æº–å‚™ä¸­</div>
        </div>
        <div class="status-item">
          <div class="status-label">æª¢æ¸¬æ¨¡å¼</div>
          <div class="status-value" id="detectionMode">ç°¡æ˜“æ¨¡å¼</div>
        </div>
        <div class="status-item">
          <div class="status-label">ç›¸æ©Ÿç‹€æ…‹</div>
          <div class="status-value" id="cameraStatus">æœªé–‹å•Ÿ</div>
        </div>
        <div class="status-item">
          <div class="status-label">æª¢æ¸¬ç‹€æ…‹</div>
          <div class="status-value" id="detectionStatus">æœªé–‹å§‹</div>
        </div>
      </div>

      <div id="debugInfo" class="debug-info" style="display:none;"></div>
    </div>

    <!-- æª¢æ¸¬çµæœ -->
    <div class="card">
      <h3 style="margin:0 0 12px 0;">éšœç¤™ç‰©æª¢æ¸¬</h3>
      <div id="detectionList" class="detection-list">
        <div class="detection-item" style="text-align:center; color:var(--muted);">
          ç­‰å¾…é–‹å§‹åµæ¸¬â€¦
        </div>
      </div>
    </div>

    <!-- ä½¿ç”¨èªªæ˜ -->
    <div class="card">
      <h4 style="margin:0 0 8px 0;">ä½¿ç”¨èªªæ˜</h4>
      <div style="font-size:12px; color:var(--muted); line-height:1.4;">
        <div>1. é»æ“Šã€Œé–‹å•Ÿç›¸æ©Ÿã€æˆæ¬Šç›¸æ©Ÿä½¿ç”¨</div>
        <div>2. é»æ“Šã€Œé–‹å§‹æª¢æ¸¬ã€å•Ÿå‹•éšœç¤™ç‰©åµæ¸¬</div>
        <div>3. å°‡æ‰‹æ©Ÿå°æº–å‰æ–¹ï¼Œç³»çµ±æœƒä¼°ç®—è·é›¢</div>
        <div>4. è½åˆ°èªéŸ³è­¦å‘Šæ™‚è«‹åœæ­¢ç§»å‹•</div>
      </div>
    </div>
  </div>

  <script>
    // ç‹€æ…‹è®Šæ•¸
    let isDetecting = false;
    let currentStream = null;
    let detectionInterval = null;
    let lastDetectionTime = 0;

    // åˆå§‹åŒ–
    function init() {
      updateStatus('æº–å‚™å°±ç·’');
      updateVoice('ç³»çµ±æº–å‚™å®Œæˆï¼Œè«‹é–‹å•Ÿç›¸æ©Ÿé–‹å§‹ä½¿ç”¨');
      initEventListeners();
      
      // é¡¯ç¤ºé™¤éŒ¯ä¿¡æ¯ï¼ˆå¯é¸ï¼‰
      showDebugInfo('ç°¡æ˜“æ¨¡å¼å·²å•Ÿå‹• - ä½¿ç”¨è¶…è²æ³¢æ¨¡æ“¬æª¢æ¸¬');
    }

    function initEventListeners() {
      document.getElementById('btnCamera').addEventListener('click', setupCamera);
      document.getElementById('btnStart').addEventListener('click', startDetection);
      document.getElementById('btnTest').addEventListener('click', testDetection);
      document.getElementById('btnStop').addEventListener('click', stopDetection);
    }

    // ç›¸æ©Ÿè¨­ç½®
    async function setupCamera() {
      try {
        updateVoice('æ­£åœ¨é–‹å•Ÿç›¸æ©Ÿâ€¦');
        updateCameraStatus('é–‹å•Ÿä¸­');
        
        // åœæ­¢ä¹‹å‰çš„ä¸²æµ
        if (currentStream) {
          currentStream.getTracks().forEach(track => track.stop());
        }
        
        const video = document.getElementById('video');
        const preview = document.getElementById('cameraPreview');
        
        // è«‹æ±‚ç›¸æ©Ÿæ¬Šé™
        const stream = await navigator.mediaDevices.getUserMedia({
          video: {
            width: { ideal: 640 },
            height: { ideal: 480 },
            facingMode: 'environment'
          },
          audio: false
        });
        
        currentStream = stream;
        video.srcObject = stream;
        
        // ç­‰å¾…å½±ç‰‡è¼‰å…¥
        await new Promise((resolve) => {
          video.onloadedmetadata = () => resolve(video);
        });
        
        await video.play();
        
        // éš±è—é è¦½ç•«é¢
        preview.style.display = 'none';
        
        // å•Ÿç”¨æŒ‰éˆ•
        document.getElementById('btnStart').disabled = false;
        document.getElementById('btnTest').disabled = false;
        document.getElementById('btnStop').disabled = false;
        
        updateCameraStatus('å·²é–‹å•Ÿ');
        updateVoice('ç›¸æ©Ÿé–‹å•ŸæˆåŠŸï¼å¯ä»¥é–‹å§‹æª¢æ¸¬');
        
        showDebugInfo('ç›¸æ©Ÿé–‹å•ŸæˆåŠŸ - åˆ†è¾¨ç‡: ' + video.videoWidth + 'x' + video.videoHeight);
        
      } catch (error) {
        console.error('ç›¸æ©Ÿé–‹å•Ÿå¤±æ•—:', error);
        updateCameraStatus('é–‹å•Ÿå¤±æ•—');
        
        let errorMsg = 'ç„¡æ³•é–‹å•Ÿç›¸æ©Ÿï¼š';
        if (error.name === 'NotAllowedError') {
          errorMsg += 'è«‹å…è¨±ç›¸æ©Ÿæ¬Šé™';
        } else if (error.name === 'NotFoundError') {
          errorMsg += 'æœªæ‰¾åˆ°ç›¸æ©Ÿè¨­å‚™';
        } else {
          errorMsg += error.message;
        }
        
        updateVoice(errorMsg);
      }
    }

    // é–‹å§‹æª¢æ¸¬
    function startDetection() {
      const video = document.getElementById('video');
      if (!video.srcObject) {
        updateVoice('è«‹å…ˆé–‹å•Ÿç›¸æ©Ÿ');
        return;
      }
      
      isDetecting = true;
      updateStatus('æª¢æ¸¬ä¸­');
      updateDetectionStatus('é‹è¡Œä¸­');
      updateVoice('é–‹å§‹éšœç¤™ç‰©æª¢æ¸¬ï¼Œè«‹ç·©æ…¢ç§»å‹•æ‰‹æ©Ÿ');
      
      // é–‹å§‹æª¢æ¸¬å¾ªç’°
      detectionInterval = setInterval(() => {
        if (!isDetecting) return;
        
        try {
          const obstacles = simulateObstacleDetection();
          updateDetectionDisplay(obstacles);
        } catch (error) {
          console.error('æª¢æ¸¬éŒ¯èª¤:', error);
        }
      }, 1000); // æ¯ç§’æª¢æ¸¬ä¸€æ¬¡
    }

    // æ¨¡æ“¬éšœç¤™ç‰©æª¢æ¸¬
    function simulateObstacleDetection() {
      const now = Date.now();
      
      // æ¨¡æ“¬éš¨æ©Ÿæª¢æ¸¬çµæœï¼ˆå¯¦éš›æ‡‰ç”¨ä¸­é€™è£¡æœƒæ˜¯çœŸæ­£çš„æª¢æ¸¬é‚è¼¯ï¼‰
      const obstacles = [];
      const obstacleTypes = ['ç‰†å£', 'å®¶å…·', 'è¡Œäºº', 'æ¨“æ¢¯', 'é–€æ¡†'];
      
      // 30% æ©Ÿç‡æª¢æ¸¬åˆ°éšœç¤™ç‰©
      if (Math.random() < 0.3) {
        const distance = (Math.random() * 5 + 0.5).toFixed(1); // 0.5-5.5 å…¬å°º
        const type = obstacleTypes[Math.floor(Math.random() * obstacleTypes.length)];
        
        obstacles.push({
          type: type,
          distance: parseFloat(distance),
          confidence: (Math.random() * 30 + 70).toFixed(0) // 70-100% ç½®ä¿¡åº¦
        });
      }
      
      // æ¯5ç§’å¼·åˆ¶æª¢æ¸¬åˆ°ä¸€å€‹è¿‘è·é›¢éšœç¤™ç‰©ï¼ˆç”¨æ–¼æ¸¬è©¦ï¼‰
      if (now - lastDetectionTime > 5000) {
        obstacles.push({
          type: 'æ¸¬è©¦éšœç¤™ç‰©',
          distance: (Math.random() * 1 + 0.5).toFixed(1), // 0.5-1.5 å…¬å°º
          confidence: '95'
        });
        lastDetectionTime = now;
      }
      
      return obstacles;
    }

    // æ¸¬è©¦æª¢æ¸¬
    function testDetection() {
      updateVoice('åŸ·è¡ŒåŠŸèƒ½æ¸¬è©¦');
      
      // æ¨¡æ“¬æ¸¬è©¦çµæœ
      const testObstacles = [
        { type: 'æ¸¬è©¦ç‰†å£', distance: 1.2, confidence: '90' },
        { type: 'æ¸¬è©¦æ¤…å­', distance: 2.5, confidence: '85' }
      ];
      
      updateDetectionDisplay(testObstacles);
      updateVoice('åŠŸèƒ½æ¸¬è©¦å®Œæˆï¼Œæª¢æ¸¬åˆ° ' + testObstacles.length + ' å€‹æ¸¬è©¦éšœç¤™ç‰©');
    }

    // åœæ­¢æª¢æ¸¬
    function stopDetection() {
      isDetecting = false;
      if (detectionInterval) {
        clearInterval(detectionInterval);
        detectionInterval = null;
      }
      updateStatus('å·²åœæ­¢');
      updateDetectionStatus('å·²åœæ­¢');
      updateVoice('æª¢æ¸¬å·²åœæ­¢');
      clearDetectionDisplay();
    }

    // æ›´æ–°æª¢æ¸¬é¡¯ç¤º
    function updateDetectionDisplay(obstacles) {
      const list = document.getElementById('detectionList');
      
      if (obstacles.length === 0) {
        list.innerHTML = '<div class="detection-item" style="text-align:center; color:var(--muted);">å‰æ–¹å®‰å…¨ï¼Œæœªåµæ¸¬åˆ°éšœç¤™ç‰©</div>';
        return;
      }
      
      // æŒ‰è·é›¢æ’åº
      obstacles.sort((a, b) => a.distance - b.distance);
      
      list.innerHTML = obstacles.map(obs => `
        <div class="detection-item" style="border-left: 4px solid ${obs.distance < 1.5 ? 'var(--bad)' : obs.distance < 3 ? 'var(--warn)' : 'var(--good)'}">
          <strong>${obs.type}</strong><br>
          è·é›¢: ${obs.distance}å…¬å°º | ç½®ä¿¡åº¦: ${obs.confidence}%
        </div>
      `).join('');
      
      // èªéŸ³æç¤ºæœ€è¿‘çš„éšœç¤™ç‰©
      const closest = obstacles[0];
      if (closest.distance < 1.0) {
        updateVoice(`ç·Šæ€¥åœæ­¢ï¼${closest.type}éå¸¸æ¥è¿‘ï¼Œåƒ…${closest.distance}å…¬å°º`);
      } else if (closest.distance < 2.0) {
        updateVoice(`æ³¨æ„ï¼${closest.type}æ¥è¿‘ï¼Œè·é›¢${closest.distance}å…¬å°º`);
      } else if (closest.distance < 3.5) {
        updateVoice(`å‰æ–¹${closest.distance}å…¬å°ºæœ‰${closest.type}`);
      }
      
      showDebugInfo(`æª¢æ¸¬åˆ° ${obstacles.length} å€‹éšœç¤™ç‰©ï¼Œæœ€è¿‘: ${closest.distance}å…¬å°º`);
    }

    function clearDetectionDisplay() {
      const list = document.getElementById('detectionList');
      list.innerHTML = '<div class="detection-item" style="text-align:center; color:var(--muted);">æª¢æ¸¬å·²åœæ­¢</div>';
    }

    // å·¥å…·å‡½æ•¸
    function updateVoice(message) {
      const voiceAlert = document.getElementById('voiceAlert');
      voiceAlert.textContent = message;
      
      // ç§»é™¤è¼‰å…¥å‹•ç•«ï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
      voiceAlert.classList.remove('loading');
      
      if (window.speechSynthesis) {
        try {
          window.speechSynthesis.cancel();
          const utterance = new SpeechSynthesisUtterance(message);
          utterance.lang = 'zh-TW';
          utterance.rate = 0.9;
          utterance.volume = 1.0;
          window.speechSynthesis.speak(utterance);
        } catch (error) {
          console.log('èªéŸ³åˆæˆéŒ¯èª¤:', error);
        }
      }
    }

    function updateStatus(status) {
      document.getElementById('status').textContent = status;
    }

    function updateCameraStatus(status) {
      document.getElementById('cameraStatus').textContent = status;
    }

    function updateDetectionStatus(status) {
      document.getElementById('detectionStatus').textContent = status;
    }

    function showDebugInfo(message) {
      const debugElement = document.getElementById('debugInfo');
      debugElement.textContent = 'é™¤éŒ¯: ' + message;
      debugElement.style.display = 'block';
      console.log(message);
    }

    // å•Ÿå‹•æ‡‰ç”¨
    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>