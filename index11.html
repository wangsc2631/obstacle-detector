<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>器皿價格掃描與累計系統</title>
    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'PingFang TC', 'Helvetica Neue', Arial, sans-serif;
        }
        
        body {
            background-color: #f5f5f7;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 100%;
            padding: 15px;
        }
        
        header {
            background-color: #2c3e50;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        h1 {
            font-size: 1.4rem;
            margin-bottom: 5px;
        }
        
        .subtitle {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .camera-section {
            background-color: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        #camera-container {
            width: 100%;
            height: 300px;
            background-color: #000;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 15px;
            position: relative;
        }
        
        #camera-view {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        #canvas-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        
        .camera-controls {
            display: flex;
            justify-content: space-between;
            gap: 10px;
        }
        
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background-color 0.3s;
            flex: 1;
        }
        
        button:hover {
            background-color: #2980b9;
        }
        
        button:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }
        
        #capture-btn {
            background-color: #e74c3c;
        }
        
        #capture-btn:hover {
            background-color: #c0392b;
        }
        
        .auto-scan-section {
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .result-section {
            background-color: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: none;
        }
        
        .result-section.active {
            display: block;
        }
        
        .item-info {
            margin-bottom: 15px;
        }
        
        .item-name {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .item-price {
            font-size: 1.3rem;
            color: #e74c3c;
            font-weight: bold;
        }
        
        .confidence {
            font-size: 0.9rem;
            color: #7f8c8d;
            margin-top: 5px;
        }
        
        .action-buttons {
            display: flex;
            justify-content: space-between;
            gap: 10px;
        }
        
        #confirm-btn {
            background-color: #2ecc71;
            flex: 2;
        }
        
        #confirm-btn:hover {
            background-color: #27ae60;
        }
        
        #cancel-btn {
            background-color: #95a5a6;
            flex: 1;
        }
        
        #cancel-btn:hover {
            background-color: #7f8c8d;
        }
        
        .summary-section {
            background-color: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .total-amount {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2c3e50;
            text-align: center;
            margin: 10px 0;
        }
        
        .history-section {
            background-color: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .history-list {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
        }
        
        .history-item {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
        }
        
        .history-item:last-child {
            border-bottom: none;
        }
        
        .history-name {
            flex: 2;
            font-size: 0.9rem;
        }
        
        .history-price {
            flex: 1;
            text-align: right;
            color: #e74c3c;
            font-weight: bold;
        }
        
        .save-section {
            margin-top: 20px;
            text-align: center;
        }
        
        #save-btn {
            background-color: #9b59b6;
            width: 100%;
            padding: 12px;
        }
        
        #save-btn:hover {
            background-color: #8e44ad;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 10px;
            color: #3498db;
        }
        
        .loading.active {
            display: block;
        }
        
        @media (min-width: 768px) {
            .container {
                max-width: 600px;
                margin: 0 auto;
            }
            
            #camera-container {
                height: 400px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>器皿價格掃描與累計系統</h1>
            <div class="subtitle">漢來美食股份有限公司 - 南港島語</div>
        </header>
        
        <section class="camera-section">
            <div id="camera-container">
                <video id="camera-view" autoplay playsinline></video>
                <canvas id="canvas-overlay"></canvas>
            </div>
            <div class="camera-controls">
                <button id="start-camera">開啟相機</button>
                <button id="capture-btn" disabled>拍照辨識</button>
            </div>
            <div class="auto-scan-section">
                <input type="checkbox" id="auto-scan">
                <label for="auto-scan">自動連續辨識</label>
            </div>
            <div class="loading" id="loading">AI辨識中...</div>
        </section>
        
        <section class="result-section" id="result-section">
            <div class="item-info">
                <div class="item-name" id="item-name">辨識中...</div>
                <div class="item-price" id="item-price">NT$ 0</div>
                <div class="confidence" id="confidence">置信度: 0%</div>
            </div>
            <div class="action-buttons">
                <button id="cancel-btn">取消</button>
                <button id="confirm-btn">確認加入</button>
            </div>
        </section>
        
        <section class="summary-section">
            <h2>總計金額</h2>
            <div class="total-amount" id="total-amount">NT$ 0</div>
        </section>
        
        <section class="history-section">
            <h2>已掃描項目</h2>
            <div class="history-list" id="history-list">
                <!-- 歷史記錄將在這裡動態生成 -->
            </div>
            <div class="save-section">
                <button id="save-btn">儲存記錄</button>
            </div>
        </section>
    </div>

    <script>
        // 器皿資料庫 - 需要根據您的實際器皿進行訓練和標註
        const itemsDatabase = {
            // 這裡的類別名稱需要與您YOLO模型訓練時的類別對應
            "plate_16inch": { name: "止滑圓托盤16吋/直徑41cm", price: 235 },
            "cream_dish": { name: "奶油碟(味碟)2.8吋/象牙強化/港式小碟/169銀河系", price: 21 },
            "small_dish": { name: "可疊小料碟(布丁碟)白/78*30mm", price: 45 },
            "bowl_4inch": { name: "桃型小缽4吋/10.3*9*H4.3cm", price: 27 },
            "plate_6inch": { name: "圓盤6吋/15*H2cm", price: 25 },
            "coffee_cup_blue": { name: "咖啡杯/針葉林-青杉藍/日本NORITAKE/8*6.2cm/220ml", price: 128 },
            "wine_glass": { name: "VINO紅酒杯(Ocean)/470ml", price: 50 },
            "champagne_glass": { name: "東京香檳杯/LUCARISLS02CP06/最寬65mm/H229mm/165cc", price: 156 },
            // 添加更多器皿類別...
        };

        // DOM元素
        const cameraView = document.getElementById('camera-view');
        const canvasOverlay = document.getElementById('canvas-overlay');
        const startCameraBtn = document.getElementById('start-camera');
        const captureBtn = document.getElementById('capture-btn');
        const resultSection = document.getElementById('result-section');
        const itemName = document.getElementById('item-name');
        const itemPrice = document.getElementById('item-price');
        const confidence = document.getElementById('confidence');
        const confirmBtn = document.getElementById('confirm-btn');
        const cancelBtn = document.getElementById('cancel-btn');
        const totalAmount = document.getElementById('total-amount');
        const historyList = document.getElementById('history-list');
        const saveBtn = document.getElementById('save-btn');
        const loading = document.getElementById('loading');
        const autoScanCheckbox = document.getElementById('auto-scan');

        // 應用狀態
        let stream = null;
        let session = null;
        let currentItem = null;
        let scannedItems = [];
        let total = 0;
        let isModelLoaded = false;
        let autoScanInterval = null;

        // 初始化ONNX模型
        async function initModel() {
            try {
                loading.classList.add('active');
                
                // 加載YOLOv8模型
                // 注意：您需要將yolo8n.onnx放在可訪問的URL位置
                session = await ort.InferenceSession.create('./yolo8n.onnx');
                isModelLoaded = true;
                console.log('YOLOv8模型加載成功');
                
                loading.classList.remove('active');
                captureBtn.disabled = false;
            } catch (error) {
                console.error('模型加載失敗:', error);
                loading.textContent = '模型加載失敗，使用模擬模式';
                // 即使模型加載失敗，仍然允許使用模擬模式
                captureBtn.disabled = false;
            }
        }

        // 圖像預處理
        function preprocess(image, modelWidth, modelHeight) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = modelWidth;
            canvas.height = modelHeight;
            
            // 保持比例調整大小
            const ratio = Math.min(modelWidth / image.width, modelHeight / image.height);
            const newWidth = image.width * ratio;
            const newHeight = image.height * ratio;
            
            ctx.fillStyle = '#000000';
            ctx.fillRect(0, 0, modelWidth, modelHeight);
            ctx.drawImage(
                image, 
                (modelWidth - newWidth) / 2, 
                (modelHeight - newHeight) / 2, 
                newWidth, 
                newHeight
            );
            
            const imageData = ctx.getImageData(0, 0, modelWidth, modelHeight);
            const inputData = new Float32Array(modelWidth * modelHeight * 3);
            
            // 轉換為RGB格式並歸一化
            for (let i = 0; i < imageData.data.length; i += 4) {
                inputData[i / 4] = imageData.data[i] / 255.0;     // R
                inputData[i / 4 + modelWidth * modelHeight] = imageData.data[i + 1] / 255.0; // G
                inputData[i / 4 + modelWidth * modelHeight * 2] = imageData.data[i + 2] / 255.0; // B
            }
            
            return inputData;
        }

        // 使用YOLO進行物體檢測
        async function detectObjects(image) {
            if (!isModelLoaded || !session) {
                // 如果模型未加載，使用模擬檢測
                return simulateDetection();
            }
            
            try {
                const modelWidth = 640;
                const modelHeight = 640;
                
                // 預處理圖像
                const inputData = preprocess(image, modelWidth, modelHeight);
                
                // 創建Tensor
                const inputTensor = new ort.Tensor('float32', inputData, [1, 3, modelHeight, modelWidth]);
                
                // 運行推理
                const outputs = await session.run({ images: inputTensor });
                
                // 處理輸出結果
                const predictions = processOutput(outputs, image.width, image.height, modelWidth, modelHeight);
                
                return predictions;
            } catch (error) {
                console.error('檢測失敗:', error);
                return simulateDetection();
            }
        }

        // 處理YOLO輸出
        function processOutput(outputs, originalWidth, originalHeight, modelWidth, modelHeight) {
            const predictions = [];
            const output = outputs.output0.data;
            
            // YOLOv8輸出格式: [1, 84, 8400]
            const numClasses = 80; // 根據您的模型調整
            const numBoxes = 8400;
            
            for (let i = 0; i < numBoxes; i++) {
                const startIndex = i * (numClasses + 4);
                const scores = output.slice(startIndex + 4, startIndex + 4 + numClasses);
                const maxScore = Math.max(...scores);
                const classId = scores.indexOf(maxScore);
                
                if (maxScore > 0.5) { // 置信度閾值
                    const x = output[startIndex];
                    const y = output[startIndex + 1];
                    const w = output[startIndex + 2];
                    const h = output[startIndex + 3];
                    
                    // 轉換為原始圖像坐標
                    const ratio = Math.min(modelWidth / originalWidth, modelHeight / originalHeight);
                    const newWidth = originalWidth * ratio;
                    const newHeight = originalHeight * ratio;
                    
                    const xOffset = (modelWidth - newWidth) / 2;
                    const yOffset = (modelHeight - newHeight) / 2;
                    
                    const x1 = (x - w / 2 - xOffset) / ratio;
                    const y1 = (y - h / 2 - yOffset) / ratio;
                    const x2 = (x + w / 2 - xOffset) / ratio;
                    const y2 = (y + h / 2 - yOffset) / ratio;
                    
                    predictions.push({
                        classId: classId,
                        className: `item_${classId}`, // 需要與您的類別對應
                        confidence: maxScore,
                        bbox: [x1, y1, x2, y2]
                    });
                }
            }
            
            // 非極大值抑制
            return nonMaxSuppression(predictions, 0.5);
        }

        // 非極大值抑制
        function nonMaxSuppression(predictions, iouThreshold) {
            predictions.sort((a, b) => b.confidence - a.confidence);
            const selected = [];
            
            while (predictions.length > 0) {
                const current = predictions[0];
                selected.push(current);
                predictions = predictions.filter(pred => {
                    const iou = calculateIOU(current.bbox, pred.bbox);
                    return iou < iouThreshold;
                });
            }
            
            return selected;
        }

        // 計算IOU
        function calculateIOU(box1, box2) {
            const [x11, y1_1, x2_1, y2_1] = box1;
            const [x1_2, y1_2, x2_2, y2_2] = box2;
            
            const xi1 = Math.max(x1_1, x1_2);
            const yi1 = Math.max(y1_1, y1_2);
            const xi2 = Math.min(x2_1, x2_2);
            const yi2 = Math.min(y2_1, y2_2);
            
            const interArea = Math.max(0, xi2 - xi1) * Math.max(0, yi2 - yi1);
            const box1Area = (x2_1 - x1_1) * (y2_1 - y1_1);
            const box2Area = (x2_2 - x1_2) * (y2_2 - y1_2);
            const unionArea = box1Area + box2Area - interArea;
            
            return interArea / unionArea;
        }

        // 模擬檢測（備用）
        function simulateDetection() {
            const items = Object.keys(itemsDatabase);
            const randomItemKey = items[Math.floor(Math.random() * items.length)];
            const confidence = 0.7 + Math.random() * 0.3;
            
            return [{
                classId: 0,
                className: randomItemKey,
                confidence: confidence,
                bbox: [100, 100, 200, 200]
            }];
        }

        // 繪製檢測結果
        function drawDetections(predictions) {
            const ctx = canvasOverlay.getContext('2d');
            ctx.clearRect(0, 0, canvasOverlay.width, canvasOverlay.height);
            
            canvasOverlay.width = cameraView.videoWidth;
            canvasOverlay.height = cameraView.videoHeight;
            
            predictions.forEach(pred => {
                const [x1, y1, x2, y2] = pred.bbox;
                const className = pred.className;
                const conf = pred.confidence;
                
                // 繪製邊框
                ctx.strokeStyle = '#00ff00';
                ctx.lineWidth = 2;
                ctx.strokeRect(x1, y1, x2 - x1, y2 - y1);
                
                // 繪製標籤背景
                ctx.fillStyle = '#00ff00';
                const text = `${itemsDatabase[className]?.name || className}: ${(conf * 100).toFixed(1)}%`;
                const textWidth = ctx.measureText(text).width;
                ctx.fillRect(x1, y1 - 20, textWidth + 10, 20);
                
                // 繪製文字
                ctx.fillStyle = '#000000';
                ctx.font = '14px Arial';
                ctx.fillText(text, x1 + 5, y1 - 5);
            });
        }

        // 初始化
        async function init() {
            updateTotalAmount();
            updateHistoryList();
            await initModel();
        }

        // 開啟相機
        startCameraBtn.addEventListener('click', async () => {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } 
                });
                cameraView.srcObject = stream;
                startCameraBtn.disabled = true;
                
                // 設置自動掃描
                if (autoScanCheckbox.checked) {
                    startAutoScan();
                }
            } catch (err) {
                alert('無法開啟相機: ' + err.message);
            }
        });

        // 開始自動掃描
        function startAutoScan() {
            if (autoScanInterval) clearInterval(autoScanInterval);
            
            autoScanInterval = setInterval(async () => {
                if (!stream) return;
                
                const predictions = await detectObjects(cameraView);
                drawDetections(predictions);
                
                if (predictions.length > 0) {
                    const bestPrediction = predictions.reduce((best, current) => 
                        current.confidence > best.confidence ? current : best
                    );
                    
                    if (bestPrediction.confidence > 0.7) {
                        showDetectionResult(bestPrediction);
                    }
                }
            }, 2000); // 每2秒掃描一次
        }

        // 停止自動掃描
        function stopAutoScan() {
            if (autoScanInterval) {
                clearInterval(autoScanInterval);
                autoScanInterval = null;
            }
        }

        // 自動掃描切換
        autoScanCheckbox.addEventListener('change', () => {
            if (autoScanCheckbox.checked && stream) {
                startAutoScan();
            } else {
                stopAutoScan();
            }
        });

        // 拍照辨識
        captureBtn.addEventListener('click', async () => {
            if (!stream) return;
            
            loading.classList.add('active');
            const predictions = await detectObjects(cameraView);
            drawDetections(predictions);
            loading.classList.remove('active');
            
            if (predictions.length > 0) {
                const bestPrediction = predictions.reduce((best, current) => 
                    current.confidence > best.confidence ? current : best
                );
                showDetectionResult(bestPrediction);
            } else {
                alert('未檢測到任何器皿');
            }
        });

        // 顯示檢測結果
        function showDetectionResult(prediction) {
            const itemKey = prediction.className;
            const itemInfo = itemsDatabase[itemKey];
            
            if (itemInfo) {
                currentItem = {
                    ...itemInfo,
                    key: itemKey,
                    confidence: prediction.confidence
                };
                
                itemName.textContent = itemInfo.name;
                itemPrice.textContent = `NT$ ${itemInfo.price}`;
                confidence.textContent = `置信度: ${(prediction.confidence * 100).toFixed(1)}%`;
                resultSection.classList.add('active');
            } else {
                alert(`未找到對應的器皿資訊: ${itemKey}`);
            }
        }

        // 確認加入
        confirmBtn.addEventListener('click', () => {
            if (currentItem) {
                scannedItems.push({
                    ...currentItem,
                    timestamp: new Date()
                });
                
                total += currentItem.price;
                updateTotalAmount();
                updateHistoryList();
                
                // 重置狀態
                resultSection.classList.remove('active');
                currentItem = null;
            }
        });

        // 取消
        cancelBtn.addEventListener('click', () => {
            resultSection.classList.remove('active');
            currentItem = null;
        });

        // 更新總金額
        function updateTotalAmount() {
            totalAmount.textContent = `NT$ ${total}`;
        }

        // 更新歷史記錄
        function updateHistoryList() {
            historyList.innerHTML = '';
            
            scannedItems.forEach(item => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                
                historyItem.innerHTML = `
                    <div class="history-name">${item.name}</div>
                    <div class="history-price">NT$ ${item.price}</div>
                `;
                
                historyList.appendChild(historyItem);
            });
        }

        // 儲存記錄
        saveBtn.addEventListener('click', () => {
            if (scannedItems.length === 0) {
                alert('沒有可儲存的記錄');
                return;
            }
            
            const now = new Date();
            const dateStr = `${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2, '0')}-${now.getDate().toString().padStart(2, '0')}`;
            const timeStr = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
            
            const record = {
                date: dateStr,
                time: timeStr,
                items: scannedItems,
                total: total
            };
            
            // 實際應用中應將記錄儲存到伺服器或本地資料庫
            // 這裡使用下載JSON文件的方式
            const dataStr = JSON.stringify(record, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `器皿盤點記錄_${dateStr}_${timeStr.replace(':', '')}.json`;
            link.click();
            
            alert(`記錄已儲存!\n日期: ${dateStr}\n時間: ${timeStr}\n總金額: NT$ ${total}`);
        });

        // 初始化應用
        init();
    </script>
</body>
</html>