<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å™¨çš¿ç›¤é»ç³»çµ± - YOLOv8s AIè­˜åˆ¥</title>
    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'PingFang TC', 'Helvetica Neue', Arial, sans-serif;
        }
        
        body {
            background-color: #f5f5f7;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 100%;
            padding: 15px;
        }
        
        header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        h1 {
            font-size: 1.6rem;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .subtitle {
            font-size: 1rem;
            opacity: 0.9;
        }
        
        .camera-section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        
        #camera-container {
            width: 100%;
            height: 300px;
            background: linear-gradient(45deg, #2c3e50, #34495e);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 20px;
            position: relative;
            border: 3px solid #3498db;
        }
        
        #camera-view {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        #canvas-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }
        
        .camera-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 15px;
        }
        
        button {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
        }
        
        button:disabled {
            background: #bdc3c7;
            transform: none;
            box-shadow: none;
            cursor: not-allowed;
        }
        
        #capture-btn {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }
        
        #capture-btn:hover {
            box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
        }
        
        #retake-btn {
            background: linear-gradient(135deg, #f39c12, #e67e22);
        }
        
        #retake-btn:hover {
            box-shadow: 0 4px 12px rgba(243, 156, 18, 0.3);
        }
        
        .model-status {
            text-align: center;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-weight: 500;
        }
        
        .model-status.loading {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .model-status.ready {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .model-status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .detection-hint {
            text-align: center;
            color: #7f8c8d;
            font-size: 0.9rem;
            margin: 15px 0;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }

        .upload-model-section {
            background: #e8f4fd;
            border: 2px dashed #3498db;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            text-align: center;
        }

        .upload-model-section h3 {
            color: #2980b9;
            margin-bottom: 10px;
        }
        
        .result-section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            display: none;
        }
        
        .result-section.active {
            display: block;
        }
        
        .detection-results {
            margin-bottom: 20px;
        }
        
        .detected-item {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .detected-item:hover {
            border-color: #3498db;
            transform: translateY(-1px);
        }
        
        .detected-item.selected {
            border-color: #2ecc71;
            background: #f0fff4;
        }
        
        .item-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .item-name {
            font-weight: 600;
            color: #2c3e50;
        }
        
        .item-price {
            color: #e74c3c;
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        .confidence {
            font-size: 0.8rem;
            color: #7f8c8d;
            margin-top: 5px;
        }
        
        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        #confirm-btn {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
        }
        
        #confirm-btn:hover {
            box-shadow: 0 4px 12px rgba(46, 204, 113, 0.3);
        }
        
        #cancel-btn {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
        }
        
        .summary-section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        
        .total-amount {
            font-size: 2rem;
            font-weight: bold;
            color: #2c3e50;
            text-align: center;
            margin: 15px 0;
            background: linear-gradient(135deg, #3498db, #2ecc71);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .history-section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        
        .history-list {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
        }
        
        .history-item {
            padding: 12px 0;
            border-bottom: 1px solid #ecf0f1;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .history-item:last-child {
            border-bottom: none;
        }
        
        .history-name {
            flex: 2;
            font-size: 0.9rem;
        }
        
        .history-price {
            flex: 1;
            text-align: right;
            color: #e74c3c;
            font-weight: bold;
        }
        
        .save-section {
            margin-top: 25px;
            text-align: center;
        }
        
        #save-btn {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            width: 100%;
            padding: 16px;
            font-size: 1.1rem;
        }
        
        #save-btn:hover {
            box-shadow: 0 6px 20px rgba(155, 89, 182, 0.3);
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #3498db;
            font-size: 1.1rem;
        }
        
        .loading.active {
            display: block;
        }
        
        .manual-section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            display: none;
        }
        
        .manual-section.active {
            display: block;
        }
        
        .items-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .item-card {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .item-card:hover {
            border-color: #3498db;
            transform: translateY(-2px);
        }
        
        .item-card.selected {
            border-color: #2ecc71;
            background: #f0fff4;
        }
        
        @media (min-width: 768px) {
            .container {
                max-width: 800px;
                margin: 0 auto;
            }
            
            #camera-container {
                height: 400px;
            }
            
            .items-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ½ï¸ å™¨çš¿ç›¤é»ç³»çµ± - YOLOv8s AIè­˜åˆ¥</h1>
            <div class="subtitle">æ¼¢ä¾†ç¾é£Ÿè‚¡ä»½æœ‰é™å…¬å¸ - å—æ¸¯å³¶èª</div>
        </header>
        
        <section class="camera-section">
            <div class="model-status loading" id="model-status">
                â³ æ­£åœ¨è¼‰å…¥YOLOv8sæ¨¡å‹...
            </div>

            <div class="upload-model-section">
                <h3>ğŸ“ æ¨¡å‹è¼‰å…¥æ–¹å¼</h3>
                <p style="margin-bottom: 10px; color: #666;">ç”±æ–¼ç¶²è·¯é™åˆ¶ï¼Œè«‹é¸æ“‡ä»¥ä¸‹æ–¹å¼è¼‰å…¥æ¨¡å‹ï¼š</p>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <button onclick="loadModelFromLocal()" style="background: linear-gradient(135deg, #2ecc71, #27ae60);">
                        ğŸ“¥ ä¸Šå‚³æœ¬åœ°æ¨¡å‹
                    </button>
                    <button onclick="loadModelFromProxy()" style="background: linear-gradient(135deg, #3498db, #2980b9);">
                        ğŸŒ ä½¿ç”¨ä»£ç†è¼‰å…¥
                    </button>
                </div>
                <input type="file" id="model-file" accept=".onnx" style="display: none;">
                <div id="proxy-status" style="margin-top: 10px; font-size: 0.8rem; color: #7f8c8d;"></div>
            </div>
            
            <div id="camera-container">
                <video id="camera-view" autoplay playsinline></video>
                <canvas id="canvas-overlay"></canvas>
            </div>
            <div class="detection-hint" id="detection-hint">
                ğŸ¯ è«‹å…ˆè¼‰å…¥YOLOv8sæ¨¡å‹ï¼Œç„¶å¾Œå°‡å™¨çš¿å°æº–ç•«é¢ä¸­å¤®
            </div>
            <div class="camera-controls">
                <button id="start-camera">é–‹å•Ÿç›¸æ©Ÿ</button>
                <button id="capture-btn" disabled>é–‹å§‹å³æ™‚æª¢æ¸¬</button>
                <button id="retake-btn" style="display: none;">åœæ­¢æª¢æ¸¬</button>
                <button onclick="showManualSection()" style="background: linear-gradient(135deg, #95a5a6, #7f8c8d);">æ‰‹å‹•é¸æ“‡</button>
            </div>
            <div class="loading" id="loading">AIæª¢æ¸¬ä¸­...</div>
        </section>
        
        <section class="manual-section" id="manual-section">
            <h2 style="color: #2c3e50; margin-bottom: 15px;">æ‰‹å‹•é¸æ“‡å™¨çš¿</h2>
            <div class="items-grid" id="items-grid">
                <!-- å™¨çš¿åˆ—è¡¨æœƒå‹•æ…‹ç”Ÿæˆ -->
            </div>
        </section>
        
        <section class="result-section" id="result-section">
            <h2 style="color: #2c3e50; margin-bottom: 15px;">æª¢æ¸¬çµæœ</h2>
            <div class="detection-results" id="detection-results">
                <!-- æª¢æ¸¬çµæœæœƒå‹•æ…‹ç”Ÿæˆ -->
            </div>
            <div class="action-buttons">
                <button id="cancel-btn">å–æ¶ˆ</button>
                <button id="confirm-btn">ç¢ºèªåŠ å…¥</button>
            </div>
        </section>
        
        <section class="summary-section">
            <h2 style="color: #2c3e50; margin-bottom: 10px;">ç›¤é»ç¸½è¨ˆ</h2>
            <div class="total-amount" id="total-amount">NT$ 0</div>
            <div style="text-align: center; color: #7f8c8d; font-size: 0.9rem;">
                å·²æƒæ <span id="items-count">0</span> å€‹é …ç›®
            </div>
        </section>
        
        <section class="history-section">
            <h2 style="color: #2c3e50; margin-bottom: 15px;">å·²æƒæé …ç›®</h2>
            <div class="history-list" id="history-list">
                <div style="text-align: center; color: #7f8c8d; padding: 40px 20px;">
                    <div style="font-size: 3rem; margin-bottom: 10px;">ğŸ½ï¸</div>
                    <div>å°šæœªæƒæä»»ä½•å™¨çš¿</div>
                    <div style="font-size: 0.8rem; margin-top: 10px;">è«‹ä½¿ç”¨ä¸Šæ–¹åŠŸèƒ½é–‹å§‹ç›¤é»</div>
                </div>
            </div>
            <div class="save-section">
                <button id="save-btn">ğŸ’¾ å„²å­˜ç›¤é»è¨˜éŒ„</button>
            </div>
        </section>
    </div>

    <script>
        // å™¨çš¿è³‡æ–™åº«
        const itemsDatabase = {
            "plate": { id: 1, code: "160100000126", name: "æ­¢æ»‘åœ“æ‰˜ç›¤16å‹/ç›´å¾‘41cm", price: 235, type: "ç›¤å­" },
            "dish": { id: 2, code: "160100000987", name: "å¥¶æ²¹ç¢Ÿ(å‘³ç¢Ÿ)2.8å‹/è±¡ç‰™å¼·åŒ–/æ¸¯å¼å°ç¢Ÿ/169éŠ€æ²³ç³»", price: 21, type: "ç¢Ÿå­" },
            "bowl": { id: 4, code: "160101000478", name: "æ¡ƒå‹å°ç¼½4å‹/10.3*9*H4.3cm", price: 27, type: "ç¢—" },
            "cup": { id: 14, code: "160104000052", name: "å’–å•¡æ¯/é‡è‘‰æ—-é’æ‰è—/æ—¥æœ¬NORITAKE/8*6.2cm/220ml", price: 128, type: "æ¯å­" },
            "glass": { id: 26, code: "160200000255", name: "è–„åº•åœ“é…’æ¯(æ°´æ¯)/(LIBBEY )/5.8*H10.1cm/348cc", price: 35, type: "æ¯å­" }
        };

        // DOMå…ƒç´ 
        const cameraView = document.getElementById('camera-view');
        const canvasOverlay = document.getElementById('canvas-overlay');
        const startCameraBtn = document.getElementById('start-camera');
        const captureBtn = document.getElementById('capture-btn');
        const retakeBtn = document.getElementById('retake-btn');
        const resultSection = document.getElementById('result-section');
        const detectionResults = document.getElementById('detection-results');
        const confirmBtn = document.getElementById('confirm-btn');
        const cancelBtn = document.getElementById('cancel-btn');
        const totalAmount = document.getElementById('total-amount');
        const itemsCount = document.getElementById('items-count');
        const historyList = document.getElementById('history-list');
        const saveBtn = document.getElementById('save-btn');
        const loading = document.getElementById('loading');
        const modelStatus = document.getElementById('model-status');
        const detectionHint = document.getElementById('detection-hint');
        const manualSection = document.getElementById('manual-section');
        const itemsGrid = document.getElementById('items-grid');
        const modelFileInput = document.getElementById('model-file');
        const proxyStatus = document.getElementById('proxy-status');

        // æ‡‰ç”¨ç‹€æ…‹
        let stream = null;
        let session = null;
        let currentDetections = [];
        let selectedDetection = null;
        let scannedItems = [];
        let total = 0;
        let isModelReady = false;
        let isDetecting = false;
        let detectionInterval = null;

        // YOLOæ¨¡å‹é…ç½®
        const MODEL_INPUT_SIZE = 640;
        const CLASS_NAMES = ['plate', 'dish', 'bowl', 'cup', 'glass'];

        // å¾æœ¬åœ°è¼‰å…¥æ¨¡å‹
        async function loadModelFromLocal() {
            modelFileInput.click();
        }

        // è™•ç†æœ¬åœ°æ¨¡å‹æ–‡ä»¶é¸æ“‡
        modelFileInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) return;

            try {
                modelStatus.textContent = "â³ è¼‰å…¥æœ¬åœ°æ¨¡å‹ä¸­...";
                modelStatus.className = "model-status loading";
                
                const arrayBuffer = await file.arrayBuffer();
                session = await ort.InferenceSession.create(arrayBuffer, {
                    executionProviders: ['webgl'],
                    graphOptimizationLevel: 'all'
                });
                
                isModelReady = true;
                modelStatus.textContent = "âœ… æœ¬åœ°æ¨¡å‹è¼‰å…¥æˆåŠŸï¼";
                modelStatus.className = "model-status ready";
                captureBtn.disabled = false;
                detectionHint.textContent = "ğŸ¯ æ¨¡å‹è¼‰å…¥æˆåŠŸï¼é–‹å•Ÿç›¸æ©Ÿé–‹å§‹æª¢æ¸¬";
                
                console.log('æœ¬åœ°æ¨¡å‹è¼‰å…¥æˆåŠŸ');
                
            } catch (error) {
                console.error('æœ¬åœ°æ¨¡å‹è¼‰å…¥å¤±æ•—:', error);
                modelStatus.textContent = "âŒ æœ¬åœ°æ¨¡å‹è¼‰å…¥å¤±æ•—";
                modelStatus.className = "model-status error";
            }
        });

        // ä½¿ç”¨ä»£ç†è¼‰å…¥æ¨¡å‹
        async function loadModelFromProxy() {
            try {
                proxyStatus.textContent = "æ­£åœ¨é€šéä»£ç†è¼‰å…¥æ¨¡å‹...";
                modelStatus.textContent = "â³ é€šéä»£ç†è¼‰å…¥æ¨¡å‹ä¸­...";
                modelStatus.className = "model-status loading";
                
                // ä½¿ç”¨CORSä»£ç†
                const proxyUrl = 'https://corsproxy.io/?';
                const modelUrl = 'https://huggingface.co/wang2631/YOLOv8s-web-deployment/resolve/main/yolov8s.onnx';
                
                const response = await fetch(proxyUrl + encodeURIComponent(modelUrl));
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const arrayBuffer = await response.arrayBuffer();
                session = await ort.InferenceSession.create(arrayBuffer, {
                    executionProviders: ['webgl'],
                    graphOptimizationLevel: 'all'
                });
                
                isModelReady = true;
                modelStatus.textContent = "âœ… ä»£ç†æ¨¡å‹è¼‰å…¥æˆåŠŸï¼";
                modelStatus.className = "model-status ready";
                captureBtn.disabled = false;
                proxyStatus.textContent = "âœ… ä»£ç†è¼‰å…¥æˆåŠŸï¼";
                detectionHint.textContent = "ğŸ¯ æ¨¡å‹è¼‰å…¥æˆåŠŸï¼é–‹å•Ÿç›¸æ©Ÿé–‹å§‹æª¢æ¸¬";
                
                console.log('ä»£ç†æ¨¡å‹è¼‰å…¥æˆåŠŸ');
                
            } catch (error) {
                console.error('ä»£ç†æ¨¡å‹è¼‰å…¥å¤±æ•—:', error);
                modelStatus.textContent = "âŒ ä»£ç†æ¨¡å‹è¼‰å…¥å¤±æ•—";
                modelStatus.className = "model-status error";
                proxyStatus.textContent = "âŒ ä»£ç†è¼‰å…¥å¤±æ•—ï¼Œè«‹å˜—è©¦ä¸Šå‚³æœ¬åœ°æ¨¡å‹";
                
                // æä¾›å‚™ç”¨æ–¹æ¡ˆ
                setTimeout(() => {
                    proxyStatus.innerHTML = "ğŸ’¡ å»ºè­°ä¸‹è¼‰æ¨¡å‹åˆ°æœ¬åœ°å¾Œä¸Šå‚³ï¼š<br>" +
                        "1. è¨ªå•: https://huggingface.co/wang2631/YOLOv8s-web-deployment<br>" +
                        "2. ä¸‹è¼‰ yolov8s.onnx æ–‡ä»¶<br>" +
                        "3. é»æ“Šã€Œä¸Šå‚³æœ¬åœ°æ¨¡å‹ã€";
                }, 2000);
            }
        }

        // åœ–åƒé è™•ç†
        function preprocess(source, modelWidth, modelHeight) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = modelWidth;
            canvas.height = modelHeight;
            
            const ratio = Math.min(modelWidth / source.width, modelHeight / source.height);
            const newWidth = source.width * ratio;
            const newHeight = source.height * ratio;
            
            ctx.fillStyle = 'black';
            ctx.fillRect(0, 0, modelWidth, modelHeight);
            
            ctx.drawImage(
                source, 
                (modelWidth - newWidth) / 2, 
                (modelHeight - newHeight) / 2, 
                newWidth, 
                newHeight
            );
            
            const imageData = ctx.getImageData(0, 0, modelWidth, modelHeight);
            const { data } = imageData;
            
            const red = [], green = [], blue = [];
            for (let index = 0; index < data.length; index += 4) {
                red.push(data[index] / 255.0);
                green.push(data[index + 1] / 255.0);
                blue.push(data[index + 2] / 255.0);
            }
            
            const transposedData = red.concat(green).concat(blue);
            const float32Data = new Float32Array(transposedData);
            
            const inputTensor = new ort.Tensor('float32', float32Data, [1, 3, modelHeight, modelWidth]);
            return { inputTensor, ratio };
        }

        // è™•ç†YOLOè¼¸å‡º
        function processOutput(output, ratio, originalWidth, originalHeight) {
            const predictions = [];
            const outputData = output.output0.data;
            
            const numClasses = CLASS_NAMES.length;
            const boxDataLength = 4 + numClasses;
            const numBoxes = Math.floor(outputData.length / boxDataLength);
            
            for (let i = 0; i < numBoxes; i++) {
                const startIndex = i * boxDataLength;
                const scores = outputData.slice(startIndex + 4, startIndex + 4 + numClasses);
                const maxScore = Math.max(...scores);
                const classId = scores.indexOf(maxScore);
                
                if (maxScore > 0.3) {
                    const x = outputData[startIndex];
                    const y = outputData[startIndex + 1];
                    const w = outputData[startIndex + 2];
                    const h = outputData[startIndex + 3];
                    
                    const x1 = (x - w / 2) / ratio;
                    const y1 = (y - h / 2) / ratio;
                    const x2 = (x + w / 2) / ratio;
                    const y2 = (y + h / 2) / ratio;
                    
                    const className = CLASS_NAMES[classId];
                    const itemInfo = itemsDatabase[className];
                    
                    if (itemInfo) {
                        predictions.push({
                            bbox: [x1, y1, x2, y2],
                            class: className,
                            confidence: maxScore,
                            name: itemInfo.name,
                            price: itemInfo.price,
                            code: itemInfo.code
                        });
                    }
                }
            }
            
            return nonMaxSuppression(predictions, 0.5);
        }

        // éæ¥µå¤§å€¼æŠ‘åˆ¶
        function nonMaxSuppression(predictions, iouThreshold) {
            predictions.sort((a, b) => b.confidence - a.confidence);
            const selected = [];
            
            while (predictions.length > 0) {
                const current = predictions[0];
                selected.push(current);
                
                predictions = predictions.filter(pred => {
                    const iou = calculateIOU(current.bbox, pred.bbox);
                    return iou < iouThreshold;
                });
            }
            
            return selected;
        }

        // è¨ˆç®—IOU
        function calculateIOU(box1, box2) {
            const [x11, y11, x12, y12] = box1;
            const [x21, y21, x22, y22] = box2;
            
            const xi1 = Math.max(x11, x21);
            const yi1 = Math.max(y11, y21);
            const xi2 = Math.min(x12, x22);
            const yi2 = Math.min(y12, y22);
            
            const interArea = Math.max(0, xi2 - xi1) * Math.max(0, yi2 - yi1);
            const box1Area = (x12 - x11) * (y12 - y11);
            const box2Area = (x22 - x21) * (y22 - y21);
            const unionArea = box1Area + box2Area - interArea;
            
            return interArea / unionArea;
        }

        // åŸ·è¡ŒYOLOæª¢æ¸¬
        async function detectObjects(image) {
            if (!isModelReady || !session) {
                throw new Error('æ¨¡å‹æœªå°±ç·’');
            }
            
            try {
                const { inputTensor, ratio } = preprocess(image, MODEL_INPUT_SIZE, MODEL_INPUT_SIZE);
                const outputs = await session.run({ images: inputTensor });
                const predictions = processOutput(outputs, ratio, image.width, image.height);
                
                return predictions;
                
            } catch (error) {
                console.error('æª¢æ¸¬å¤±æ•—:', error);
                throw error;
            }
        }

        // ç¹ªè£½æª¢æ¸¬çµæœ
        function drawDetections(predictions) {
            const ctx = canvasOverlay.getContext('2d');
            ctx.clearRect(0, 0, canvasOverlay.width, canvasOverlay.height);
            
            canvasOverlay.width = cameraView.videoWidth;
            canvasOverlay.height = cameraView.videoHeight;
            
            predictions.forEach((pred, index) => {
                const [x1, y1, x2, y2] = pred.bbox;
                const width = x2 - x1;
                const height = y2 - y1;
                
                const color = pred.confidence > 0.7 ? '#00ff00' : 
                             pred.confidence > 0.5 ? '#ff9900' : '#ff4444';
                
                // ç¹ªè£½é‚Šæ¡†
                ctx.strokeStyle = color;
                ctx.lineWidth = 3;
                ctx.strokeRect(x1, y1, width, height);
                
                // ç¹ªè£½æ¨™ç±¤èƒŒæ™¯
                ctx.fillStyle = color;
                const label = `${pred.name} (${(pred.confidence * 100).toFixed(1)}%)`;
                const textWidth = ctx.measureText(label).width;
                ctx.fillRect(x1, y1 - 20, textWidth + 10, 20);
                
                // ç¹ªè£½æ–‡å­—
                ctx.fillStyle = '#000000';
                ctx.font = 'bold 14px Arial';
                ctx.fillText(label, x1 + 5, y1 - 5);
            });
        }

        // é–‹å§‹å³æ™‚æª¢æ¸¬
        async function startRealTimeDetection() {
            if (!stream || !isModelReady) return;
            
            isDetecting = true;
            captureBtn.disabled = true;
            retakeBtn.style.display = 'block';
            detectionHint.textContent = "ğŸ” AIå³æ™‚æª¢æ¸¬ä¸­...";
            
            detectionInterval = setInterval(async () => {
                if (!isDetecting) return;
                
                try {
                    const predictions = await detectObjects(cameraView);
                    currentDetections = predictions;
                    drawDetections(predictions);
                    
                    const highConfidenceDetections = predictions.filter(pred => pred.confidence > 0.7);
                    if (highConfidenceDetections.length > 0 && !resultSection.classList.contains('active')) {
                        showDetectionResults(highConfidenceDetections);
                    }
                    
                } catch (error) {
                    console.error('å³æ™‚æª¢æ¸¬éŒ¯èª¤:', error);
                }
            }, 1000);
        }

        // åœæ­¢æª¢æ¸¬
        function stopDetection() {
            isDetecting = false;
            if (detectionInterval) {
                clearInterval(detectionInterval);
                detectionInterval = null;
            }
            captureBtn.disabled = false;
            retakeBtn.style.display = 'none';
            detectionHint.textContent = "ğŸ¯ å°‡å™¨çš¿å°æº–ç•«é¢ä¸­å¤®ï¼Œç¢ºä¿å…‰ç·šå……è¶³";
            
            const ctx = canvasOverlay.getContext('2d');
            ctx.clearRect(0, 0, canvasOverlay.width, canvasOverlay.height);
        }

        // é¡¯ç¤ºæª¢æ¸¬çµæœ
        function showDetectionResults(predictions) {
            detectionResults.innerHTML = '';
            selectedDetection = null;
            
            if (predictions.length === 0) {
                detectionResults.innerHTML = '<div style="text-align: center; color: #7f8c8d; padding: 20px;">æœªæª¢æ¸¬åˆ°å™¨çš¿</div>';
                return;
            }
            
            predictions.forEach((pred, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'detected-item';
                itemDiv.onclick = () => selectDetection(pred, itemDiv);
                
                itemDiv.innerHTML = `
                    <div class="item-info">
                        <div class="item-name">${pred.name}</div>
                        <div class="item-price">NT$ ${pred.price}</div>
                    </div>
                    <div class="confidence">ç½®ä¿¡åº¦: ${(pred.confidence * 100).toFixed(1)}% | ç·¨è™Ÿ: ${pred.code}</div>
                `;
                
                detectionResults.appendChild(itemDiv);
            });
            
            resultSection.classList.add('active');
        }

        // é¸æ“‡æª¢æ¸¬çµæœ
        function selectDetection(detection, element) {
            document.querySelectorAll('.detected-item').forEach(item => {
                item.classList.remove('selected');
            });
            element.classList.add('selected');
            selectedDetection = detection;
        }

        // é¡¯ç¤ºæ‰‹å‹•é¸æ“‡å€å¡Š
        function showManualSection() {
            manualSection.classList.add('active');
            stopDetection();
        }

        // åˆå§‹åŒ–æ‰‹å‹•é¸æ“‡
        function initManualSelection() {
            itemsGrid.innerHTML = '';
            
            Object.values(itemsDatabase).forEach(item => {
                const card = document.createElement('div');
                card.className = 'item-card';
                card.onclick = () => selectManualItem(item, card);
                
                card.innerHTML = `
                    <div class="item-info">
                        <div class="item-name">${item.name}</div>
                        <div class="item-price">NT$ ${item.price}</div>
                    </div>
                    <div class="confidence">ç·¨è™Ÿ: ${item.code}</div>
                `;
                
                itemsGrid.appendChild(card);
            });
        }

        // é¸æ“‡æ‰‹å‹•é …ç›®
        function selectManualItem(item, element) {
            document.querySelectorAll('.item-card').forEach(card => {
                card.classList.remove('selected');
            });
            element.classList.add('selected');
            
            selectedDetection = {
                name: item.name,
                price: item.price,
                code: item.code,
                confidence: 1.0
            };
            
            resultSection.classList.add('active');
            showDetectionResults([selectedDetection]);
        }

        // åˆå§‹åŒ–
        function init() {
            updateTotalAmount();
            initManualSelection();
            
            // è‡ªå‹•å˜—è©¦ä½¿ç”¨ä»£ç†è¼‰å…¥
            setTimeout(() => {
                loadModelFromProxy();
            }, 1000);
        }

        // é–‹å•Ÿç›¸æ©Ÿ
        startCameraBtn.addEventListener('click', async () => {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } 
                });
                cameraView.srcObject = stream;
                startCameraBtn.disabled = true;
                
                cameraView.addEventListener('loadedmetadata', () => {
                    canvasOverlay.width = cameraView.videoWidth;
                    canvasOverlay.height = cameraView.videoHeight;
                });
            } catch (err) {
                alert('ç„¡æ³•é–‹å•Ÿç›¸æ©Ÿ: ' + err.message);
            }
        });

        // é–‹å§‹æª¢æ¸¬
        captureBtn.addEventListener('click', startRealTimeDetection);

        // åœæ­¢æª¢æ¸¬
        retakeBtn.addEventListener('click', stopDetection);

        // ç¢ºèªåŠ å…¥
        confirmBtn.addEventListener('click', () => {
            if (selectedDetection) {
                scannedItems.push({
                    name: selectedDetection.name,
                    price: selectedDetection.price,
                    code: selectedDetection.code,
                    timestamp: new Date(),
                    method: 'AIè­˜åˆ¥',
                    confidence: selectedDetection.confidence
                });
                
                total += selectedDetection.price;
                updateTotalAmount();
                updateHistoryList();
                
                resultSection.classList.remove('active');
                manualSection.classList.remove('active');
            }
        });

        // å–æ¶ˆ
        cancelBtn.addEventListener('click', () => {
            resultSection.classList.remove('active');
        });

        // æ›´æ–°ç¸½é‡‘é¡
        function updateTotalAmount() {
            totalAmount.textContent = `NT$ ${total}`;
            itemsCount.textContent = scannedItems.length;
        }

        // æ›´æ–°æ­·å²è¨˜éŒ„
        function updateHistoryList() {
            historyList.innerHTML = '';
            
            if (scannedItems.length === 0) {
                historyList.innerHTML = `
                    <div style="text-align: center; color: #7f8c8d; padding: 40px 20px;">
                        <div style="font-size: 3rem; margin-bottom: 10px;">ğŸ½ï¸</div>
                        <div>å°šæœªæƒæä»»ä½•å™¨çš¿</div>
                        <div style="font-size: 0.8rem; margin-top: 10px;">è«‹ä½¿ç”¨ä¸Šæ–¹åŠŸèƒ½é–‹å§‹ç›¤é»</div>
                    </div>
                `;
                return;
            }
            
            scannedItems.forEach(item => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                
                historyItem.innerHTML = `
                    <div class="history-name">
                        <div>${item.name}</div>
                        <div style="font-size: 0.7rem; color: #95a5a6;">${item.method} â€¢ ${formatTime(item.timestamp)}</div>
                    </div>
                    <div class="history-price">NT$ ${item.price}</div>
                `;
                
                historyList.appendChild(historyItem);
            });
        }

        // æ ¼å¼åŒ–æ™‚é–“
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
        }

        // å„²å­˜è¨˜éŒ„
        saveBtn.addEventListener('click', () => {
            if (scannedItems.length === 0) {
                alert('æ²’æœ‰å¯å„²å­˜çš„è¨˜éŒ„');
                return;
            }
            
            const now = new Date();
            const dateStr = `${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2, '0')}-${now.getDate().toString().padStart(2, '0')}`;
            const timeStr = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
            
            let csvContent = "æ–™ä»¶ç·¨è™Ÿ,å“åè¦æ ¼,å–®åƒ¹,è­˜åˆ¥æ–¹å¼,ç½®ä¿¡åº¦,ç›¤é»æ™‚é–“\n";
            scannedItems.forEach(item => {
                const confidence = item.confidence ? (item.confidence * 100).toFixed(1) + '%' : '100%';
                csvContent += `"${item.code}","${item.name}",${item.price},"${item.method}","${confidence}","${formatTime(item.timestamp)}"\n`;
            });
            csvContent += `\nç¸½è¨ˆé‡‘é¡,NT$ ${total},é …ç›®æ•¸é‡,${scannedItems.length},ç›¤é»æ—¥æœŸ,${dateStr}`;
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `å—æ¸¯å³¶èªå™¨çš¿ç›¤é»_${dateStr}_${timeStr.replace(':', '')}.csv`;
            link.click();
            
            alert(`âœ… ç›¤é»è¨˜éŒ„å·²å„²å­˜ï¼\nğŸ“… æ—¥æœŸ: ${dateStr}\nâ° æ™‚é–“: ${timeStr}\nğŸ’° ç¸½é‡‘é¡: NT$ ${total}\nğŸ“¦ é …ç›®æ•¸é‡: ${scannedItems.length}`);
        });

        // åˆå§‹åŒ–æ‡‰ç”¨
        init();
    </script>
</body>
</html>