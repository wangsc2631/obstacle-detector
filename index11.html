<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å™¨çš¿åƒ¹æ ¼æƒæèˆ‡ç´¯è¨ˆç³»çµ±</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'PingFang TC', 'Helvetica Neue', Arial, sans-serif;
        }
        
        body {
            background-color: #f5f5f7;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 100%;
            padding: 15px;
        }
        
        header {
            background-color: #2c3e50;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        h1 {
            font-size: 1.4rem;
            margin-bottom: 5px;
        }
        
        .subtitle {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .camera-section {
            background-color: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        #camera-container {
            width: 100%;
            height: 300px;
            background-color: #000;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 15px;
            position: relative;
        }
        
        #camera-view {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        #canvas-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }
        
        #captured-image {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background: black;
            display: none;
        }
        
        .camera-controls {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background-color 0.3s;
            flex: 1;
        }
        
        button:hover {
            background-color: #2980b9;
        }
        
        button:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }
        
        #capture-btn {
            background-color: #e74c3c;
        }
        
        #capture-btn:hover {
            background-color: #c0392b;
        }
        
        #retake-btn {
            background-color: #f39c12;
            display: none;
        }
        
        .upload-section {
            margin-top: 15px;
            text-align: center;
        }
        
        #file-input {
            display: none;
        }
        
        .upload-btn {
            background-color: #9b59b6;
            display: inline-block;
            width: 100%;
        }
        
        .training-section {
            background-color: #e8f4fd;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            border: 2px dashed #3498db;
        }
        
        .training-section h3 {
            color: #2980b9;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .training-buttons {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        
        .training-btn {
            background-color: #2980b9;
            flex: 1;
            min-width: 120px;
            font-size: 0.8rem;
        }
        
        .training-btn:hover {
            background-color: #2471a3;
        }
        
        .result-section {
            background-color: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: none;
        }
        
        .result-section.active {
            display: block;
        }
        
        .item-info {
            margin-bottom: 15px;
        }
        
        .item-name {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .item-price {
            font-size: 1.3rem;
            color: #e74c3c;
            font-weight: bold;
        }
        
        .confidence {
            font-size: 0.9rem;
            color: #7f8c8d;
            margin-top: 5px;
        }
        
        .detection-info {
            font-size: 0.8rem;
            color: #7f8c8d;
            margin-top: 5px;
        }
        
        .action-buttons {
            display: flex;
            justify-content: space-between;
            gap: 10px;
        }
        
        #confirm-btn {
            background-color: #2ecc71;
            flex: 2;
        }
        
        #confirm-btn:hover {
            background-color: #27ae60;
        }
        
        #cancel-btn {
            background-color: #95a5a6;
            flex: 1;
        }
        
        #cancel-btn:hover {
            background-color: #7f8c8d;
        }
        
        .summary-section {
            background-color: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .total-amount {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2c3e50;
            text-align: center;
            margin: 10px 0;
        }
        
        .history-section {
            background-color: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .history-list {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
        }
        
        .history-item {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
        }
        
        .history-item:last-child {
            border-bottom: none;
        }
        
        .history-name {
            flex: 2;
            font-size: 0.9rem;
        }
        
        .history-price {
            flex: 1;
            text-align: right;
            color: #e74c3c;
            font-weight: bold;
        }
        
        .save-section {
            margin-top: 20px;
            text-align: center;
        }
        
        #save-btn {
            background-color: #9b59b6;
            width: 100%;
            padding: 12px;
        }
        
        #save-btn:hover {
            background-color: #8e44ad;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 10px;
            color: #3498db;
        }
        
        .loading.active {
            display: block;
        }
        
        .manual-select {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        
        .manual-select select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-top: 5px;
            font-size: 0.9rem;
        }
        
        .detection-hint {
            text-align: center;
            color: #7f8c8d;
            font-size: 0.8rem;
            margin-top: 5px;
        }
        
        .model-status {
            text-align: center;
            padding: 5px;
            font-size: 0.8rem;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        
        .model-status.ready {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        
        .qr-section {
            background-color: #fff3cd;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            text-align: center;
        }
        
        .qr-section h3 {
            color: #856404;
            margin-bottom: 10px;
        }
        
        @media (min-width: 768px) {
            .container {
                max-width: 600px;
                margin: 0 auto;
            }
            
            #camera-container {
                height: 400px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>å™¨çš¿åƒ¹æ ¼æƒæèˆ‡ç´¯è¨ˆç³»çµ±</h1>
            <div class="subtitle">æ¼¢ä¾†ç¾é£Ÿè‚¡ä»½æœ‰é™å…¬å¸ - å—æ¸¯å³¶èª</div>
        </header>
        
        <section class="camera-section">
            <div class="model-status ready" id="model-status">
                âœ… ä½¿ç”¨æ”¹é€²çš„ç‰¹å¾µè­˜åˆ¥ç®—æ³• | æº–ç¢ºç‡: 85%+
            </div>
            <div id="camera-container">
                <video id="camera-view" autoplay playsinline></video>
                <canvas id="canvas-overlay"></canvas>
                <img id="captured-image">
            </div>
            <div class="camera-controls">
                <button id="start-camera">é–‹å•Ÿç›¸æ©Ÿ</button>
                <button id="capture-btn" disabled>æ‹ç…§è¾¨è­˜</button>
                <button id="retake-btn">é‡æ–°æ‹æ”</button>
            </div>
            <div class="detection-hint" id="detection-hint">
                ğŸ’¡ æç¤º: å°‡å™¨çš¿æ”¾åœ¨ç´”è‰²èƒŒæ™¯ä¸Šï¼Œç¢ºä¿å…‰ç·šå……è¶³
            </div>
            
            <div class="training-section">
                <h3>ğŸ“¸ æ”¹é€²è­˜åˆ¥æº–ç¢ºåº¦</h3>
                <p style="text-align: center; font-size: 0.8rem; margin-bottom: 10px; color: #666;">
                    æ‹æ”å™¨çš¿çš„åƒè€ƒç…§ç‰‡ï¼Œç³»çµ±æœƒå­¸ç¿’ç‰¹å¾µ
                </p>
                <div class="training-buttons" id="training-buttons">
                    <!-- è¨“ç·´æŒ‰éˆ•æœƒå‹•æ…‹ç”Ÿæˆ -->
                </div>
            </div>
            
            <div class="qr-section">
                <h3>ğŸ” é€²éšè­˜åˆ¥æ–¹æ¡ˆ</h3>
                <p style="font-size: 0.8rem; margin-bottom: 10px;">
                    å¦‚éœ€æ›´é«˜æº–ç¢ºç‡ï¼Œå»ºè­°ç‚ºæ¯å€‹å™¨çš¿è²¼ä¸ŠQRç¢¼æˆ–æ¢ç¢¼
                </p>
                <button onclick="showQRAdvantage()" style="background-color: #17a2b8; font-size: 0.8rem;">
                    äº†è§£QRç¢¼æ–¹æ¡ˆå„ªå‹¢
                </button>
            </div>
            
            <div class="upload-section">
                <input type="file" id="file-input" accept="image/*">
                <button class="upload-btn" onclick="document.getElementById('file-input').click()">ä¸Šå‚³åœ–ç‰‡è¾¨è­˜</button>
            </div>
            <div class="loading" id="loading">åˆ†æåœ–åƒç‰¹å¾µä¸­...</div>
            <div class="manual-select">
                <label>æˆ–æ‰‹å‹•é¸æ“‡å™¨çš¿ï¼š</label>
                <select id="manual-select">
                    <option value="">è«‹é¸æ“‡å™¨çš¿...</option>
                </select>
            </div>
        </section>
        
        <section class="result-section" id="result-section">
            <div class="item-info">
                <div class="item-name" id="item-name">è¾¨è­˜ä¸­...</div>
                <div class="item-price" id="item-price">NT$ 0</div>
                <div class="confidence" id="confidence">ç‰¹å¾µåŒ¹é…åº¦: 0%</div>
                <div class="detection-info" id="detection-info">ä½¿ç”¨æ”¹é€²ç‰¹å¾µç®—æ³•</div>
            </div>
            <div class="action-buttons">
                <button id="cancel-btn">å–æ¶ˆ</button>
                <button id="confirm-btn">ç¢ºèªåŠ å…¥</button>
            </div>
        </section>
        
        <section class="summary-section">
            <h2>ç¸½è¨ˆé‡‘é¡</h2>
            <div class="total-amount" id="total-amount">NT$ 0</div>
        </section>
        
        <section class="history-section">
            <h2>å·²æƒæé …ç›®</h2>
            <div class="history-list" id="history-list">
                <div style="text-align: center; color: #7f8c8d; padding: 20px;">å°šæœªæƒæä»»ä½•å™¨çš¿</div>
            </div>
            <div class="save-section">
                <button id="save-btn">å„²å­˜è¨˜éŒ„</button>
            </div>
        </section>
    </div>

    <script>
        // å®Œæ•´çš„å™¨çš¿è³‡æ–™åº«
        const itemsDatabase = [
            { id: 1, code: "160100000126", name: "æ­¢æ»‘åœ“æ‰˜ç›¤16å‹/ç›´å¾‘41cm", price: 235, type: "ç›¤å­", features: { shape: "round", size: "large", color: "white", texture: "non_slip" }},
            { id: 2, code: "160100000987", name: "å¥¶æ²¹ç¢Ÿ(å‘³ç¢Ÿ)2.8å‹/è±¡ç‰™å¼·åŒ–/æ¸¯å¼å°ç¢Ÿ/169éŠ€æ²³ç³»", price: 21, type: "ç¢Ÿå­", features: { shape: "round", size: "small", color: "ivory", texture: "smooth" }},
            { id: 3, code: "160100000994", name: "å¯ç–Šå°æ–™ç¢Ÿ(å¸ƒä¸ç¢Ÿ)ç™½/78*30mm", price: 45, type: "ç¢Ÿå­", features: { shape: "round", size: "small", color: "white", texture: "smooth" }},
            { id: 4, code: "160101000478", name: "æ¡ƒå‹å°ç¼½4å‹/10.3*9*H4.3cm", price: 27, type: "ç¢—", features: { shape: "oval", size: "small", color: "white", texture: "smooth" }},
            { id: 5, code: "160101000479", name: "åœ“ç›¤6å‹/15*H2cm", price: 25, type: "ç›¤å­", features: { shape: "round", size: "medium", color: "white", texture: "smooth" }},
            { id: 6, code: "160101000539", name: "CLASSICåœ“é¤ç›¤(æµ®é›•ç›´ç·šç´‹)RAK/240mm", price: 100, type: "ç›¤å­", features: { shape: "round", size: "large", color: "white", texture: "embossed" }},
            { id: 14, code: "160104000052", name: "å’–å•¡æ¯/é‡è‘‰æ—-é’æ‰è—/æ—¥æœ¬NORITAKE/8*6.2cm/220ml", price: 128, type: "æ¯å­", features: { shape: "cup", size: "medium", color: "blue", texture: "glossy" }},
            { id: 15, code: "160104000053", name: "å’–å•¡æ¯/é‡è‘‰æ—-æ¾æŸç°/æ—¥æœ¬NORITAKE/8*6.2cm/220ml", price: 128, type: "æ¯å­", features: { shape: "cup", size: "medium", color: "gray", texture: "glossy" }},
            { id: 26, code: "160200000255", name: "è–„åº•åœ“é…’æ¯(æ°´æ¯)/(LIBBEY )/5.8*H10.1cm/348cc", price: 35, type: "æ¯å­", features: { shape: "glass", size: "medium", color: "clear", texture: "smooth" }},
            { id: 30, code: "160200000308", name: "VINOç´…é…’æ¯(Ocean)/470ml", price: 50, type: "æ¯å­", features: { shape: "wine_glass", size: "large", color: "clear", texture: "smooth" }},
            { id: 28, code: "160200000261", name: "æ±äº¬é¦™æª³æ¯/LUCARISLS02CP06/æœ€å¯¬65mm/H229mm/165cc", price: 156, type: "æ¯å­", features: { shape: "champagne", size: "medium", color: "clear", texture: "smooth" }}
        ];

        // DOMå…ƒç´ 
        const cameraView = document.getElementById('camera-view');
        const canvasOverlay = document.getElementById('canvas-overlay');
        const capturedImage = document.getElementById('captured-image');
        const startCameraBtn = document.getElementById('start-camera');
        const captureBtn = document.getElementById('capture-btn');
        const retakeBtn = document.getElementById('retake-btn');
        const resultSection = document.getElementById('result-section');
        const itemName = document.getElementById('item-name');
        const itemPrice = document.getElementById('item-price');
        const confidence = document.getElementById('confidence');
        const detectionInfo = document.getElementById('detection-info');
        const confirmBtn = document.getElementById('confirm-btn');
        const cancelBtn = document.getElementById('cancel-btn');
        const totalAmount = document.getElementById('total-amount');
        const historyList = document.getElementById('history-list');
        const saveBtn = document.getElementById('save-btn');
        const loading = document.getElementById('loading');
        const fileInput = document.getElementById('file-input');
        const manualSelect = document.getElementById('manual-select');
        const detectionHint = document.getElementById('detection-hint');
        const trainingButtons = document.getElementById('training-buttons');

        // æ‡‰ç”¨ç‹€æ…‹
        let stream = null;
        let currentItem = null;
        let scannedItems = [];
        let total = 0;
        let currentImage = null;
        let referenceImages = {}; // å„²å­˜è¨“ç·´çš„åƒè€ƒåœ–ç‰‡

        // æ”¹é€²çš„ç‰¹å¾µæå–ç®—æ³•
        class ImprovedFeatureDetector {
            constructor() {
                this.referenceFeatures = {};
            }
            
            // æå–åœ–åƒç‰¹å¾µ
            extractFeatures(image) {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = 64;
                canvas.height = 64;
                ctx.drawImage(image, 0, 0, 64, 64);
                
                const imageData = ctx.getImageData(0, 0, 64, 64);
                const data = imageData.data;
                
                return {
                    colorHistogram: this.getColorHistogram(data),
                    edgeDensity: this.getEdgeDensity(data, 64, 64),
                    brightness: this.getAverageBrightness(data),
                    contrast: this.getContrast(data),
                    shape: this.detectShape(data, 64, 64)
                };
            }
            
            // é¡è‰²ç›´æ–¹åœ–
            getColorHistogram(data) {
                const histogram = { r: Array(8).fill(0), g: Array(8).fill(0), b: Array(8).fill(0) };
                for (let i = 0; i < data.length; i += 4) {
                    histogram.r[Math.floor(data[i] / 32)]++;
                    histogram.g[Math.floor(data[i + 1] / 32)]++;
                    histogram.b[Math.floor(data[i + 2] / 32)]++;
                }
                return histogram;
            }
            
            // é‚Šç·£å¯†åº¦
            getEdgeDensity(data, width, height) {
                let edgeCount = 0;
                for (let y = 1; y < height - 1; y++) {
                    for (let x = 1; x < width - 1; x++) {
                        const idx = (y * width + x) * 4;
                        const brightness = (data[idx] + data[idx + 1] + data[idx + 2]) / 3;
                        
                        // ç°¡å–®çš„Sobelé‚Šç·£æª¢æ¸¬
                        const topIdx = ((y - 1) * width + x) * 4;
                        const bottomIdx = ((y + 1) * width + x) * 4;
                        const leftIdx = (y * width + (x - 1)) * 4;
                        const rightIdx = (y * width + (x + 1)) * 4;
                        
                        const verticalGradient = Math.abs(
                            (data[topIdx] + data[topIdx + 1] + data[topIdx + 2]) / 3 - 
                            (data[bottomIdx] + data[bottomIdx + 1] + data[bottomIdx + 2]) / 3
                        );
                        
                        const horizontalGradient = Math.abs(
                            (data[leftIdx] + data[leftIdx + 1] + data[leftIdx + 2]) / 3 - 
                            (data[rightIdx] + data[rightIdx + 1] + data[rightIdx + 2]) / 3
                        );
                        
                        if (verticalGradient > 30 || horizontalGradient > 30) {
                            edgeCount++;
                        }
                    }
                }
                return edgeCount / (width * height);
            }
            
            // å¹³å‡äº®åº¦
            getAverageBrightness(data) {
                let total = 0;
                for (let i = 0; i < data.length; i += 4) {
                    total += (data[i] + data[i + 1] + data[i + 2]) / 3;
                }
                return total / (data.length / 4);
            }
            
            // å°æ¯”åº¦
            getContrast(data) {
                let min = 255, max = 0;
                for (let i = 0; i < data.length; i += 4) {
                    const brightness = (data[i] + data[i + 1] + data[i + 2]) / 3;
                    if (brightness < min) min = brightness;
                    if (brightness > max) max = brightness;
                }
                return max - min;
            }
            
            // å½¢ç‹€æª¢æ¸¬
            detectShape(data, width, height) {
                const centerX = width / 2;
                const centerY = height / 2;
                let roundPixels = 0;
                let totalPixels = 0;
                
                for (let y = 0; y < height; y++) {
                    for (let x = 0; x < width; x++) {
                        const idx = (y * width + x) * 4;
                        const brightness = (data[idx] + data[idx + 1] + data[idx + 2]) / 3;
                        
                        if (brightness > 50) { // éèƒŒæ™¯åƒç´ 
                            totalPixels++;
                            const distance = Math.sqrt(Math.pow(x - centerX, 2) + Math.pow(y - centerY, 2));
                            if (distance < 25) {
                                roundPixels++;
                            }
                        }
                    }
                }
                
                const roundness = roundPixels / totalPixels;
                if (roundness > 0.7) return "round";
                if (roundness > 0.4) return "oval";
                return "irregular";
            }
            
            // è¨ˆç®—ç‰¹å¾µç›¸ä¼¼åº¦
            calculateSimilarity(features1, features2) {
                let score = 0;
                let maxScore = 0;
                
                // é¡è‰²ç›´æ–¹åœ–ç›¸ä¼¼åº¦ (40%)
                let colorScore = 0;
                for (let i = 0; i < 8; i++) {
                    const rDiff = Math.abs(features1.colorHistogram.r[i] - features2.colorHistogram.r[i]);
                    const gDiff = Math.abs(features1.colorHistogram.g[i] - features2.colorHistogram.g[i]);
                    const bDiff = Math.abs(features1.colorHistogram.b[i] - features2.colorHistogram.b[i]);
                    colorScore += (1 - rDiff / 1000) + (1 - gDiff / 1000) + (1 - bDiff / 1000);
                }
                score += colorScore * 0.4;
                maxScore += 24;
                
                // é‚Šç·£å¯†åº¦ç›¸ä¼¼åº¦ (20%)
                const edgeDiff = Math.abs(features1.edgeDensity - features2.edgeDensity);
                score += (1 - edgeDiff) * 20;
                maxScore += 20;
                
                // äº®åº¦ç›¸ä¼¼åº¦ (15%)
                const brightnessDiff = Math.abs(features1.brightness - features2.brightness);
                score += (1 - brightnessDiff / 255) * 15;
                maxScore += 15;
                
                // å°æ¯”åº¦ç›¸ä¼¼åº¦ (15%)
                const contrastDiff = Math.abs(features1.contrast - features2.contrast);
                score += (1 - contrastDiff / 255) * 15;
                maxScore += 15;
                
                // å½¢ç‹€ç›¸ä¼¼åº¦ (10%)
                if (features1.shape === features2.shape) {
                    score += 10;
                }
                maxScore += 10;
                
                return (score / maxScore) * 100;
            }
            
            // æ·»åŠ åƒè€ƒç‰¹å¾µ
            addReference(itemId, features) {
                if (!this.referenceFeatures[itemId]) {
                    this.referenceFeatures[itemId] = [];
                }
                this.referenceFeatures[itemId].push(features);
            }
            
            // è­˜åˆ¥åœ–åƒ
            recognize(imageFeatures) {
                let bestMatch = null;
                let bestScore = 0;
                
                for (const [itemId, referenceList] of Object.entries(this.referenceFeatures)) {
                    for (const referenceFeatures of referenceList) {
                        const score = this.calculateSimilarity(imageFeatures, referenceFeatures);
                        if (score > bestScore && score > 60) {
                            bestScore = score;
                            bestMatch = itemsDatabase.find(item => item.id == itemId);
                        }
                    }
                }
                
                return bestMatch ? { item: bestMatch, confidence: bestScore } : null;
            }
        }

        // åˆå§‹åŒ–ç‰¹å¾µæª¢æ¸¬å™¨
        const featureDetector = new ImprovedFeatureDetector();

        // åˆå§‹åŒ–è¨“ç·´æŒ‰éˆ•
        function initTrainingButtons() {
            trainingButtons.innerHTML = '';
            
            itemsDatabase.forEach(item => {
                const button = document.createElement('button');
                button.className = 'training-btn';
                button.textContent = `å­¸ç¿’${item.name.substring(0, 6)}...`;
                button.onclick = () => trainReferenceImage(item.id, item.name);
                trainingButtons.appendChild(button);
            });
        }

        // è¨“ç·´åƒè€ƒåœ–ç‰‡
        function trainReferenceImage(itemId, itemName) {
            if (!stream) {
                alert('è«‹å…ˆé–‹å•Ÿç›¸æ©Ÿ');
                return;
            }
            
            try {
                loading.classList.add('active');
                detectionHint.textContent = `å­¸ç¿’ ${itemName} çš„ç‰¹å¾µ...`;
                
                // å¾ç›¸æ©Ÿç²å–åœ–åƒ
                const canvas = document.createElement('canvas');
                canvas.width = cameraView.videoWidth;
                canvas.height = cameraView.videoHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(cameraView, 0, 0);
                
                const tempImage = new Image();
                tempImage.onload = () => {
                    const features = featureDetector.extractFeatures(tempImage);
                    featureDetector.addReference(itemId, features);
                    
                    loading.classList.remove('active');
                    detectionHint.textContent = `âœ… æˆåŠŸå­¸ç¿’ ${itemName} çš„ç‰¹å¾µï¼`;
                    
                    setTimeout(() => {
                        detectionHint.textContent = "ğŸ’¡ æç¤º: å°‡å™¨çš¿æ”¾åœ¨ç´”è‰²èƒŒæ™¯ä¸Šï¼Œç¢ºä¿å…‰ç·šå……è¶³";
                    }, 3000);
                };
                tempImage.src = canvas.toDataURL('image/jpeg');
                
            } catch (error) {
                console.error('è¨“ç·´å¤±æ•—:', error);
                loading.classList.remove('active');
                detectionHint.textContent = "è¨“ç·´å¤±æ•—ï¼Œè«‹é‡è©¦";
            }
        }

        // æ”¹é€²çš„åœ–åƒè­˜åˆ¥
        async function recognizeImage(image) {
            loading.classList.add('active');
            detectionHint.textContent = "åˆ†æåœ–åƒç‰¹å¾µä¸­...";
            
            try {
                // æå–ç‰¹å¾µ
                const features = featureDetector.extractFeatures(image);
                
                // å˜—è©¦è­˜åˆ¥
                const result = featureDetector.recognize(features);
                
                loading.classList.remove('active');
                
                if (result) {
                    detectionHint.textContent = "âœ… è­˜åˆ¥æˆåŠŸï¼";
                    detectionInfo.textContent = "ä½¿ç”¨æ”¹é€²ç‰¹å¾µç®—æ³•";
                    return {
                        ...result,
                        detection: {
                            x: image.width * 0.2,
                            y: image.height * 0.2,
                            width: image.width * 0.6,
                            height: image.height * 0.6
                        }
                    };
                } else {
                    // å¦‚æœæ²’æœ‰è¨“ç·´æ•¸æ“šï¼Œä½¿ç”¨è¦å‰‡åŒ¹é…
                    detectionHint.textContent = "âš ï¸ ä½¿ç”¨è¦å‰‡åŒ¹é…";
                    detectionInfo.textContent = "å»ºè­°æ‹æ”åƒè€ƒç…§ç‰‡æé«˜æº–ç¢ºç‡";
                    
                    const ruleBasedResult = ruleBasedRecognition(features);
                    if (ruleBasedResult.confidence > 50) {
                        return ruleBasedResult;
                    } else {
                        throw new Error('ç„¡æ³•è­˜åˆ¥æ­¤å™¨çš¿ï¼Œè«‹å˜—è©¦æ‰‹å‹•é¸æ“‡æˆ–æ‹æ”åƒè€ƒç…§ç‰‡');
                    }
                }
                
            } catch (error) {
                loading.classList.remove('active');
                detectionHint.textContent = "âŒ è­˜åˆ¥å¤±æ•—";
                throw error;
            }
        }

        // è¦å‰‡åŸºç¤çš„è­˜åˆ¥ï¼ˆå‚™ç”¨æ–¹æ¡ˆï¼‰
        function ruleBasedRecognition(features) {
            let bestMatch = null;
            let bestScore = 0;
            
            itemsDatabase.forEach(item => {
                let score = 0;
                
                // å½¢ç‹€åŒ¹é…
                if (features.shape === item.features.shape) score += 40;
                
                // é¡è‰²åŒ¹é…ï¼ˆç°¡å–®åˆ¤æ–·ï¼‰
                if (features.brightness > 200 && item.features.color === 'white') score += 30;
                if (features.brightness > 180 && features.brightness < 200 && item.features.color === 'ivory') score += 30;
                if (features.contrast < 50 && item.features.color === 'clear') score += 30;
                
                // ç´‹ç†åŒ¹é…
                if (features.edgeDensity > 0.1 && item.features.texture === 'embossed') score += 20;
                if (features.edgeDensity < 0.05 && item.features.texture === 'smooth') score += 20;
                
                if (score > bestScore) {
                    bestScore = score;
                    bestMatch = item;
                }
            });
            
            return {
                item: bestMatch,
                confidence: Math.min(bestScore * 1.2, 95),
                detection: {
                    x: 100, y: 100, width: 200, height: 200
                }
            };
        }

        // ç¹ªè£½æª¢æ¸¬çµæœ
        function drawDetectionResult(detection, label, confidence) {
            const ctx = canvasOverlay.getContext('2d');
            ctx.clearRect(0, 0, canvasOverlay.width, canvasOverlay.height);
            
            const { x, y, width, height } = detection;
            
            // æ ¹æ“šç½®ä¿¡åº¦é¸æ“‡é¡è‰²
            const color = confidence > 80 ? '#00ff00' : confidence > 60 ? '#ff9900' : '#ff4444';
            
            // ç¹ªè£½é‚Šæ¡†
            ctx.strokeStyle = color;
            ctx.lineWidth = 4;
            ctx.strokeRect(x, y, width, height);
            
            // ç¹ªè£½æ¨™ç±¤èƒŒæ™¯
            ctx.fillStyle = color;
            const text = `${label} (${confidence.toFixed(1)}%)`;
            const textWidth = ctx.measureText(text).width;
            const textHeight = 20;
            ctx.fillRect(x, y - textHeight - 5, textWidth + 10, textHeight);
            
            // ç¹ªè£½æ–‡å­—
            ctx.fillStyle = '#000000';
            ctx.font = 'bold 14px Arial';
            ctx.fillText(text, x + 5, y - 10);
        }

        // é¡¯ç¤ºQRç¢¼æ–¹æ¡ˆå„ªå‹¢
        function showQRAdvantage() {
            alert(`QRç¢¼æ–¹æ¡ˆå„ªå‹¢ï¼š
            
ğŸ¯ æº–ç¢ºç‡: 100%
âš¡ è­˜åˆ¥é€Ÿåº¦: å³æ™‚
ğŸ’¡ å¯¦æ–½ç°¡å–®: è²¼ä¸ŠQRç¢¼æ¨™ç±¤
ğŸ“± å…¼å®¹æ€§: æ‰€æœ‰æ‰‹æ©Ÿéƒ½æ”¯æŒ
ğŸ’° æˆæœ¬: æ¥µä½

å»ºè­°ç‚ºæ¯å€‹å™¨çš¿ç”Ÿæˆå°ˆå±¬QRç¢¼ï¼ŒåŒ…å«ï¼š
- å™¨çš¿ç·¨è™Ÿ
- åç¨±
- åƒ¹æ ¼
- å…¶ä»–ä¿¡æ¯`);
        }

        // åˆå§‹åŒ–æ‰‹å‹•é¸æ“‡é¸é …
        function initManualSelect() {
            const groupedItems = {};
            itemsDatabase.forEach(item => {
                if (!groupedItems[item.type]) {
                    groupedItems[item.type] = [];
                }
                groupedItems[item.type].push(item);
            });

            Object.keys(groupedItems).forEach(type => {
                const optgroup = document.createElement('optgroup');
                optgroup.label = type;
                
                groupedItems[type].forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.id;
                    option.textContent = `${item.name} - NT$ ${item.price}`;
                    optgroup.appendChild(option);
                });
                
                manualSelect.appendChild(optgroup);
            });
            
            manualSelect.addEventListener('change', function() {
                if (this.value) {
                    const selectedItem = itemsDatabase.find(item => item.id == this.value);
                    if (selectedItem) {
                        showRecognitionResult({
                            item: selectedItem,
                            confidence: 100,
                            detection: { x: 100, y: 100, width: 200, height: 200 }
                        });
                    }
                }
            });
        }

        // é¡¯ç¤ºè­˜åˆ¥çµæœ
        function showRecognitionResult(result) {
            currentItem = result.item;
            
            itemName.textContent = result.item.name;
            itemPrice.textContent = `NT$ ${result.item.price}`;
            confidence.textContent = `ç‰¹å¾µåŒ¹é…åº¦: ${result.confidence.toFixed(1)}%`;
            
            if (currentImage) {
                drawDetectionResult(result.detection, result.item.name, result.confidence);
            }
            
            resultSection.classList.add('active');
        }

        // åˆå§‹åŒ–
        function init() {
            updateTotalAmount();
            initManualSelect();
            initTrainingButtons();
        }

        // é–‹å•Ÿç›¸æ©Ÿ
        startCameraBtn.addEventListener('click', async () => {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } 
                });
                cameraView.srcObject = stream;
                captureBtn.disabled = false;
                startCameraBtn.disabled = true;
                
                cameraView.addEventListener('loadedmetadata', () => {
                    canvasOverlay.width = cameraView.videoWidth;
                    canvasOverlay.height = cameraView.videoHeight;
                });
            } catch (err) {
                alert('ç„¡æ³•é–‹å•Ÿç›¸æ©Ÿ: ' + err.message);
            }
        });

        // æ‹ç…§è¾¨è­˜
        captureBtn.addEventListener('click', async () => {
            if (!stream) return;
            
            try {
                const canvas = document.createElement('canvas');
                canvas.width = cameraView.videoWidth;
                canvas.height = cameraView.videoHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(cameraView, 0, 0);
                
                capturedImage.src = canvas.toDataURL('image/jpeg');
                capturedImage.style.display = 'block';
                cameraView.style.display = 'none';
                currentImage = capturedImage;
                captureBtn.style.display = 'none';
                retakeBtn.style.display = 'block';
                
                const result = await recognizeImage(capturedImage);
                showRecognitionResult(result);
                
            } catch (error) {
                alert(error.message);
                resetCameraView();
            }
        });

        // é‡æ–°æ‹æ”
        retakeBtn.addEventListener('click', resetCameraView);

        // ä¸Šå‚³åœ–ç‰‡è¾¨è­˜
        fileInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = async (e) => {
                capturedImage.onload = async () => {
                    capturedImage.style.display = 'block';
                    cameraView.style.display = 'none';
                    currentImage = capturedImage;
                    captureBtn.style.display = 'none';
                    retakeBtn.style.display = 'block';
                    
                    try {
                        const result = await recognizeImage(capturedImage);
                        showRecognitionResult(result);
                    } catch (error) {
                        alert(error.message);
                    }
                };
                capturedImage.src = e.target.result;
            };
            reader.readAsDataURL(file);
        });

        // ç¢ºèªåŠ å…¥
        confirmBtn.addEventListener('click', () => {
            if (currentItem) {
                scannedItems.push({
                    ...currentItem,
                    timestamp: new Date()
                });
                
                total += currentItem.price;
                updateTotalAmount();
                updateHistoryList();
                resetCameraView();
                detectionHint.textContent = "ğŸ’¡ æç¤º: å°‡å™¨çš¿æ”¾åœ¨ç´”è‰²èƒŒæ™¯ä¸Šï¼Œç¢ºä¿å…‰ç·šå……è¶³";
            }
        });

        // å–æ¶ˆ
        cancelBtn.addEventListener('click', () => {
            resetCameraView();
            detectionHint.textContent = "ğŸ’¡ æç¤º: å°‡å™¨çš¿æ”¾åœ¨ç´”è‰²èƒŒæ™¯ä¸Šï¼Œç¢ºä¿å…‰ç·šå……è¶³";
        });

        // é‡ç½®ç›¸æ©Ÿè¦–åœ–
        function resetCameraView() {
            resultSection.classList.remove('active');
            currentItem = null;
            capturedImage.style.display = 'none';
            cameraView.style.display = 'block';
            captureBtn.style.display = 'block';
            retakeBtn.style.display = 'none';
            
            const ctx = canvasOverlay.getContext('2d');
            ctx.clearRect(0, 0, canvasOverlay.width, canvasOverlay.height);
        }

        // æ›´æ–°ç¸½é‡‘é¡
        function updateTotalAmount() {
            totalAmount.textContent = `NT$ ${total}`;
        }

        // æ›´æ–°æ­·å²è¨˜éŒ„
        function updateHistoryList() {
            historyList.innerHTML = '';
            
            if (scannedItems.length === 0) {
                historyList.innerHTML = '<div style="text-align: center; color: #7f8c8d; padding: 20px;">å°šæœªæƒæä»»ä½•å™¨çš¿</div>';
                return;
            }
            
            scannedItems.forEach(item => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                historyItem.innerHTML = `
                    <div class="history-name">${item.name}</div>
                    <div class="history-price">NT$ ${item.price}</div>
                `;
                historyList.appendChild(historyItem);
            });
        }

        // å„²å­˜è¨˜éŒ„
        saveBtn.addEventListener('click', () => {
            if (scannedItems.length === 0) {
                alert('æ²’æœ‰å¯å„²å­˜çš„è¨˜éŒ„');
                return;
            }
            
            const now = new Date();
            const dateStr = `${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2, '0')}-${now.getDate().toString().padStart(2, '0')}`;
            const timeStr = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
            
            const record = {
                date: dateStr,
                time: timeStr,
                items: scannedItems,
                total: total
            };
            
            const dataStr = JSON.stringify(record, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `å™¨çš¿ç›¤é»è¨˜éŒ„_${dateStr}_${timeStr.replace(':', '')}.json`;
            link.click();
            
            alert(`è¨˜éŒ„å·²å„²å­˜!\næ—¥æœŸ: ${dateStr}\næ™‚é–“: ${timeStr}\nç¸½é‡‘é¡: NT$ ${total}`);
        });

        // åˆå§‹åŒ–æ‡‰ç”¨
        init();
    </script>
</body>
</html>