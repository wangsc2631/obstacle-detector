<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>羅乙程寶貝專用 - 神奇寶貝英文學習</title>
  <style>
    /* CSS 樣式請保留您 index6.html 的內容 */
    :root {
      --pokemon-yellow: #ffcc00;
      --pokemon-blue: #3b4cca;
      --pokemon-red: #ff0000;
      --pokemon-light-blue: #6aa9ff;
    }
    
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Microsoft JhengHei', '微軟正黑體', sans-serif;
      text-align: center;
      background: linear-gradient(135deg, var(--pokemon-yellow), #ff9900);
      margin: 0;
      padding: 0;
      color: #333;
      min-height: 100vh;
      overflow-x: hidden;
    }
    
    .container {
      width: 100%;
      margin: 0 auto;
      background-color: rgba(255, 255, 255, 0.95);
      padding: 15px;
      border-bottom: 8px solid var(--pokemon-blue);
      position: relative;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    .container::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 10px;
      background: var(--pokemon-red);
      z-index: 1;
    }
    
    h1 {
      color: var(--pokemon-blue);
      font-size: 1.8rem;
      margin: 10px 0 5px;
      text-shadow: 1px 1px 0 #fff, 2px 2px 0 rgba(0,0,0,0.1);
      position: relative;
      display: inline-block;
      padding: 0 15px;
    }
    
    h1::after {
      content: "";
      position: absolute;
      bottom: -5px;
      left: 10%;
      width: 80%;
      height: 3px;
      background: var(--pokemon-red);
      border-radius: 2px;
    }
    
    .subtitle {
      font-size: 0.9rem;
      color: #555;
      margin-bottom: 15px;
    }
    
    .video-container {
      position: relative;
      width: 100%;
      margin: 0 auto 15px;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    
    #video {
      width: 100%;
      height: 50vh;
      max-height: 400px;
      background: #000;
      object-fit: cover;
      transform: scaleX(1);
    }
    
    #canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }
    
    .word-display {
      margin: 10px 0;
      padding: 15px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      min-height: 80px;
      font-size: 1.8rem;
      color: var(--pokemon-blue);
      border: 3px solid var(--pokemon-yellow);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    
    .word-display .zh {
      font-size: 1.2rem;
      color: #666;
      margin-top: 5px;
    }
    
    .controls {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 8px;
      margin: 10px 0;
    }
    
    button {
      padding: 12px 15px;
      font-size: 1rem;
      background: var(--pokemon-blue);
      color: white;
      border: none;
      border-radius: 50px;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: bold;
      box-shadow: 0 3px 0 rgba(0,0,0,0.2);
      flex: 1;
      min-width: 120px;
      max-width: 160px;
    }
    
    button:active {
      transform: translateY(2px);
      box-shadow: 0 1px 0 rgba(0,0,0,0.2);
    }
    
    button.active {
      background: var(--pokemon-red);
    }
    
    .mode-selector {
      display: flex;
      justify-content: center;
      margin: 10px 0;
      gap: 10px;
    }
    
    .mode-btn {
      background: var(--pokemon-light-blue);
      flex: 1;
      max-width: 160px;
    }
    
    .mode-btn.active {
      background: var(--pokemon-red);
    }
    
    .game-mode {
      background: #fff8e1;
      padding: 12px;
      border-radius: 12px;
      margin: 10px 0;
      font-size: 1rem;
      color: #e65100;
      border: 2px dashed var(--pokemon-red);
      display: none;
    }
    
    .vocab-section {
      margin-top: 15px;
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    
    .vocab-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .vocab-header h2 {
      color: var(--pokemon-blue);
      background: var(--pokemon-yellow);
      padding: 6px 15px;
      border-radius: 20px;
      margin: 0;
      border: 2px solid var(--pokemon-blue);
      font-size: 1.2rem;
    }
    
    .vocab-list {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      padding: 10px;
      flex: 1;
      overflow-y: auto;
      text-align: left;
      border: 2px solid var(--pokemon-light-blue);
      max-height: 30vh;
    }
    
    .vocab-item {
      padding: 8px;
      border-bottom: 1px solid #eee;
      font-size: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .vocab-item strong {
      color: var(--pokemon-red);
    }
    
    .remove-btn {
      background: transparent;
      color: #ff4444;
      box-shadow: none;
      padding: 5px;
      min-width: auto;
      max-width: 40px;
      font-size: 0.9rem;
    }
    
    .clear-btn {
      background: #ff6b6b;
      padding: 6px 12px;
      font-size: 0.9rem;
      min-width: auto;
    }
    
    .pikachu-corner {
      position: fixed;
      bottom: 10px;
      right: 10px;
      width: 60px;
      height: 60px;
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><path d="M50,10 C70,10 85,25 85,45 C85,65 70,80 50,80 C30,80 15,65 15,45 C15,25 30,10 50,10 Z" fill="%23FFCC00" stroke="%233B4CCA" stroke-width="2"/><circle cx="40" cy="35" r="5" fill="%23333"/><circle cx="60" cy="35" r="5" fill="%23333"/><path d="M45,55 Q50,60 55,55" stroke="%23333" stroke-width="2" fill="none"/><path d="M30,20 L25,15 M70,20 L75,15" stroke="%23333" stroke-width="2"/></svg>');
      background-repeat: no-repeat;
      opacity: 0.7;
      z-index: 10;
    }
    
    .pokeball {
      display: inline-block;
      width: 20px;
      height: 20px;
      background: linear-gradient(to bottom, var(--pokemon-red) 0%, var(--pokemon-red) 45%, #000 45%, #000 50%, white 50%, white 55%, #000 55%, #000 100%);
      border-radius: 50%;
      border: 1px solid #000;
      margin: 0 3px;
      vertical-align: middle;
    }
    
    .empty-vocab {
      text-align: center;
      color: #888;
      padding: 20px;
      font-style: italic;
    }
    
    .status-info {
      font-size: 0.8rem;
      color: #666;
      margin: 5px 0;
    }
    
    .ocr-focus-area {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 250px; /* 調整大小以符合優化後的 OCR 區域 */
      height: 100px;
      border: 3px solid #00ff00;
      background: rgba(0, 255, 0, 0.1);
      pointer-events: none;
      display: none;
    }
    
    @media (max-height: 700px) {
      #video {
        height: 40vh;
      }
      
      .vocab-list {
        max-height: 25vh;
      }
    }
    
    @media (max-height: 600px) {
      #video {
        height: 35vh;
      }
      
      .vocab-list {
        max-height: 20vh;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1><span class="pokeball"></span> 羅乙程寶貝英文學習 <span class="pokeball"></span></h1>
    <div class="subtitle">對準物品或字母開始學習</div>
    
    <div class="mode-selector">
      <button id="objectModeBtn" class="mode-btn active">🔍 物品辨識</button>
      <button id="ocrModeBtn" class="mode-btn">🔤 字母辨識</button>
    </div>

    <div id="gameMode" class="game-mode">
      找到 → <strong id="targetWord"></strong>
    </div>

    <div class="video-container">
      <video id="video" autoplay muted playsinline></video>
      <canvas id="canvas"></canvas>
      <div class="ocr-focus-area" id="ocrFocusArea"></div>
    </div>

    <div class="word-display" id="wordDisplay">
      載入 AI 模型中...
    </div>
    
    <div class="status-info" id="statusInfo">
      請點擊畫面開始載入模型
    </div>

    <div class="controls">
      <button id="langBtnEn" class="active">🔊 英文</button>
      <button id="langBtnZh">🔊 中文</button>
      <button id="gameBtn">🎮 遊戲模式</button>
    </div>

    <div class="vocab-section">
      <div class="vocab-header">
        <h2>📚 我的單字本</h2>
        <button id="clearVocab" class="clear-btn">清除</button>
      </div>
      <div class="vocab-list" id="vocabList">
        <div class="empty-vocab">還沒有收藏單字</div>
      </div>
    </div>
    
    <div class="pikachu-corner"></div>
  </div>

  <script src="itemDatabase.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js"></script>
  
  <script src="https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js"></script>

  <script>
    // --- YOLOv8 專用設定 ---
    const MODEL_INPUT_SIZE = 640;
    const CONF_THRESHOLD = 0.6; // 預設信心度門檻 (從 0.25 調整到 0.3，確保品質)
    const IOU_THRESHOLD = 0.45; // NMS IOU 門檻
    // 標準 COCO 80 類別
    const CLASS_NAMES = [
        'person', 'bicycle', 'car', 'motorbike', 'aeroplane', 'bus', 'train', 'truck', 'boat', 
        'traffic light', 'fire hydrant', 'stop sign', 'parking meter', 'bench', 'bird', 'cat', 
        'dog', 'horse', 'sheep', 'cow', 'elephant', 'bear', 'zebra', 'giraffe', 'backpack', 
        'umbrella', 'handbag', 'tie', 'suitcase', 'frisbee', 'skis', 'snowboard', 'sports ball', 
        'kite', 'baseball bat', 'baseball glove', 'skateboard', 'surfboard', 'tennis racket', 
        'bottle', 'wine glass', 'cup', 'fork', 'knife', 'spoon', 'bowl', 'banana', 'apple', 
        'sandwich', 'orange', 'broccoli', 'carrot', 'hot dog', 'pizza', 'donut', 'cake', 'chair', 
        'sofa', 'pottedplant', 'bed', 'diningtable', 'toilet', 'tvmonitor', 'laptop', 'mouse', 
        'remote', 'keyboard', 'cell phone', 'microwave', 'oven', 'toaster', 'sink', 'refrigerator', 
        'book', 'clock', 'vase', 'scissors', 'teddy bear', 'hair drier', 'toothbrush'
    ];

    // 初始化變數
    let yoloDetector; // 替換舊的 net 變數
    let isEnglish = true;
    let isInGameMode = false;
    let isOCRMode = false;
    let currentTarget = '';
    let collectedWords = JSON.parse(localStorage.getItem('collectedWords')) || [];
    let lastSpokenWord = '';
    let isSpeaking = false;
    let detectionFrameCount = 0;
    let lastSpokenTime = 0;
    let ocrWorker = null;

    // DOM 元素 (保留)
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const wordDisplay = document.getElementById('wordDisplay');
    const vocabList = document.getElementById('vocabList');
    const gameMode = document.getElementById('gameMode');
    const targetWord = document.getElementById('targetWord');
    const langBtnEn = document.getElementById('langBtnEn');
    const langBtnZh = document.getElementById('langBtnZh');
    const gameBtn = document.getElementById('gameBtn');
    const clearVocab = document.getElementById('clearVocab');
    const objectModeBtn = document.getElementById('objectModeBtn');
    const ocrModeBtn = document.getElementById('ocrModeBtn');
    const statusInfo = document.getElementById('statusInfo');
    const ocrFocusArea = document.getElementById('ocrFocusArea');
    
    // 擴展的 COCO-SSD 與資料庫 key 對應表 (改為 YOLOv8 類別對應，如果您的 itemDatabase.js 使用了不同的 key)
    const cocoToYourKey = {
        'cell phone': 'smartphone',
        'hair drier': 'hair dryer',
        'tvmonitor': 'television', // 替換 'tv'
        'remote': 'remote control',
        'mouse': 'computer mouse',
        'keyboard': 'computer keyboard',
        'laptop': 'notebook computer',
        'sports ball': 'ball',
        'baseball bat': 'bat',
        'baseball glove': 'glove',
        'tennis racket': 'racket',
        'wine glass': 'glass',
        'hot dog': 'hotdog',
        'pottedplant': 'plant', // 替換 'potted plant'
        'diningtable': 'table', // 替換 'dining table'
        'parking meter': 'meter',
        'stop sign': 'sign',
        'fire hydrant': 'hydrant',
        'traffic light': 'trafficlight'
        // 其他類別將直接使用 COCO 名稱
    };


    // --- Class: YOLOv8Detector (新的偵測邏輯) ---
    class YOLOv8Detector {
      constructor(modelPath = 'yolov8n.onnx') {
        this.modelPath = modelPath;
        this.session = null;
        this.isReady = false;
      }

      async loadModel() {
        statusInfo.textContent = '載入 AI 模型中...';
        wordDisplay.textContent = `正在從 ${this.modelPath} 載入模型...`;

        try {
          if (typeof ort === 'undefined' || !ort.InferenceSession) {
            throw new Error("ONNX Runtime Web 函式庫未載入。");
          }

          // 核心載入邏輯：加入 WebGL/WASM 回退
          this.session = await ort.InferenceSession.create(this.modelPath, {
            executionProviders: ['webgl', 'wasm'], 
            graphOptimizationLevel: 'all',
            logLevel: 'error' 
          });

          this.isReady = true;
          statusInfo.textContent = 'AI 視覺準備就緒';
          wordDisplay.textContent = '模型載入完成！對準物品開始學習';
          return true;
        } catch (error) {
          console.error('YOLOv8 模型載入失敗 (詳細):', error);
          const errorMessage = `模型載入失敗。請檢查: 1. 路徑 ${this.modelPath} 2. WebGL/WASM 錯誤。錯誤: ${error.message.substring(0, 80)}...`;
          statusInfo.textContent = '載入失敗';
          wordDisplay.textContent = errorMessage; 
          return false;
        }
      }

      async detect(video) {
        if (!this.isReady) return [];

        const width = video.videoWidth;
        const height = video.videoHeight;
        
        // --- 1. 影像預處理：TF.js Tensor 轉換 (HWC -> NCHW, 歸一化) ---
        const inputTensor = tf.tidy(() => {
          let tensor = tf.browser.fromPixels(video); 
          tensor = tf.image.resizeBilinear(tensor, [MODEL_INPUT_SIZE, MODEL_INPUT_SIZE]);
          tensor = tensor.div(255.0); 
          tensor = tensor.transpose([2, 0, 1]); // HWC -> CHW
          tensor = tensor.expandDims(0); // CHW -> NCHW
          return tensor;
        });

        const input = new ort.Tensor('float32', inputTensor.dataSync(), [1, 3, MODEL_INPUT_SIZE, MODEL_INPUT_SIZE]);
        inputTensor.dispose(); // 釋放 tfjs 內存

        // --- 2. 執行 ONNX 推理 ---
        const feeds = { 'images': input }; // 'images' 是 YOLOv8 ONNX 模型的標準輸入名稱
        const output = await this.session.run(feeds);
        
        // YOLOv8n 的輸出張量名稱通常是 'output0'
        const predictions = this._processOutput(
            output['output0'], width, height, CONF_THRESHOLD, IOU_THRESHOLD
        );
        
        return predictions;
      }
      
      // --- 3. YOLOv8 NMS 後處理 ---
      _processOutput(outputTensor, originalWidth, originalHeight, confThreshold, iouThreshold) {
        const output = outputTensor.data;
        // YOLOv8 的輸出格式是 [1, 84, 8400] 或 [1, 85, 8400]，但我們只處理 [84, 8400]
        const numClasses = CLASS_NAMES.length; // 80
        const rows = outputTensor.dims[2]; // 8400
        const valuesPerRow = outputTensor.dims[1]; // 84 (4+80)

        let boxes = []; // 儲存 [x1, y1, x2, y2, score, classId]

        for (let i = 0; i < rows; i++) {
          const rowStart = i * valuesPerRow;
          const scoreStart = rowStart + 4; // 類別分數從第 5 個值開始 (0-based: index 4)

          // 找出最高分數的類別
          let maxScore = 0;
          let classId = -1;
          for (let c = 0; c < numClasses; c++) {
            const score = output[scoreStart + c];
            if (score > maxScore) {
              maxScore = score;
              classId = c;
            }
          }

          if (maxScore > confThreshold) {
            // 解析 Bounding Box (cx, cy, w, h)
            const cx = output[rowStart + 0];
            const cy = output[rowStart + 1];
            const w = output[rowStart + 2];
            const h = output[rowStart + 3];

            // 轉換到 (x1, y1, x2, y2)
            const x1 = cx - w / 2;
            const y1 = cy - h / 2;
            const x2 = cx + w / 2;
            const y2 = cy + h / 2;

            boxes.push([x1, y1, x2, y2, maxScore, classId]);
          }
        }
        
        // 執行 NMS (非最大抑制)
        const NMS_IDX = 4; // score index
        const boxesTensor = tf.tensor2d(boxes, [boxes.length, 6]);
        const scores = boxesTensor.slice([0, NMS_IDX], [-1, 1]).squeeze();
        const boxCoords = boxesTensor.slice([0, 0], [-1, 4]);

        const indices = tf.image.nonMaxSuppression(
          boxCoords, 
          scores, 
          100, // max detections
          iouThreshold,
          confThreshold
        );

        const selectedBoxesData = boxesTensor.gather(indices).arraySync();
        boxesTensor.dispose();
        scores.dispose();
        boxCoords.dispose();
        indices.dispose();
        
        const finalDetections = selectedBoxesData.map(box => {
            // 轉換回原始影片解析度
            const xRatio = originalWidth / MODEL_INPUT_SIZE;
            const yRatio = originalHeight / MODEL_INPUT_SIZE;
            
            const x1 = Math.max(0, box[0] * xRatio);
            const y1 = Math.max(0, box[1] * yRatio);
            const x2 = Math.min(originalWidth, box[2] * xRatio);
            const y2 = Math.min(originalHeight, box[3] * yRatio);
            
            return {
                class: CLASS_NAMES[box[5]],
                score: box[4],
                bbox: [x1, y1, x2 - x1, y2 - y1] // 轉換為 [x, y, w, h] 格式
            };
        });

        return finalDetections;
      }
    }


    // 從 itemDatabase 查詢單字資訊 (保留)
    function getWordInfo(label) {
      // 由於 YOLOv8n 使用標準 COCO 標籤，這裡直接對應
      const key = cocoToYourKey[label] || label;
      const zh = itemNames[key] || label;
      const en = key.charAt(0).toUpperCase() + key.slice(1);
      return { en, zh, key };
    }

    // iOS 兼容的語音朗讀功能 (保留)
    function speak(text, lang = 'en-US') {
      if (isSpeaking) return;
      
      const now = Date.now();
      if (now - lastSpokenTime < (text === lastSpokenWord ? 3000 : 1000)) {
        return;
      }
      
      lastSpokenWord = text;
      lastSpokenTime = now;
      isSpeaking = true;
      
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = lang;
      utter.rate = 0.8;
      utter.pitch = 1.1;
      utter.volume = 1.0;
      
      if (speechSynthesis.speaking) {
        speechSynthesis.cancel();
      }
      
      utter.onend = () => {
        isSpeaking = false;
      };
      
      utter.onerror = () => {
        isSpeaking = false;
      };
      
      setTimeout(() => {
        speechSynthesis.speak(utter);
      }, 100);
    }

    // 語言切換 (保留)
    langBtnEn.addEventListener('click', () => {
      isEnglish = true;
      langBtnEn.classList.add('active');
      langBtnZh.classList.remove('active');
      speak('English mode', 'en-US');
    });
    
    langBtnZh.addEventListener('click', () => {
      isEnglish = false;
      langBtnZh.classList.add('active');
      langBtnEn.classList.remove('active');
      speak('中文模式', 'zh-TW');
    });

    // 模式切換 (保留)
    objectModeBtn.addEventListener('click', () => {
      isOCRMode = false;
      objectModeBtn.classList.add('active');
      ocrModeBtn.classList.remove('active');
      wordDisplay.textContent = '物品辨識模式 - 對準物品開始學習';
      ocrFocusArea.style.display = 'none';
      speak('物品辨識模式', 'zh-TW');
    });
    
    ocrModeBtn.addEventListener('click', () => {
      isOCRMode = true;
      ocrModeBtn.classList.add('active');
      objectModeBtn.classList.remove('active');
      wordDisplay.textContent = '字母辨識模式 - 對準英文字母開始學習';
      ocrFocusArea.style.display = 'block';
      speak('字母辨識模式', 'zh-TW');
    });

    // 遊戲模式 (保留)
    gameBtn.addEventListener('click', () => {
      if (isOCRMode) {
        alert('遊戲模式目前僅支援物品辨識模式');
        return;
      }
      
      isInGameMode = !isInGameMode;
      if (isInGameMode) {
        gameBtn.textContent = '退出遊戲';
        gameMode.style.display = 'block';
        startNewGame();
      } else {
        gameBtn.textContent = '🎮 遊戲模式';
        gameMode.style.display = 'none';
      }
    });

    function startNewGame() {
      const allKeys = Object.keys(itemNames);
      const candidates = allKeys.filter(k => itemNames[k] && k !== 'background');
      const randomKey = candidates[Math.floor(Math.random() * candidates.length)];
      const zh = itemNames[randomKey];
      currentTarget = randomKey;

      targetWord.textContent = zh;
      speak(`請找到 ${zh}`, 'zh-TW');
    }

    // 單字本功能 (保留)
    function addToVocab(en, zh, key) {
      if (!collectedWords.some(w => w.key === key)) {
        collectedWords.push({ en, zh, key });
        localStorage.setItem('collectedWords', JSON.stringify(collectedWords));
        renderVocabList();
      }
    }

    function renderVocabList() {
      if (collectedWords.length === 0) {
        vocabList.innerHTML = '<div class="empty-vocab">還沒有收藏單字</div>';
        return;
      }
      
      vocabList.innerHTML = collectedWords.map(w => 
        `<div class="vocab-item">
          <div><strong>${w.en}</strong> - ${w.zh}</div>
          <button class="remove-btn" onclick="removeWord('${w.key}')">❌</button>
        </div>`
      ).join('');
    }

    function removeWord(key) {
      collectedWords = collectedWords.filter(w => w.key !== key);
      localStorage.setItem('collectedWords', JSON.stringify(collectedWords));
      renderVocabList();
    }

    window.removeWord = removeWord;

    clearVocab.addEventListener('click', () => {
      if (confirm('確定要清除所有單字嗎？')) {
        collectedWords = [];
        localStorage.removeItem('collectedWords');
        renderVocabList();
      }
    });

    // --- OCR 功能 - 優化版 (保留 OCR 功能，但修復了邏輯) ---
    let lastOCRText = '';
    let ocrCooldown = 0;

    async function performOCR() {
      if (ocrCooldown > 0) {
        ocrCooldown--;
        return;
      }

      try {
        const focusWidth = 250;
        const focusHeight = 100;
        const centerX = (canvas.width - focusWidth) / 2;
        const centerY = (canvas.height - focusHeight) / 2;

        const tempCanvas = document.createElement('canvas');
        const tempCtx = tempCanvas.getContext('2d');
        tempCanvas.width = focusWidth;
        tempCanvas.height = focusHeight;
        
        tempCtx.drawImage(
          video, 
          centerX, centerY, focusWidth, focusHeight,
          0, 0, focusWidth, focusHeight
        );

        if (!ocrWorker) {
          ocrWorker = Tesseract.createWorker();
          await ocrWorker.load();
          await ocrWorker.loadLanguage('eng');
          await ocrWorker.initialize('eng');
          await ocrWorker.setParameters({
            tessedit_pageseg_mode: '6' // 統一文字塊模式
          });
        }

        const { data: { text } } = await ocrWorker.recognize(tempCanvas);
        
        // 清理文字：只保留大寫英文字母，並移除空格
        const words = text.toUpperCase().match(/[A-Z]+/g); 
        
        if (words && words.length > 0) {
          const recognizedWord = words[0]; 
          
          if (recognizedWord !== lastOCRText) {
            lastOCRText = recognizedWord;
            wordDisplay.innerHTML = `<strong>${recognizedWord}</strong>`;
            
            if (isEnglish) {
              speak(recognizedWord, 'en-US');
            }
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = '#00ff00';
            ctx.lineWidth = 3;
            ctx.strokeRect(centerX, centerY, focusWidth, focusHeight);
            ctx.fillStyle = 'white';
            ctx.font = 'bold 20px Arial';
            ctx.fillText(`辨識: ${recognizedWord}`, centerX + 10, centerY - 10);
            
            ocrCooldown = 15;
          }
        } else if (lastOCRText !== '') {
          lastOCRText = '';
          wordDisplay.innerHTML = '對準英文字母或單字開始學習';
          ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
        
        statusInfo.textContent = `OCR: ${words ? words.join(' ') : '未識別到單字'}`;
      } catch (error) {
        console.error('OCR 錯誤:', error);
        statusInfo.textContent = 'OCR錯誤';
      }
    }


    // 攝影機與偵測功能
    async function setupCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ 
          video: { 
            facingMode: 'environment',
            width: { ideal: 640 }, 
            height: { ideal: 480 } 
          } 
        });
        video.srcObject = stream;
        
        video.onloadedmetadata = () => {
          video.play();
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          detectFrame();
        };
      } catch (error) {
        console.error('無法存取攝影機:', error);
        wordDisplay.textContent = '無法存取攝影機，請確認權限設定';
      }
    }

    let lastLabel = '';
    let lastDetectionTime = 0;
    const DETECTION_INTERVAL = 500; // 檢測間隔 500ms
    let objectCooldown = 0;

    // --- 核心偵測迴圈：改用 YOLOv8Detector ---
    async function detectFrame() {
      const now = Date.now();
      
      // OCR 模式
      if (isOCRMode) {
        if (now - lastDetectionTime > 1000) { 
          lastDetectionTime = now;
          await performOCR();
        }
        requestAnimationFrame(detectFrame);
        return;
      }
      
      // 物品辨識模式 (YOLOv8)
      if (objectCooldown > 0) {
        objectCooldown--;
        requestAnimationFrame(detectFrame);
        return;
      }
      
      if (now - lastDetectionTime < DETECTION_INTERVAL) {
        requestAnimationFrame(detectFrame);
        return;
      }
      
      lastDetectionTime = now;
      
      try {
        // 使用 YOLOv8Detector 進行推理
        const predictions = await yoloDetector.detect(video); 
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        if (predictions.length > 0) {
          // 篩選出所有偵測結果
          const validPredictions = predictions.filter(pred => pred.score > CONF_THRESHOLD);

          if (validPredictions.length > 0) {
            // 找出分數最高的物體
            const bestPred = validPredictions.reduce((prev, current) => (prev.score > current.score) ? prev : current);
            
            const { class: label, score, bbox } = bestPred;
            const { en, zh, key } = getWordInfo(label);

            // 只有在物品變化時才更新顯示
            if (label !== lastLabel) {
              lastLabel = label;
              wordDisplay.innerHTML = `<strong>${en}</strong><br><span class="zh">${zh}</span>`;
              
              if (!isInGameMode) {
                addToVocab(en, zh, key);
                if (isEnglish) speak(en, 'en-US');
                else speak(zh, 'zh-TW');
              } else if (label === currentTarget || key === currentTarget) {
                speak(`答對了！這是 ${zh}`, 'zh-TW');
                setTimeout(startNewGame, 2000);
              }
              
              objectCooldown = 32; // 設置冷卻時間，避免頻繁朗讀
            }

            statusInfo.textContent = `YOLOv8 偵測到: ${zh} (${Math.round(score * 100)}%)`;

            // 畫出檢測框
            validPredictions.forEach(pred => {
              const [x, y, w, h] = pred.bbox;
              const isBest = pred === bestPred;
              
              ctx.strokeStyle = isBest ? '#ff6347' : '#3cb371';
              ctx.lineWidth = isBest ? 3 : 2;
              ctx.strokeRect(x, y, w, h);
              ctx.fillStyle = isBest ? 'rgba(255, 99, 71, 0.5)' : 'rgba(60, 179, 113, 0.5)';
              ctx.fillRect(x, y, w, 20);
              ctx.fillStyle = 'white';
              ctx.font = '12px Arial';
              const displayText = `${pred.class} (${pred.score.toFixed(2)})`;
              ctx.fillText(displayText, x + 5, y + 15);
            });
          }
        } else {
          wordDisplay.textContent = '對準物品開始學習';
          statusInfo.textContent = '未偵測到物品';
          lastLabel = '';
        }
      } catch (error) {
        console.error('YOLOv8 偵測錯誤:', error);
        statusInfo.textContent = 'YOLOv8 偵測錯誤';
      }

      requestAnimationFrame(detectFrame);
    }

    // 啟動應用 (替換舊的 loadModel)
    async function loadModel() {
      try {
        // 初始化 YOLOv8Detector 實例
        yoloDetector = new YOLOv8Detector('yolov8n.onnx'); 
        
        // 載入模型
        const success = await yoloDetector.loadModel();
        
        if (success) {
            speak('歡迎使用英文學習系統', 'zh-TW');
            setupCamera();
        } else {
            // 錯誤訊息已經在 loadModel 中更新到 UI
        }

      } catch (error) {
        console.error('啟動失敗:', error);
        wordDisplay.textContent = '系統啟動失敗，請檢查主控台';
        statusInfo.textContent = '啟動失敗';
      }
    }

    // 頁面可見性變化處理 (保留)
    document.addEventListener('visibilitychange', function() {
      if (document.hidden) {
        if (speechSynthesis.speaking) {
          speechSynthesis.cancel();
        }
      }
    });

    // 清理資源 (保留)
    window.addEventListener('beforeunload', function() {
      if (ocrWorker) {
        ocrWorker.terminate();
      }
      if (speechSynthesis.speaking) {
        speechSynthesis.cancel();
      }
    });

    // 初始化 (保留)
    renderVocabList();
    
    // 第一次點擊畫面時載入模型 (確保語音和相機權限)
    document.addEventListener('click', function init() {
      loadModel();
      document.removeEventListener('click', init);
    }, { once: true });
  </script>
</body>
</html>