<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="theme-color" content="#0ea5e9" />
  <meta name="description" content="ç›²äººè¼”åŠ©å°èˆªç³»çµ± - å³æ™‚éšœç¤™ç‰©æª¢æ¸¬èˆ‡äººå“¡è·Ÿéš¨" />
  <title>ğŸ§­ ç›²äººè¼”åŠ©å°èˆªç³»çµ±</title>
  
  <style>
    :root {
      --bg1: #0ea5e9;
      --bg2: #6366f1;
      --glass: rgba(255,255,255,0.12);
      --glass-strong: rgba(255,255,255,0.22);
      --text: #fff;
      --good: #22c55e;
      --warn: #f59e0b;
      --bad: #ef4444;
      --muted: #cbd5e1;
      --shadow: 0 10px 30px rgba(0,0,0,0.25);
    }
    
    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      overflow-x: hidden;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'PingFang TC', 'Microsoft JhengHei', sans-serif;
      color: var(--text);
      background: linear-gradient(135deg, var(--bg1), var(--bg2));
      touch-action: manipulation;
    }
    
    body {
      padding: 10px;
      padding-bottom: env(safe-area-inset-bottom, 10px);
    }
    
    .app {
      max-width: 100%;
      margin: 0 auto;
      display: grid;
      gap: 12px;
      grid-template-columns: 1fr;
    }
    
    @media (min-width: 920px) {
      .app {
        grid-template-columns: 6fr 4fr;
      }
    }
    
    .card {
      background: var(--glass);
      backdrop-filter: blur(12px);
      border-radius: 16px;
      box-shadow: var(--shadow);
      overflow: hidden;
    }
    
    header.card {
      padding: 14px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    
    header h1 {
      font-size: clamp(18px, 5vw, 24px);
      margin: 0;
      font-weight: 700;
    }
    
    .camera {
      position: relative;
      width: 100%;
      aspect-ratio: 16/9;
      background: #000;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
    }
    
    .camera video, .camera canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 12px;
    }
    
    .panel {
      padding: 16px;
    }
    
    .controls {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-bottom: 15px;
    }
    
    @media (min-width: 480px) {
      .controls {
        grid-template-columns: repeat(4, 1fr);
      }
    }
    
    button.btn {
      padding: 16px 12px;
      border: none;
      border-radius: 14px;
      font-weight: 700;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
      min-height: 54px;
      user-select: none;
    }
    
    button.btn:active {
      transform: translateY(2px) scale(0.98);
    }
    
    .primary {
      background: var(--good);
      color: #fff;
    }
    
    .warning {
      background: var(--warn);
      color: #fff;
    }
    
    .danger {
      background: var(--bad);
      color: #fff;
    }
    
    .secondary {
      background: var(--glass-strong);
      color: var(--text);
    }
    
    .status {
      display: grid;
      gap: 8px;
      grid-template-columns: repeat(2, 1fr);
      margin-bottom: 12px;
    }
    
    @media (min-width: 480px) {
      .status {
        grid-template-columns: repeat(4, 1fr);
      }
    }
    
    .status-item {
      background: var(--glass-strong);
      border-radius: 12px;
      padding: 12px;
      text-align: center;
    }
    
    .status-item .k {
      font-size: 11px;
      color: var(--muted);
      margin-bottom: 4px;
    }
    
    .status-item .v {
      font-weight: 800;
      font-size: clamp(14px, 4vw, 16px);
    }
    
    .voice-alert {
      margin: 12px 0;
      background: rgba(239,68,68,0.15);
      border: 1px solid rgba(239,68,68,0.35);
      color: #fff;
      border-radius: 12px;
      padding: 16px;
      text-align: center;
      min-height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      line-height: 1.4;
    }
    
    .list {
      max-height: 200px;
      overflow-y: auto;
      display: grid;
      gap: 6px;
      padding-right: 4px;
    }
    
    .chip {
      background: var(--glass-strong);
      padding: 10px;
      border-radius: 10px;
      font-size: 13px;
      line-height: 1.4;
    }
    
    footer {
      text-align: center;
      font-size: 11px;
      color: var(--muted);
      padding: 8px;
      margin-top: 10px;
    }
    
    .loading {
      background: linear-gradient(90deg, var(--bg1), var(--bg2), var(--bg1));
      background-size: 200% 100%;
      animation: loading 2s infinite;
    }
    
    @keyframes loading {
      0% {
        background-position: 200% 0;
      }
      100% {
        background-position: -200% 0;
      }
    }

    /* äººå“¡è·Ÿéš¨æŒ‡ç¤ºå™¨ */
    .person-tracker {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
      z-index: 25;
      display: none;
    }
    
    .person-tracker.active {
      display: block;
    }
    
    .tracking-indicator {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #22c55e;
      margin-right: 5px;
      animation: trackingPulse 1.5s infinite;
    }
    
    @keyframes trackingPulse {
      0% {
        transform: scale(1);
        opacity: 1;
      }
      50% {
        transform: scale(1.2);
        opacity: 0.7;
      }
      100% {
        transform: scale(1);
        opacity: 1;
      }
    }

    .camera-placeholder {
      text-align: center;
      padding: 20px;
    }

    .debug-info {
      font-size: 10px;
      color: var(--muted);
      margin-top: 10px;
    }
  </style>
</head>
<body class="no-select">
  <div class="app">
    <header class="card">
      <h1>ğŸ§­ ç›²äººè¼”åŠ©å°èˆª</h1>
      <div class="tips">å®‰å…¨å‡ºè¡Œ Â· äººå“¡è·Ÿéš¨ Â· æ™ºèƒ½å°èˆª</div>
    </header>

    <section class="card camera" id="cameraContainer">
      <div class="camera-placeholder" id="cameraPlaceholder">
        <div>ç›¸æ©Ÿåˆå§‹åŒ–ä¸­...</div>
        <div class="debug-info" id="cameraDebug"></div>
      </div>
      <video id="video" autoplay playsinline muted style="display: none;"></video>
      <canvas id="canvas" style="display: none;"></canvas>
      
      <!-- äººå“¡è·Ÿéš¨æŒ‡ç¤ºå™¨ -->
      <div id="personTracker" class="person-tracker">
        <span class="tracking-indicator"></span>
        <span id="trackingStatus">äººå“¡è·Ÿéš¨ä¸­</span>
      </div>
    </section>

    <section class="card panel">
      <div id="voiceAlert" class="voice-alert loading">ç³»çµ±åˆå§‹åŒ–ä¸­â€¦</div>
      
      <!-- ä¸»è¦æ§åˆ¶æŒ‰éˆ• -->
      <div class="controls">
        <button id="btnStart" class="btn primary" disabled>é–‹å§‹æª¢æ¸¬</button>
        <button id="btnVoice" class="btn secondary" disabled>èªéŸ³é–‹å•Ÿ</button>
        <button id="btnFollowPerson" class="btn warning" disabled>äººå“¡è·Ÿéš¨</button>
        <button id="btnStop" class="btn danger" disabled>åœæ­¢</button>
      </div>
      
      <!-- ç‹€æ…‹è³‡è¨Š -->
      <div class="status">
        <div class="status-item">
          <div class="k">ç³»çµ±ç‹€æ…‹</div>
          <div class="v" id="status">åˆå§‹åŒ–ä¸­</div>
        </div>
        <div class="status-item">
          <div class="k">åµæ¸¬é€Ÿåº¦</div>
          <div class="v" id="fps">â€”</div>
        </div>
        <div class="status-item">
          <div class="k">éšœç¤™ç‰©æ•¸</div>
          <div class="v" id="obstacleCount">0</div>
        </div>
        <div class="status-item">
          <div class="k">æœ€è¿‘è·é›¢</div>
          <div class="v" id="closestDistance">â€” å…¬å°º</div>
        </div>
      </div>
      
      <!-- äººå“¡è·Ÿéš¨ç‹€æ…‹ -->
      <div id="personFollowingStatus" class="status-item" style="display: none;">
        <div class="k">è·Ÿéš¨ç‹€æ…‹</div>
        <div class="v" id="followingStatus">--</div>
      </div>
    </section>

    <aside class="card panel">
      <h3 style="margin:0 0 12px 0; font-size:16px;">
        å³æ™‚åµæ¸¬ <span id="activeModuleTag" class="module-tag">æº–å‚™ä¸­</span>
      </h3>
      <div id="detectionList" class="list">
        <div class="chip" style="text-align:center; color:var(--muted);">
          ç³»çµ±åˆå§‹åŒ–ä¸­â€¦
        </div>
      </div>
      <footer>
        å°ˆç‚ºè¦–éšœæœ‹å‹è¨­è¨ˆ Â· äººå“¡è·Ÿéš¨å°èˆª<br>
        è·Ÿéš¨å‰æ–¹è¡Œäººèµ°å®‰å…¨è·¯ç·šå›å®¶
      </footer>
    </aside>
  </div>

  <script>
    // ç°¡å–®çš„äººå“¡è·Ÿéš¨ç³»çµ±
    class SimplePersonFollower {
      constructor() {
        this.isFollowing = false;
        this.targetPerson = null;
        this.lastGuidanceTime = 0;
        this.guidanceCooldown = 5000; // 5ç§’å°èˆªå†·å»
      }

      startFollowing() {
        this.isFollowing = true;
        this.showTrackingIndicator();
        this.speak('äººå“¡è·Ÿéš¨æ¨¡å¼å·²å•Ÿå‹•ï¼Œæ­£åœ¨å°‹æ‰¾å¯è·Ÿéš¨çš„è¡Œäºº');
      }

      stopFollowing() {
        this.isFollowing = false;
        this.targetPerson = null;
        this.hideTrackingIndicator();
        this.speak('äººå“¡è·Ÿéš¨æ¨¡å¼å·²åœæ­¢');
      }

      updatePersonFollowing(persons) {
        if (!this.isFollowing) return;

        if (persons.length === 0) {
          if (this.targetPerson) {
            this.speak('è·Ÿéš¨ç›®æ¨™ä¸Ÿå¤±ï¼Œè«‹åœ¨åŸåœ°ç­‰å¾…');
            this.targetPerson = null;
          }
          this.updateFollowingStatus('å°‹æ‰¾ä¸­');
          return;
        }

        // é¸æ“‡æœ€è¿‘çš„è¡Œäºº
        const closestPerson = persons.reduce((closest, person) => {
          return person.distance < closest.distance ? person : closest;
        });

        this.targetPerson = closestPerson;
        this.provideGuidance(closestPerson);
        this.updateFollowingStatus(`è·Ÿéš¨ä¸­ ${closestPerson.distance.toFixed(1)}m`);
      }

      provideGuidance(person) {
        const now = Date.now();
        if (now - this.lastGuidanceTime < this.guidanceCooldown) return;

        let message = '';
        const distance = person.distance;

        if (distance < 2) {
          message = 'è·Ÿéš¨ç›®æ¨™å¾ˆè¿‘ï¼Œè«‹æ”¾æ…¢é€Ÿåº¦ä¿æŒå®‰å…¨è·é›¢';
        } else if (distance < 5) {
          message = 'è·Ÿéš¨è·é›¢è‰¯å¥½ï¼Œè«‹ä¿æŒç•¶å‰é€Ÿåº¦';
        } else {
          message = 'è·Ÿéš¨ç›®æ¨™è¼ƒé ï¼Œè«‹é©ç•¶åŠ å¿«è…³æ­¥';
        }

        this.speak(message);
        this.lastGuidanceTime = now;
      }

      showTrackingIndicator() {
        const tracker = document.getElementById('personTracker');
        const statusElement = document.getElementById('personFollowingStatus');
        if (tracker) tracker.classList.add('active');
        if (statusElement) statusElement.style.display = 'block';
      }

      hideTrackingIndicator() {
        const tracker = document.getElementById('personTracker');
        const statusElement = document.getElementById('personFollowingStatus');
        if (tracker) tracker.classList.remove('active');
        if (statusElement) statusElement.style.display = 'none';
      }

      updateFollowingStatus(status) {
        const statusElement = document.getElementById('followingStatus');
        const trackerStatus = document.getElementById('trackingStatus');
        
        if (statusElement) statusElement.textContent = status;
        if (trackerStatus) trackerStatus.textContent = status;
      }

      speak(message) {
        if (window.speechSynthesis) {
          window.speechSynthesis.cancel();
          const utterance = new SpeechSynthesisUtterance(message);
          utterance.lang = 'zh-TW';
          utterance.rate = 0.8;
          window.speechSynthesis.speak(utterance);
        }
        this.updateVoiceAlert(message);
      }

      updateVoiceAlert(message) {
        const voiceAlert = document.getElementById('voiceAlert');
        if (voiceAlert) {
          voiceAlert.textContent = message;
          voiceAlert.classList.remove('loading');
        }
      }
    }

    // æ¨¡æ“¬æª¢æ¸¬ç³»çµ±
    class SimulationDetector {
      constructor() {
        this.isDetecting = false;
        this.lastDetectionTime = 0;
        this.detectionInterval = 1000; // 1ç§’æª¢æ¸¬é–“éš”
        this.personFollower = new SimplePersonFollower();
      }

      async startDetection() {
        this.isDetecting = true;
        this.updateStatus('æ¨¡æ“¬æª¢æ¸¬ä¸­');
        this.speak('æ¨¡æ“¬æª¢æ¸¬æ¨¡å¼å•Ÿå‹•ï¼Œé–‹å§‹äººå“¡è·Ÿéš¨æª¢æ¸¬');
        this.enableControls();
        this.startSimulationLoop();
      }

      stopDetection() {
        this.isDetecting = false;
        this.updateStatus('å·²åœæ­¢');
        this.speak('æª¢æ¸¬å·²åœæ­¢');
        this.personFollower.stopFollowing();
      }

      startSimulationLoop() {
        if (!this.isDetecting) return;

        const now = Date.now();
        if (now - this.lastDetectionTime < this.detectionInterval) {
          requestAnimationFrame(() => this.startSimulationLoop());
          return;
        }

        this.lastDetectionTime = now;

        // æ¨¡æ“¬æª¢æ¸¬çµæœ
        this.simulateDetection();
        
        // æ›´æ–°FPSé¡¯ç¤º
        this.updateFPS();

        requestAnimationFrame(() => this.startSimulationLoop());
      }

      simulateDetection() {
        // éš¨æ©Ÿç”Ÿæˆæ¨¡æ“¬æª¢æ¸¬çµæœ
        const hasPerson = Math.random() > 0.3; // 70% æ©Ÿç‡æª¢æ¸¬åˆ°è¡Œäºº
        const persons = [];

        if (hasPerson) {
          const distance = 2 + Math.random() * 8; // 2-10å…¬å°º
          persons.push({
            class: 'person',
            distance: distance,
            score: 0.7 + Math.random() * 0.3
          });
        }

        // æ›´æ–°é¡¯ç¤º
        this.updateDetectionDisplay(persons);

        // æ›´æ–°äººå“¡è·Ÿéš¨
        if (this.personFollower.isFollowing) {
          this.personFollower.updatePersonFollowing(persons);
        }
      }

      updateDetectionDisplay(persons) {
        const obstacleCount = persons.length;
        const list = document.getElementById('detectionList');
        const countElement = document.getElementById('obstacleCount');
        const distanceElement = document.getElementById('closestDistance');

        countElement.textContent = obstacleCount;

        if (obstacleCount > 0) {
          const closest = persons.reduce((closest, person) => 
            person.distance < closest.distance ? person : closest
          );
          
          distanceElement.textContent = closest.distance.toFixed(1) + ' å…¬å°º';
          
          list.innerHTML = persons.map(person => `
            <div class="chip" style="border-left: 4px solid var(--warn)">
              <strong>è¡Œäºº</strong><br>
              è·é›¢: ${person.distance.toFixed(1)}å…¬å°º | ç½®ä¿¡åº¦: ${(person.score * 100).toFixed(0)}%
            </div>
          `).join('');
        } else {
          distanceElement.textContent = 'â€” å…¬å°º';
          list.innerHTML = '<div class="chip" style="text-align:center; color:var(--muted);">æœªåµæ¸¬åˆ°è¡Œäºº</div>';
        }
      }

      updateFPS() {
        // æ¨¡æ“¬FPSé¡¯ç¤º
        document.getElementById('fps').textContent = '8-12fps';
      }

      updateStatus(status) {
        document.getElementById('status').textContent = status;
      }

      speak(message) {
        if (window.speechSynthesis) {
          window.speechSynthesis.cancel();
          const utterance = new SpeechSynthesisUtterance(message);
          utterance.lang = 'zh-TW';
          utterance.rate = 0.8;
          window.speechSynthesis.speak(utterance);
        }
        this.updateVoiceAlert(message);
      }

      updateVoiceAlert(message) {
        const voiceAlert = document.getElementById('voiceAlert');
        if (voiceAlert) {
          voiceAlert.textContent = message;
          voiceAlert.classList.remove('loading');
        }
      }

      enableControls() {
        document.getElementById('btnStart').disabled = true;
        document.getElementById('btnStop').disabled = false;
        document.getElementById('btnVoice').disabled = false;
        document.getElementById('btnFollowPerson').disabled = false;
      }
    }

    // å…¨å±€è®Šæ•¸
    let detector = new SimulationDetector();
    let isInitialized = false;

    // åˆå§‹åŒ–å‡½æ•¸
    function initializeApp() {
      if (isInitialized) return;
      
      updateVoiceAlert('ç³»çµ±å•Ÿå‹•ä¸­ï¼Œè«‹ç¨å€™...');
      
      // åˆå§‹åŒ–èªéŸ³åˆæˆ
      initializeSpeechSynthesis();
      
      // è¨­ç½®äº‹ä»¶ç›£è½å™¨
      setupEventListeners();
      
      // å˜—è©¦åˆå§‹åŒ–ç›¸æ©Ÿï¼ˆä½†ä½¿ç”¨æ¨¡æ“¬æ¨¡å¼ä½œç‚ºå¾Œå‚™ï¼‰
      initializeCamera().then(success => {
        if (success) {
          updateVoiceAlert('ç›¸æ©Ÿåˆå§‹åŒ–æˆåŠŸï¼Œç³»çµ±æº–å‚™å°±ç·’');
        } else {
          updateVoiceAlert('ä½¿ç”¨æ¨¡æ“¬æª¢æ¸¬æ¨¡å¼ï¼Œç³»çµ±æº–å‚™å°±ç·’');
        }
        
        enableStartButton();
        updateStatus('æº–å‚™å°±ç·’');
        isInitialized = true;
      });
    }

    function initializeSpeechSynthesis() {
      if (!window.speechSynthesis) {
        console.warn('èªéŸ³åˆæˆä¸æ”¯æŒ');
        return;
      }
      
      // æ¸¬è©¦èªéŸ³åˆæˆ
      const utterance = new SpeechSynthesisUtterance(' ');
      utterance.lang = 'zh-TW';
      window.speechSynthesis.speak(utterance);
    }

    function setupEventListeners() {
      document.getElementById('btnStart').addEventListener('click', () => {
        detector.startDetection();
      });
      
      document.getElementById('btnStop').addEventListener('click', () => {
        detector.stopDetection();
      });
      
      document.getElementById('btnVoice').addEventListener('click', toggleVoice);
      
      document.getElementById('btnFollowPerson').addEventListener('click', togglePersonFollowing);
    }

    function toggleVoice() {
      const button = document.getElementById('btnVoice');
      const voiceEnabled = button.textContent === 'èªéŸ³é—œé–‰';
      
      if (voiceEnabled) {
        button.textContent = 'èªéŸ³é–‹å•Ÿ';
        button.classList.remove('secondary');
        button.classList.add('warning');
        window.speechSynthesis.cancel();
      } else {
        button.textContent = 'èªéŸ³é—œé–‰';
        button.classList.remove('warning');
        button.classList.add('secondary');
        detector.speak('èªéŸ³æç¤ºå·²é–‹å•Ÿ');
      }
    }

    function togglePersonFollowing() {
      const button = document.getElementById('btnFollowPerson');
      
      if (detector.personFollower.isFollowing) {
        detector.personFollower.stopFollowing();
        button.textContent = 'äººå“¡è·Ÿéš¨';
        button.classList.remove('gps-active');
      } else {
        detector.personFollower.startFollowing();
        button.textContent = 'åœæ­¢è·Ÿéš¨';
        button.classList.add('gps-active');
      }
    }

    async function initializeCamera() {
      const video = document.getElementById('video');
      const placeholder = document.getElementById('cameraPlaceholder');
      const debugInfo = document.getElementById('cameraDebug');
      
      try {
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          throw new Error('ç›¸æ©ŸAPIä¸æ”¯æŒ');
        }
        
        const stream = await navigator.mediaDevices.getUserMedia({ 
          video: { 
            facingMode: 'environment',
            width: { ideal: 640 },
            height: { ideal: 480 }
          } 
        });
        
        video.srcObject = stream;
        video.style.display = 'block';
        placeholder.style.display = 'none';
        
        debugInfo.textContent = 'ç›¸æ©Ÿåˆå§‹åŒ–æˆåŠŸ';
        return true;
        
      } catch (error) {
        console.warn('ç›¸æ©Ÿåˆå§‹åŒ–å¤±æ•—:', error);
        debugInfo.textContent = `ç›¸æ©Ÿä¸å¯ç”¨: ${error.message}`;
        return false;
      }
    }

    function enableStartButton() {
      document.getElementById('btnStart').disabled = false;
    }

    function updateVoiceAlert(message) {
      const voiceAlert = document.getElementById('voiceAlert');
      if (voiceAlert) {
        voiceAlert.textContent = message;
        voiceAlert.classList.remove('loading');
      }
    }

    function updateStatus(status) {
      document.getElementById('status').textContent = status;
    }

    // å•Ÿå‹•æ‡‰ç”¨
    window.addEventListener('DOMContentLoaded', () => {
      setTimeout(() => {
        initializeApp();
      }, 1000);
    });

    // é˜²æ­¢é é¢ä¼‘çœ 
    let wakeLock = null;
    async function requestWakeLock() {
      try {
        if ('wakeLock' in navigator) {
          wakeLock = await navigator.wakeLock.request('screen');
        }
      } catch (err) {
        console.log('Wake Lock å¤±æ•—:', err.message);
      }
    }

    document.addEventListener('visibilitychange', async () => {
      if (document.visibilityState === 'visible') {
        await requestWakeLock();
      }
    });

    requestWakeLock();
  </script>
</body>
</html>