<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="theme-color" content="#0ea5e9" />
  <meta name="description" content="æ™ºèƒ½é¿éšœå°èˆªç³»çµ± - å³æ™‚éšœç¤™ç‰©æª¢æ¸¬èˆ‡GPSè¿”èˆª" />
  <title>ğŸ§­ æ™ºèƒ½é¿éšœå°èˆªç³»çµ±</title>
  
  <!-- æ·»åŠ TensorFlow.jså’ŒSSDæ¨¡å‹ -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.18.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/ssd@3.0.0/dist/ssd.min.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Microsoft JhengHei', sans-serif;
      background: linear-gradient(135deg, #0ea5e9, #6366f1);
      color: white;
      height: 100vh;
      padding: 0;
      overflow: hidden;
    }
    
    .container {
      display: flex;
      flex-direction: column;
      height: 100%;
      gap: 0;
    }
    
    .header {
      text-align: center;
      padding: 12px 10px;
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(10px);
      flex-shrink: 0;
    }
    
    .header h1 {
      font-size: 16px;
      margin-bottom: 2px;
    }
    
    .header .subtitle {
      font-size: 11px;
      opacity: 0.8;
    }
    
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 5px;
      padding: 5px;
      min-height: 0;
    }
    
    .camera-view {
      flex: 0 0 35vh;
      background: #000;
      border-radius: 8px;
      position: relative;
      overflow: hidden;
    }
    
    .camera-view video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }
    
    /* æ”¹é€²çš„å°èˆªç·šæ¢ */
    .safety-path {
      position: absolute;
      top: 20%;
      height: 60%;
      width: 60%;
      left: 20%;
      background: linear-gradient(90deg, 
        transparent 0%, 
        rgba(34, 197, 94, 0.3) 20%, 
        rgba(34, 197, 94, 0.5) 50%, 
        rgba(34, 197, 94, 0.3) 80%, 
        transparent 100%);
      border-left: 2px dashed #22c55e;
      border-right: 2px dashed #22c55e;
    }
    
    .danger-zone {
      position: absolute;
      background: rgba(239, 68, 68, 0.3);
      border: 1px solid rgba(239, 68, 68, 0.6);
      border-radius: 4px;
    }
    
    .danger-zone.left {
      left: 5%;
      top: 25%;
      width: 15%;
      height: 50%;
    }
    
    .danger-zone.right {
      right: 5%;
      top: 25%;
      width: 15%;
      height: 50%;
    }
    
    .danger-zone.front {
      left: 30%;
      top: 10%;
      width: 40%;
      height: 20%;
    }
    
    .obstacle-marker {
      position: absolute;
      width: 20px;
      height: 20px;
      background: rgba(239, 68, 68, 0.8);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      animation: obstaclePulse 2s infinite;
    }
    
    @keyframes obstaclePulse {
      0% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
      50% { transform: translate(-50%, -50%) scale(1.2); opacity: 0.7; }
      100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
    }
    
    .status-panel {
      background: rgba(255,255,255,0.1);
      border-radius: 8px;
      padding: 8px;
      backdrop-filter: blur(10px);
      flex-shrink: 0;
    }
    
    .status-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px;
      margin-bottom: 6px;
    }
    
    .status-item {
      text-align: center;
      padding: 6px;
      background: rgba(255,255,255,0.1);
      border-radius: 6px;
    }
    
    .status-label {
      font-size: 9px;
      opacity: 0.8;
      margin-bottom: 2px;
    }
    
    .status-value {
      font-size: 12px;
      font-weight: bold;
    }
    
    .voice-alert {
      background: rgba(239, 68, 68, 0.2);
      border: 1px solid rgba(239, 68, 68, 0.5);
      border-radius: 6px;
      padding: 8px;
      text-align: center;
      min-height: 35px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      flex-shrink: 0;
    }
    
    .controls {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px;
      flex-shrink: 0;
    }
    
    .btn {
      padding: 12px 6px;
      border: none;
      border-radius: 8px;
      font-size: 12px;
      font-weight: bold;
      color: white;
      cursor: pointer;
      transition: all 0.2s;
      min-height: 44px;
    }
    
    .btn:active {
      transform: scale(0.95);
    }
    
    .btn-primary {
      background: #22c55e;
    }
    
    .btn-warning {
      background: #f59e0b;
    }
    
    .btn-danger {
      background: #ef4444;
    }
    
    .btn-secondary {
      background: rgba(255,255,255,0.2);
    }
    
    .btn-info {
      background: #3b82f6;
    }
    
    .btn-active {
      box-shadow: 0 0 0 2px rgba(255,255,255,0.3);
    }
    
    .tracking-indicator {
      position: absolute;
      top: 4px;
      right: 4px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 9px;
      display: none;
    }
    
    .tracking-indicator.active {
      display: block;
    }
    
    .direction-arrow {
      position: absolute;
      top: 4px;
      left: 4px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 9px;
      display: none;
    }
    
    .direction-arrow.active {
      display: block;
    }
    
    .distance-badge {
      position: absolute;
      bottom: 4px;
      left: 4px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 9px;
    }
    
    /* æ¨¡å¼é¸æ“‡æŒ‰éˆ• */
    .mode-selector {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px;
      margin-bottom: 6px;
      flex-shrink: 0;
    }

    .mode-btn {
      padding: 10px 6px;
      border: none;
      border-radius: 8px;
      font-size: 11px;
      font-weight: bold;
      color: white;
      cursor: pointer;
      background: rgba(255,255,255,0.2);
      min-height: 40px;
    }

    .mode-btn.active {
      background: #3b82f6;
      box-shadow: 0 0 0 2px rgba(255,255,255,0.3);
    }

    /* ç·Šæ€¥æŒ‰éˆ• */
    .emergency-section {
      margin-top: 6px;
      flex-shrink: 0;
    }

    .emergency-btn {
      width: 100%;
      padding: 12px;
      background: #ef4444;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: bold;
      min-height: 50px;
    }

    /* é¿éšœæŒ‡ç¤ºå™¨ */
    .avoidance-indicator {
      position: absolute;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 6px 12px;
      border-radius: 15px;
      font-size: 10px;
      display: none;
    }
    
    .avoidance-indicator.active {
      display: block;
    }

    /* è·¯å¾‘å»ºè­°ç®­é ­ */
    .path-arrow {
      position: absolute;
      top: 50%;
      font-size: 24px;
      color: #22c55e;
      display: none;
    }
    
    .path-arrow.active {
      display: block;
    }
    
    .path-arrow.left {
      left: 30%;
      transform: translateY(-50%) rotate(180deg);
    }
    
    .path-arrow.right {
      right: 30%;
      transform: translateY(-50%);
    }
    
    .path-arrow.forward {
      left: 50%;
      top: 70%;
      transform: translateX(-50%) rotate(0deg);
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ§­ ç›²äººå°èˆªåŠ©æ‰‹</h1>
      <div class="subtitle">æ™ºèƒ½é¿éšœ Â· å®‰å…¨å°èˆª</div>
    </div>
    
    <div class="main-content">
      <!-- æ¨¡å¼é¸æ“‡ -->
      <div class="mode-selector">
        <button class="mode-btn active" id="btnOutdoorMode">å®¤å¤–å°èˆª</button>
        <button class="mode-btn" id="btnIndoorMode">å®¤å…§é¿éšœ</button>
      </div>

      <!-- ç›¸æ©Ÿç•«é¢ -->
      <div class="camera-view">
        <video id="video" autoplay playsinline muted></video>
        <div class="overlay">
          <!-- å®‰å…¨è·¯å¾‘ -->
          <div class="safety-path"></div>
          
          <!-- å±éšªå€åŸŸ -->
          <div class="danger-zone left"></div>
          <div class="danger-zone right"></div>
          <div class="danger-zone front"></div>
          
          <!-- éšœç¤™ç‰©æ¨™è¨˜ -->
          <div id="obstacleMarkers"></div>
          
          <!-- è·¯å¾‘å»ºè­°ç®­é ­ -->
          <div class="path-arrow left" id="arrowLeft">â¡ï¸</div>
          <div class="path-arrow right" id="arrowRight">â¡ï¸</div>
          <div class="path-arrow forward" id="arrowForward">â¬†ï¸</div>
        </div>
        
        <div class="tracking-indicator" id="trackingIndicator">
          ğŸ‘¤ è·Ÿéš¨ä¸­ <span id="trackingDistance">0m</span>
        </div>
        <div class="direction-arrow" id="directionArrow">
          ğŸ  <span id="homeDirection">--</span>
        </div>
        <div class="distance-badge" id="distanceBadge">
          ğŸ“ è·å®¶: <span id="homeDistance">--</span>
        </div>
        <div class="avoidance-indicator" id="avoidanceIndicator">
          ğŸš§ é¿éšœæ¨¡å¼å•Ÿå‹•
        </div>
      </div>
      
      <!-- æ§åˆ¶å€åŸŸ -->
      <div class="control-section">
        <!-- ç‹€æ…‹è³‡è¨Š -->
        <div class="status-panel">
          <div class="status-grid">
            <div class="status-item">
              <div class="status-label">ç³»çµ±ç‹€æ…‹</div>
              <div class="status-value" id="systemStatus">æº–å‚™ä¸­</div>
            </div>
            <div class="status-item">
              <div class="status-label">é¿éšœå»ºè­°</div>
              <div class="status-value" id="avoidanceAdvice">--</div>
            </div>
            <div class="status-item">
              <div class="status-label">æœ€è¿‘éšœç¤™ç‰©</div>
              <div class="status-value" id="closestObstacle">-- å…¬å°º</div>
            </div>
            <div class="status-item">
              <div class="status-label">å®‰å…¨æŒ‡æ•¸</div>
              <div class="status-value" id="safetyScore">--%</div>
            </div>
          </div>
          
          <!-- èªéŸ³æ’­å ±æ§åˆ¶ -->
          <div style="display: flex; gap: 6px; margin-bottom: 6px;">
            <button class="btn btn-secondary" onclick="navSystem.speakEnvironmentStatus()" style="flex: 1; font-size: 11px; padding: 8px 6px;">
              ğŸ”Š æ’­å ±ç’°å¢ƒ
            </button>
            <button class="btn btn-secondary" onclick="navSystem.toggleVoice()" style="flex: 1; font-size: 11px; padding: 8px 6px;">
              <span id="voiceToggleText">ğŸ”‡ éœéŸ³</span>
            </button>
          </div>
          
          <div class="voice-alert" id="voiceAlert">
            è«‹å…ˆè¨­å®šå®¶çš„ä½ç½®
          </div>
        </div>
        
        <!-- ä¸»è¦æ§åˆ¶æŒ‰éˆ• -->
        <div class="controls">
          <button class="btn btn-primary" id="btnStart">é–‹å§‹å°èˆª</button>
          <button class="btn btn-warning" id="btnFollow">äººå“¡è·Ÿéš¨</button>
          <button class="btn btn-info" id="btnSetHome">ğŸ“ è¨­å®šå®¶çš„ä½ç½®</button>
          <button class="btn btn-danger" id="btnStop">åœæ­¢</button>
        </div>

        <!-- ç·Šæ€¥æ±‚åŠ© -->
        <div class="emergency-section">
          <button class="emergency-btn" id="btnEmergency">ğŸ†˜ ç·Šæ€¥æ±‚åŠ©</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // æ™ºèƒ½é¿éšœå°èˆªç³»çµ±
    class ObstacleAvoidanceSystem {
      constructor() {
        this.isNavigating = false;
        this.isFollowing = false;
        this.isIndoorMode = false;
        this.homePosition = null;
        this.currentPosition = null;
        this.voiceEnabled = true;
        this.obstacles = [];
        this.lastObstacleScan = 0;
        this.obstacleScanInterval = 2000; // 2ç§’æƒæä¸€æ¬¡
        // æ·»åŠ æ–°å±¬æ€§
        this.model = null; // å°è±¡æª¢æ¸¬æ¨¡å‹å¯¦ä¾‹
        this.videoWidth = 0; // ç›¸æ©Ÿç•«é¢å¯¬åº¦
        this.videoHeight = 0; // ç›¸æ©Ÿç•«é¢é«˜åº¦
        this.lastDetectedObstacles = []; // è·Ÿè¹¤æ­·å²éšœç¤™ç‰©æ•¸æ“šï¼ˆåˆ¤æ–·å‹•æ…‹ï¼‰
        this.scanInterval = null; // éšœç¤™ç‰©æª¢æ¸¬å¾ªç’°
        this.detectionCanvas = document.createElement('canvas'); // ç”¨æ–¼å°è±¡æª¢æ¸¬çš„ç•«å¸ƒ
        this.isCameraInitialized = false; // ç›¸æ©Ÿåˆå§‹åŒ–ç‹€æ…‹
        this.lastSpeakTime = 0; // æœ€å¾ŒèªéŸ³æç¤ºæ™‚é–“ï¼ˆé˜²æ­¢éåº¦æç¤ºï¼‰
        
        this.loadHomePosition();
        this.initModel(); // åˆå§‹åŒ–æ¨¡å‹ï¼ˆç•°æ­¥ï¼Œéœ€è™•ç†ï¼‰
      }
      
      // åˆå§‹åŒ–å°è±¡æª¢æ¸¬æ¨¡å‹
      async initModel() {
        try {
          this.model = await tf.ssd.load(); // åŠ è¼‰SSDæ¨¡å‹ï¼ˆåŒ…å«é è¨“ç·´æ¬Šé‡ï¼‰
          console.log('å°è±¡æª¢æ¸¬æ¨¡å‹åŠ è¼‰å®Œæˆ');
          // è‹¥æ¨¡å‹åŠ è¼‰æˆåŠŸï¼Œå¯èƒ½éœ€è¦èª¿æ•´å…¶ä»–é‚è¼¯ï¼ˆå¦‚å•Ÿç”¨ç›¸æ©Ÿï¼‰
        } catch (error) {
          console.error('æ¨¡å‹åŠ è¼‰å¤±æ•—ï¼Œå›é€€æ¨¡æ“¬æ•¸æ“š:', error);
          this.model = null;
        }
      }
      
      // åˆ‡æ›æ¨¡å¼
      switchMode(isIndoor) {
        this.isIndoorMode = isIndoor;
        
        document.getElementById('btnOutdoorMode').classList.toggle('active', !isIndoor);
        document.getElementById('btnIndoorMode').classList.toggle('active', isIndoor);
        
        if (isIndoor) {
          this.speak('å·²åˆ‡æ›åˆ°å®¤å…§é¿éšœæ¨¡å¼ï¼Œé–‹å§‹ç’°å¢ƒæ„ŸçŸ¥');
          document.getElementById('avoidanceIndicator').classList.add('active');
          document.getElementById('btnFollow').disabled = true;
          
          // å¦‚æœå·²ç¶“åœ¨å°èˆªä¸­ï¼Œç«‹å³å•Ÿå‹•éšœç¤™ç‰©æª¢æ¸¬
          if (this.isNavigating) {
            this.startObstacleDetection();
          }
        } else {
          this.speak('å·²åˆ‡æ›åˆ°å®¤å¤–å°èˆªæ¨¡å¼');
          document.getElementById('avoidanceIndicator').classList.remove('active');
          document.getElementById('btnFollow').disabled = !this.isNavigating;
          
          // åœæ­¢å®¤å…§æ¨¡å¼çš„é »ç¹æª¢æ¸¬
          if (this.scanInterval) {
            clearInterval(this.scanInterval);
            this.scanInterval = null;
          }
        }
      }
      
      // é–‹å§‹éšœç¤™ç‰©æª¢æ¸¬å¾ªç’°ï¼ˆæ·»åŠ ï¼‰
      startObstacleDetection() {
        if (this.scanInterval) clearInterval(this.scanInterval); // æ¸…é™¤ä¹‹å‰çš„å¾ªç’°
        this.scanInterval = setInterval(async () => {
          if (this.isNavigating && this.isIndoorMode) { // å®¤å…§æ¨¡å¼ä¸”å°èˆªä¸­æ™‚æª¢æ¸¬
            await this.detectObstacles(); // èª¿ç”¨çœŸå¯¦æª¢æ¸¬æ–¹æ³•
            this.provideAvoidanceGuidance();
          }
        }, this.obstacleScanInterval); // æ¯2ç§’æª¢æ¸¬ä¸€æ¬¡
      }
      
      
      // çœŸå¯¦éšœç¤™ç‰©æª¢æ¸¬
      async detectObstacles() {
        // æª¢æŸ¥æ˜¯å¦æ­£åœ¨å°èˆªä¸”åœ¨å®¤å…§æ¨¡å¼
        if (!this.isNavigating || !this.isIndoorMode) {
          return;
        }

        // æª¢æŸ¥æ¨¡å‹æ˜¯å¦å·²åŠ è¼‰
        if (!this.model) { 
          // æ¨¡å‹ä¸å¯ç”¨æ™‚å›é€€æ¨¡æ“¬
          this.scanEnvironment(); // åŸæœ‰æ¨¡æ“¬æ–¹æ³•
          return;
        }

        const video = document.getElementById('video');
        if (!video || !video.srcObject || !video.videoWidth || !video.videoHeight) {
          console.warn('ç›¸æ©Ÿæœªæº–å‚™å¥½');
          // å›é€€åˆ°æ¨¡æ“¬æ•¸æ“š
          this.scanEnvironment();
          return;
        }

        try {
          // æ›´æ–°è¦–é »å°ºå¯¸
          this.videoWidth = video.videoWidth;
          this.videoHeight = video.videoHeight;
          
          // è¨­ç½®ç•«å¸ƒå°ºå¯¸ï¼ˆæ ¹æ“šè¨­å‚™èª¿æ•´ï¼‰
          const targetWidth = Math.min(this.videoWidth, 320); // é™ä½åˆ†è¾¨ç‡ä»¥æé«˜æ€§èƒ½
          const targetHeight = Math.floor((targetWidth / this.videoWidth) * this.videoHeight);
          
          this.detectionCanvas.width = targetWidth;
          this.detectionCanvas.height = targetHeight;
          
          const ctx = this.detectionCanvas.getContext('2d');
          // æ·»åŠ åœ–åƒé è™•ç†ï¼ˆæé«˜æª¢æ¸¬æº–ç¢ºåº¦ï¼‰
          ctx.filter = 'brightness(1.1) contrast(1.1)';
          
          // ç¹ªè£½ç•¶å‰å¹€åˆ°ç•«å¸ƒ
          ctx.drawImage(video, 0, 0, this.detectionCanvas.width, this.detectionCanvas.height);

          // é‹è¡Œæ¨¡å‹é æ¸¬ï¼ˆç²å–ç•«é¢ä¸­çš„éšœç¤™ç‰©ï¼‰
          const predictions = await this.model.detect(this.detectionCanvas);
          
          // éæ¿¾é‡è¤‡æª¢æ¸¬ï¼ˆæ ¹æ“šIOUï¼‰
          const filteredPredictions = this.nonMaxSuppression(predictions);
          
          // è™•ç†é æ¸¬çµæœç‚ºç³»çµ±å¯ç”¨çš„éšœç¤™ç‰©æ•¸æ“š
          this.processPredictions(filteredPredictions);
        } catch (error) {
          console.error('éšœç¤™ç‰©æª¢æ¸¬å¤±æ•—:', error);
          // å‡ºéŒ¯æ™‚å›é€€åˆ°æ¨¡æ“¬æ•¸æ“š
          this.scanEnvironment();
        }
      }
      
      // éæ¥µå¤§å€¼æŠ‘åˆ¶ï¼ˆNMSï¼‰ä¾†éæ¿¾é‡è¤‡æª¢æ¸¬
      nonMaxSuppression(predictions, iouThreshold = 0.5) {
        // æŒ‰ç½®ä¿¡åº¦æ’åº
        predictions.sort((a, b) => b.score - a.score);
        
        const result = [];
        const usedBoxes = [];
        
        for (const pred of predictions) {
          const predBox = pred.bbox;
          let overlap = false;
          
          for (const usedBox of usedBoxes) {
            // è¨ˆç®—IOUï¼ˆäº¤ä¸¦æ¯”ï¼‰
            const iou = this.calculateIOU(predBox, usedBox);
            if (iou > iouThreshold) {
              overlap = true;
              break;
            }
          }
          
          if (!overlap) {
            result.push(pred);
            usedBoxes.push(predBox);
          }
        }
        
        return result;
      }
      
      // è¨ˆç®—å…©å€‹æ¡†çš„IOUï¼ˆäº¤ä¸¦æ¯”ï¼‰
      calculateIOU(boxA, boxB) {
        // boxæ ¼å¼: [x, y, width, height]
        const [xA, yA, wA, hA] = boxA;
        const [xB, yB, wB, hB] = boxB;
        
        // è¨ˆç®—äº¤é›†å€åŸŸ
        const x1 = Math.max(xA, xB);
        const y1 = Math.max(yA, yB);
        const x2 = Math.min(xA + wA, xB + wB);
        const y2 = Math.min(yA + hA, yB + hB);
        
        const interWidth = Math.max(0, x2 - x1);
        const interHeight = Math.max(0, y2 - y1);
        const interArea = interWidth * interHeight;
        
        // è¨ˆç®—ä¸¦é›†å€åŸŸ
        const areaA = wA * hA;
        const areaB = wB * hB;
        const unionArea = areaA + areaB - interArea;
        
        return interArea / unionArea;
      }

      // è™•ç†æ¨¡å‹é æ¸¬çµæœï¼ˆæ“´å±•åˆ°40+ç¨®å¯è­˜åˆ¥ç‰©å“ï¼‰
      processPredictions(predictions) {
        // æ“´å±•å¯è­˜åˆ¥ç‰©å“åˆ—è¡¨ï¼ˆ40+ç¨®ï¼‰
        const recognizableItems = [
          // äººç‰©å‹•ç‰©é¡
          'person', 'baby', 'child', 'adult', 'elderly', 'bird', 'cat', 'dog', 'horse', 'cow',
          
          // äº¤é€šå·¥å…·é¡
          'car', 'bus', 'truck', 'motorcycle', 'bicycle', 'train', 'airplane', 'boat', 'scooter',
          
          // å®¶å…·é¡
          'chair', 'sofa', 'couch', 'bed', 'table', 'desk', 'cabinet', 'wardrobe', 'bookshelf',
          
          // é›»å­ç”¢å“é¡
          'tv', 'computer', 'laptop', 'monitor', 'keyboard', 'mouse', 'printer', 'scanner',
          
          // åœ°é¢é¢¨éšªé¡
          'stairs', 'slope', 'hole', 'water', 'ice', 'gravel', 'oil', 'construction',
          
          // äº¤é€šè¨­æ–½é¡
          'traffic light', 'stop sign', 'crosswalk', 'bus stop', 'traffic cone', 'barricade',
          
          // å»ºç¯‰å‡ºå…¥å£é¡
          'door', 'elevator', 'automatic door', 'ramp', 'toilet', 'exit', 'entrance',
          
          // å…¶ä»–ç‰©å“é¡
          'tree', 'flower', 'fountain', 'bench', 'trash can', 'mailbox', 'fire hydrant'
        ];
        
        // éæ¿¾é«˜é¢¨éšªå°è±¡ï¼ˆä¿¡ä»»åº¦>0.6ä¸”ç‚ºå¯è­˜åˆ¥ç‰©å“ï¼‰
        const filtered = predictions.filter(p => 
          recognizableItems.includes(p.class) && p.score > 0.6
        );

        // è½‰æ›ç‚ºç³»çµ±éšœç¤™ç‰©æ•¸æ“šï¼ˆåŒ…å«é¡å‹ã€ä½ç½®ã€è·é›¢ç­‰ï¼‰
        this.obstacles = filtered.map(p => {
          const { x, y, width, height } = p.bbox; // é‚Šç•Œæ¡†ï¼ˆæ­¸ä¸€åŒ–åæ¨™ï¼Œ0-1ç¯„åœï¼‰
          const pixelX = x * canvas.width; // è½‰æ›ç‚ºåƒç´ åæ¨™
          const pixelY = y * canvas.height;
          const pixelWidth = width * canvas.width;
          const pixelHeight = height * canvas.height;

          return {
            type: p.class, // éšœç¤™ç‰©é¡å‹ï¼ˆå¦‚"person"ï¼‰
            bbox: { x: pixelX, y: pixelY, width: pixelWidth, height: pixelHeight }, // é‚Šæ¡†åƒç´ åæ¨™
            distance: this.estimateDistance(pixelHeight), // ä¼°è¨ˆçœŸå¯¦è·é›¢ï¼ˆé€šéé‚Šæ¡†é«˜åº¦ï¼‰
            position: this.calculatePosition(pixelX, pixelWidth, canvas.width), // å·¦/ä¸­/å³ä½ç½®
            danger: this.calculateDangerLevel(p), // å±éšªç­‰ç´šï¼ˆé«˜/ä¸­/ä½ï¼‰
            isMoving: this.checkMovement(p) // æ˜¯å¦å‹•æ…‹ï¼ˆéœ€è·Ÿè¸ªæ­·å²ï¼‰
          };
        });

        this.lastObstacleScan = Date.now();
        this.lastDetectedObstacles = this.obstacles; // ä¿å­˜ç•¶å‰éšœç¤™ç‰©æ•¸æ“šç”¨æ–¼å‹•æ…‹åˆ¤æ–·
        this.updateObstacleDisplay();
        this.provideAvoidanceGuidance();
      }
      
      // è¨ˆç®—éšœç¤™ç‰©ä½ç½®ï¼ˆå·¦/ä¸­/å³ï¼‰
      calculatePosition(pixelX, pixelWidth, canvasWidth) {
        const centerX = pixelX + pixelWidth / 2; // éšœç¤™ç‰©ä¸­å¿ƒXåæ¨™ï¼ˆåƒç´ ï¼‰
        const leftThreshold = canvasWidth * 0.3; // å·¦30%åˆ†ç•Œï¼ˆä¾‹ï¼šcanvasWidth=640æ™‚ï¼Œ192åƒç´ ï¼‰
        const rightThreshold = canvasWidth * 0.7; // å³70%åˆ†ç•Œï¼ˆ448åƒç´ ï¼‰

        if (centerX < leftThreshold) return 'left'; // å·¦å´å€åŸŸ
        if (centerX > rightThreshold) return 'right'; // å³å´å€åŸŸ
        return 'front'; // ä¸­é–“å€åŸŸï¼ˆè¦–ç‚ºå‰æ–¹ï¼‰
      }
      
      // ä¼°è¨ˆè·é›¢
      estimateDistance(pixelHeight) {
        // åƒæ•¸éœ€æ ¹æ“šè¨­å‚™æ ¡æº–ï¼š
        const objectActualHeight = 0.5; // å‡è¨­éšœç¤™ç‰©å¯¦éš›é«˜åº¦ï¼ˆå¦‚æ¤…å­é«˜0.5ç±³ï¼‰
        const focalLength = 500; // ç›¸æ©Ÿç„¦è·ï¼ˆåƒç´ ï¼Œéœ€é€šéè¨­å‚™æ¨™å®šç²å–ï¼‰
        
        if (pixelHeight === 0) return Infinity; // é¿å…é™¤é›¶éŒ¯èª¤
        // é æ™¯å…¬å¼ï¼šdistance = (focalLength * objectActualHeight) / pixelHeightï¼ˆç±³ï¼‰
        return (focalLength * objectActualHeight) / pixelHeight;
      }
      
      // ç²å–éšœç¤™ç‰©é¡å‹é¢¨éšªå› å­ï¼ˆæ“´å±•åˆ°40+ç¨®ç‰©å“ï¼‰
      getRiskFactor(type) {
        const riskMap = {
          // é«˜é¢¨éšªç‰©å“ï¼ˆ0.5-0.8ï¼‰
          'person': 0.8, 'baby': 0.9, 'child': 0.7, 'elderly': 0.6,
          'car': 0.8, 'bus': 0.9, 'truck': 0.9, 'motorcycle': 0.7, 'train': 1.0,
          'stairs': 0.7, 'hole': 0.8, 'ice': 0.8, 'oil': 0.7, 'construction': 0.8,
          'traffic light': 0.6, 'stop sign': 0.6, 'traffic cone': 0.5,
          
          // ä¸­é¢¨éšªç‰©å“ï¼ˆ0.3-0.5ï¼‰
          'bicycle': 0.4, 'scooter': 0.4, 'airplane': 0.5, 'boat': 0.4,
          'slope': 0.4, 'water': 0.4, 'gravel': 0.3, 'barricade': 0.4,
          'elevator': 0.4, 'automatic door': 0.4, 'ramp': 0.3,
          
          // ä½é¢¨éšªç‰©å“ï¼ˆ0.1-0.3ï¼‰
          'chair': 0.2, 'sofa': 0.2, 'couch': 0.2, 'bed': 0.2, 'table': 0.2,
          'desk': 0.2, 'cabinet': 0.2, 'wardrobe': 0.2, 'bookshelf': 0.2,
          'tv': 0.1, 'computer': 0.1, 'laptop': 0.1, 'monitor': 0.1,
          'keyboard': 0.1, 'mouse': 0.1, 'printer': 0.1, 'scanner': 0.1,
          'door': 0.2, 'toilet': 0.2, 'exit': 0.2, 'entrance': 0.2,
          'tree': 0.3, 'flower': 0.1, 'fountain': 0.2, 'bench': 0.2,
          'trash can': 0.2, 'mailbox': 0.1, 'fire hydrant': 0.3,
          'bird': 0.1, 'cat': 0.1, 'dog': 0.3, 'horse': 0.4, 'cow': 0.4,
          'crosswalk': 0.2, 'bus stop': 0.2
        };
        return riskMap[type] || 0.1; // æœªçŸ¥é¡å‹é»˜èªä½é¢¨éšª
      }

      // è¨ˆç®—è·é›¢é¢¨éšª
      calculateDistanceRisk(distance) {
        if (distance < 0.5) return 0.8; // éå¸¸è¿‘ï¼ˆ<0.5mï¼‰ï¼Œé«˜é¢¨éšª
        if (distance < 1.0) return 0.5;
        if (distance < 2.0) return 0.2;
        return 0.0; // è¶³å¤ é ï¼ˆ>2mï¼‰ï¼Œç„¡é¢¨éšª
      }

      // åˆ¤æ–·éšœç¤™ç‰©æ˜¯å¦å‹•æ…‹
      checkMovement(currentObstacle) {
        if (!this.lastDetectedObstacles.length) { // é¦–æ¬¡æª¢æ¸¬ç„¡æ­·å²æ•¸æ“š
          return false;
        }

        // æŸ¥æ‰¾ä¸Šä¸€æ¬¡æª¢æ¸¬ä¸­ç›¸åŒé¡å‹ä¸”ä½ç½®æ¥è¿‘çš„éšœç¤™ç‰©ï¼ˆç°¡åŒ–åŒ¹é…ï¼‰
        const lastObstacle = this.lastDetectedObstacles.find(o => 
          o.type === currentObstacle.class &&
          Math.abs(o.bbox.x - currentObstacle.bbox.x) < 50 && // Xåæ¨™è®ŠåŒ–é–¾å€¼ï¼ˆåƒç´ ï¼‰
          Math.abs(o.bbox.y - currentObstacle.bbox.y) < 50 // Yåæ¨™è®ŠåŒ–é–¾å€¼
        );

        if (!lastObstacle) return true; // æ–°å‡ºç¾çš„éšœç¤™ç‰©è¦–ç‚ºå‹•æ…‹

        // è¨ˆç®—ä½ç½®è®ŠåŒ–é‡ï¼ˆç¸½åƒç´ è®ŠåŒ–ï¼‰
        const deltaX = Math.abs(currentObstacle.bbox.x - lastObstacle.bbox.x);
        const deltaY = Math.abs(currentObstacle.bbox.y - lastObstacle.bbox.y);
        return deltaX + deltaY > 20; // è¶…éé–¾å€¼è¦–ç‚ºç§»å‹•
      }
      
      // æ›´æ–°éšœç¤™ç‰©é¡¯ç¤º
      updateObstacleDisplay() {
        const markersContainer = document.getElementById('obstacleMarkers');
        if (!markersContainer) return;
        
        markersContainer.innerHTML = ''; // æ¸…ç©ºèˆŠæ¨™è¨˜

        let totalRisk = 0; // ç¸½é¢¨éšªï¼ˆç”¨æ–¼è¨ˆç®—å®‰å…¨æŒ‡æ•¸ï¼‰
        let closestDistance = Infinity; // æœ€è¿‘è·é›¢
        let closestType = 'æœªçŸ¥'; // æœ€è¿‘éšœç¤™ç‰©é¡å‹
        let closestPosition = 'front'; // æœ€è¿‘éšœç¤™ç‰©ä½ç½®

        // å¦‚æœæ²’æœ‰æª¢æ¸¬åˆ°éšœç¤™ç‰©ï¼Œé¡¯ç¤ºæç¤ºä¿¡æ¯
        if (this.obstacles.length === 0) {
          document.getElementById('avoidanceAdvice').textContent = 'ç’°å¢ƒä¸­æœªæª¢æ¸¬åˆ°éšœç¤™ç‰©';
          document.getElementById('safetyScore').textContent = '100%';
          document.getElementById('closestObstacle').textContent = '-- å…¬å°º';
          
          // é¡¯ç¤ºå‰é€²ç®­é ­
          this.hideAllArrows();
          document.getElementById('arrowForward').classList.add('active');
          
          // èªéŸ³æ’­å ±ç’°å¢ƒç‹€æ…‹
          if (this.isNavigating && this.isIndoorMode) {
            this.speakEnvironmentStatus();
          }
          return;
        }

        this.obstacles.forEach(obstacle => {
          // è¨ˆç®—é¡å‹é¢¨éšªï¼ˆä¸åŒéšœç¤™ç‰©é¡å‹é¢¨éšªä¸åŒï¼‰
          const typeRisk = this.getRiskFactor(obstacle.type);
          // è¨ˆç®—è·é›¢é¢¨éšªï¼ˆè¶Šè¿‘é¢¨éšªè¶Šé«˜ï¼‰
          const distanceRisk = this.calculateDistanceRisk(obstacle.distance);
          // å‹•æ…‹é¢¨éšªï¼ˆå‹•æ…‹éšœç¤™ç‰©å¢åŠ 30%é¢¨éšªï¼‰
          const dynamicRisk = obstacle.isMoving ? 0.3 : 0;

          // ç¸½é¢¨éšªè²¢ç»ï¼šé¡å‹é¢¨éšª * ï¼ˆè·é›¢é¢¨éšª + å‹•æ…‹é¢¨éšªï¼‰
          const riskContribution = typeRisk * (distanceRisk + dynamicRisk);
          totalRisk += riskContribution;

          // æ›´æ–°æœ€è¿‘éšœç¤™ç‰©
          if (obstacle.distance < closestDistance) {
            closestDistance = obstacle.distance;
            closestType = obstacle.type;
            closestPosition = obstacle.position;
          }

          // å‰µå»ºéšœç¤™ç‰©æ¨™è¨˜ï¼ˆæ ¹æ“šçœŸå¯¦é‚Šæ¡†ä½ç½®æ¸²æŸ“ï¼‰
          const marker = document.createElement('div');
          marker.className = 'obstacle-marker';
          
          // æ ¹æ“šéšœç¤™ç‰©å¤§å°èª¿æ•´æ¨™è¨˜å°ºå¯¸
          const sizeFactor = Math.max(0.5, 1 - (obstacle.distance / 5)); // æœ€å¤§è·é›¢5ç±³
          const markerSize = 20 * sizeFactor;
          marker.style.width = `${markerSize}px`;
          marker.style.height = `${markerSize}px`;
          
          // æ¨™è¨˜ä½ç½®ï¼šé‚Šæ¡†ä¸­å¿ƒï¼ˆè½‰æ›ç‚ºç•«é¢ç™¾åˆ†æ¯”ï¼‰
          const left = (obstacle.bbox.x / this.videoWidth) * 100 + '%'; // ç›¸æ©Ÿç•«é¢åŸå§‹å¯¬åº¦
          const top = (obstacle.bbox.y / this.videoHeight) * 100 + '%';
          marker.style.left = left;
          marker.style.top = top;
          
          // æ ¹æ“šè·é›¢èª¿æ•´é€æ˜åº¦
          const opacity = Math.max(0.3, 1 - (obstacle.distance / 5)); // æœ€å¤§è·é›¢5ç±³
          marker.style.opacity = opacity.toString();
          
          markersContainer.appendChild(marker);
        });

        // èªéŸ³æ’­å ±ç’°å¢ƒè­˜åˆ¥çµæœ
        if (this.isNavigating && this.isIndoorMode) {
          this.speakEnvironmentStatus();
        }

        // å®‰å…¨æŒ‡æ•¸ = 100 - ç¸½é¢¨éšªï¼ˆé™åˆ¶0-100ï¼‰
        const safetyScore = Math.max(0, Math.min(100, 100 - totalRisk * 100)); // ç³»æ•¸å¯èª¿æ•´
        document.getElementById('safetyScore').textContent = `${safetyScore.toFixed(0)}%`;

        // æ›´æ–°æœ€è¿‘éšœç¤™ç‰©é¡¯ç¤ºï¼ˆåŒ…å«é¡å‹ï¼‰
        document.getElementById('closestObstacle').textContent = 
          `æœ€è¿‘ï¼š${closestType} ${closestDistance.toFixed(1)} å…¬å°º`;
      }
      
      // æä¾›é¿éšœæŒ‡å°
      provideAvoidanceGuidance() {
        if (!this.isNavigating || !this.isIndoorMode) return;
        
        const leftObstacle = this.obstacles.find(o => o.position === 'left');
        const rightObstacle = this.obstacles.find(o => o.position === 'right');
        const frontObstacle = this.obstacles.find(o => o.position === 'front');
        
        let advice = '';
        this.hideAllArrows();
        
        // åˆ†æç’°å¢ƒä¸¦æä¾›å»ºè­°
        if (frontObstacle && frontObstacle.distance < 1.5) {
          // å‰æ–¹æœ‰è¿‘è·é›¢éšœç¤™ç‰©
          if (leftObstacle && rightObstacle) {
            // å…©é‚Šéƒ½æœ‰éšœç¤™ç‰©
            if (leftObstacle.distance > rightObstacle.distance) {
              advice = 'å‰æ–¹é˜»å¡ï¼Œå·¦å´ç©ºé–“è¼ƒå¤§ï¼Œå»ºè­°å‘å·¦ç§»å‹•';
              document.getElementById('arrowLeft').classList.add('active');
            } else {
              advice = 'å‰æ–¹é˜»å¡ï¼Œå³å´ç©ºé–“è¼ƒå¤§ï¼Œå»ºè­°å‘å³ç§»å‹•';
              document.getElementById('arrowRight').classList.add('active');
            }
          } else if (leftObstacle && !rightObstacle) {
            advice = 'å‰æ–¹é˜»å¡ï¼Œå»ºè­°å‘å³é¿é–‹';
            document.getElementById('arrowRight').classList.add('active');
          } else if (!leftObstacle && rightObstacle) {
            advice = 'å‰æ–¹é˜»å¡ï¼Œå»ºè­°å‘å·¦é¿é–‹';
            document.getElementById('arrowLeft').classList.add('active');
          } else {
            advice = 'å‰æ–¹æœ‰éšœç¤™ç‰©ï¼Œè«‹å‘å·¦æˆ–å‘å³ç¹è¡Œ';
            document.getElementById('arrowLeft').classList.add('active');
            document.getElementById('arrowRight').classList.add('active');
          }
        } else if (leftObstacle && leftObstacle.distance < 0.8) {
          // å·¦å´å¤ªè¿‘
          advice = 'å·¦å´å¤ªè¿‘ï¼Œå»ºè­°å‘å³èª¿æ•´';
          document.getElementById('arrowRight').classList.add('active');
        } else if (rightObstacle && rightObstacle.distance < 0.8) {
          // å³å´å¤ªè¿‘
          advice = 'å³å´å¤ªè¿‘ï¼Œå»ºè­°å‘å·¦èª¿æ•´';
          document.getElementById('arrowLeft').classList.add('active');
        } else {
          // è·¯å¾‘å®‰å…¨
          advice = 'è·¯å¾‘å®‰å…¨ï¼Œè«‹ç›´è¡Œ';
          document.getElementById('arrowForward').classList.add('active');
        }
        
        document.getElementById('avoidanceAdvice').textContent = advice;
        
        // èªéŸ³æç¤ºç·Šæ€¥æƒ…æ³
        const closest = Math.min(
          leftObstacle?.distance || Infinity,
          rightObstacle?.distance || Infinity,
          frontObstacle?.distance || Infinity
        );
        
        if (closest < 0.5) {
          this.speak('ç·Šæ€¥ï¼éšœç¤™ç‰©éå¸¸æ¥è¿‘ï¼Œè«‹ç«‹å³åœæ­¢ç§»å‹•');
        } else if (closest < 1.0) {
          this.speak(advice);
        }
      }
      
      // éš±è—æ‰€æœ‰ç®­é ­
      hideAllArrows() {
        document.getElementById('arrowLeft').classList.remove('active');
        document.getElementById('arrowRight').classList.remove('active');
        document.getElementById('arrowForward').classList.remove('active');
      }
      
      // èªéŸ³æ’­å ±ç’°å¢ƒè­˜åˆ¥çµæœï¼ˆå¢å¼·ç‰ˆï¼‰
      speakEnvironmentStatus() {
        if (!this.voiceEnabled || !window.speechSynthesis) return;
        
        // é˜²æ­¢éåº¦èªéŸ³æç¤ºï¼ˆè‡³å°‘é–“éš”5ç§’ï¼‰
        const now = Date.now();
        if (now - this.lastSpeakTime < 5000) return;
        this.lastSpeakTime = now;
        
        if (this.obstacles.length === 0) {
          this.speak('ç’°å¢ƒå®‰å…¨ï¼Œæœªåµæ¸¬åˆ°éšœç¤™ç‰©');
          return;
        }
        
        // åˆ†é¡éšœç¤™ç‰©
        const leftObstacles = this.obstacles.filter(o => o.position === 'left');
        const rightObstacles = this.obstacles.filter(o => o.position === 'right');
        const frontObstacles = this.obstacles.filter(o => o.position === 'front');
        
        // æŒ‰è·é›¢æ’åºï¼Œåªæ’­å ±æœ€è¿‘çš„3å€‹éšœç¤™ç‰©
        const allObstacles = [...this.obstacles].sort((a, b) => a.distance - b.distance);
        const topObstacles = allObstacles.slice(0, 3);
        
        let message = 'åµæ¸¬åˆ°';
        
        // æ’­å ±æœ€é‡è¦çš„éšœç¤™ç‰©
        topObstacles.forEach((obstacle, index) => {
          const direction = obstacle.position === 'left' ? 'å·¦å´' : 
                           obstacle.position === 'right' ? 'å³å´' : 'å‰æ–¹';
          const name = this.getObstacleName(obstacle.type);
          
          if (index === 0) {
            message += ` ${direction}${obstacle.distance.toFixed(1)}å…¬å°ºæœ‰${name}`;
          } else if (index === 1) {
            message += `ï¼Œ${direction}${obstacle.distance.toFixed(1)}å…¬å°ºæœ‰${name}`;
          } else {
            message += `ï¼Œé‚„æœ‰${name}`;
          }
        });
        
        message += 'ã€‚';
        
        // æ™ºèƒ½å®‰å…¨å»ºè­°
        const closestDistance = Math.min(...this.obstacles.map(o => o.distance));
        const highRiskObstacles = this.obstacles.filter(o => this.getRiskFactor(o.type) > 0.5);
        const movingObstacles = this.obstacles.filter(o => o.isMoving);
        
        if (closestDistance < 0.3) {
          message += ' ç·Šæ€¥ï¼éšœç¤™ç‰©éå¸¸æ¥è¿‘ï¼Œè«‹ç«‹å³åœæ­¢ç§»å‹•ã€‚';
        } else if (closestDistance < 0.8) {
          message += ' éšœç¤™ç‰©æ¥è¿‘ï¼Œè«‹å°å¿ƒç§»å‹•ã€‚';
        } else if (highRiskObstacles.length > 0) {
          message += ' è«‹æ³¨æ„é«˜é¢¨éšªéšœç¤™ç‰©ã€‚';
        } else if (movingObstacles.length > 0) {
          message += ' æœ‰ç§»å‹•ä¸­çš„éšœç¤™ç‰©ï¼Œè«‹ä¿æŒè­¦è¦ºã€‚';
        } else {
          message += ' è·¯å¾‘ç›¸å°å®‰å…¨ï¼Œè«‹ç¹¼çºŒå‰é€²ã€‚';
        }
        
        // æ·»åŠ ç’°å¢ƒç‰¹å¾µæè¿°
        const hasStairs = this.obstacles.some(o => o.type === 'stairs');
        const hasSlope = this.obstacles.some(o => o.type === 'slope');
        const hasWater = this.obstacles.some(o => o.type === 'water');
        
        if (hasStairs) message += ' å‰æ–¹æœ‰éšæ¢¯ï¼Œè«‹æ³¨æ„è…³æ­¥ã€‚';
        if (hasSlope) message += ' åœ°é¢æœ‰æ–œå¡ï¼Œè«‹ä¿æŒå¹³è¡¡ã€‚';
        if (hasWater) message += ' åœ°é¢æœ‰æ°´æ¼¬ï¼Œè«‹å°å¿ƒæ»‘å€’ã€‚';
        
        this.speak(message);
      }
      
      // ç²å–éšœç¤™ç‰©ä¸­æ–‡åç¨±ï¼ˆæ“´å±•åˆ°40+ç¨®ç‰©å“ï¼‰
      getObstacleName(type) {
        const nameMap = {
          // äººç‰©å‹•ç‰©é¡
          'person': 'äºº', 'baby': 'å¬°å…’', 'child': 'å°å­©', 'adult': 'æˆäºº', 'elderly': 'è€äºº',
          'bird': 'é³¥', 'cat': 'è²“', 'dog': 'ç‹—', 'horse': 'é¦¬', 'cow': 'ç‰›',
          
          // äº¤é€šå·¥å…·é¡
          'car': 'æ±½è»Š', 'bus': 'å…¬è»Š', 'truck': 'å¡è»Š', 'motorcycle': 'æ‘©æ‰˜è»Š', 'bicycle': 'è…³è¸è»Š',
          'train': 'ç«è»Š', 'airplane': 'é£›æ©Ÿ', 'boat': 'èˆ¹', 'scooter': 'æ»‘æ¿è»Š',
          
          // å®¶å…·é¡
          'chair': 'æ¤…å­', 'sofa': 'æ²™ç™¼', 'couch': 'é•·æ²™ç™¼', 'bed': 'åºŠ', 'table': 'æ¡Œå­',
          'desk': 'æ›¸æ¡Œ', 'cabinet': 'æ«¥æ«ƒ', 'wardrobe': 'è¡£æ«ƒ', 'bookshelf': 'æ›¸æ¶',
          
          // é›»å­ç”¢å“é¡
          'tv': 'é›»è¦–', 'computer': 'é›»è…¦', 'laptop': 'ç­†è¨˜å‹é›»è…¦', 'monitor': 'é¡¯ç¤ºå™¨',
          'keyboard': 'éµç›¤', 'mouse': 'æ»‘é¼ ', 'printer': 'å°è¡¨æ©Ÿ', 'scanner': 'æƒæå™¨',
          
          // åœ°é¢é¢¨éšªé¡
          'stairs': 'éšæ¢¯', 'slope': 'æ–œå¡', 'hole': 'å‘æ´', 'water': 'æ°´çªª', 'ice': 'çµå†°',
          'gravel': 'ç¢çŸ³', 'oil': 'æ²¹æ¼¬', 'construction': 'æ–½å·¥å€åŸŸ',
          
          // äº¤é€šè¨­æ–½é¡
          'traffic light': 'ç´…ç¶ ç‡ˆ', 'stop sign': 'åœæ­¢æ¨™èªŒ', 'crosswalk': 'æ–‘é¦¬ç·š',
          'bus stop': 'å…¬è»Šç«™', 'traffic cone': 'äº¤é€šéŒ', 'barricade': 'è·¯éšœ',
          
          // å»ºç¯‰å‡ºå…¥å£é¡
          'door': 'é–€', 'elevator': 'é›»æ¢¯', 'automatic door': 'è‡ªå‹•é–€', 'ramp': 'ç„¡éšœç¤™å¡é“',
          'toilet': 'å»æ‰€', 'exit': 'å‡ºå£', 'entrance': 'å…¥å£',
          
          // å…¶ä»–ç‰©å“é¡
          'tree': 'æ¨¹', 'flower': 'èŠ±', 'fountain': 'å™´æ³‰', 'bench': 'é•·æ¤…',
          'trash can': 'åƒåœ¾æ¡¶', 'mailbox': 'éƒµç®±', 'fire hydrant': 'æ¶ˆé˜²æ “'
        };
        return nameMap[type] || type;
      }
      
      // åˆ‡æ›èªéŸ³é–‹é—œ
      toggleVoice() {
        this.voiceEnabled = !this.voiceEnabled;
        const voiceToggleText = document.getElementById('voiceToggleText');
        if (voiceToggleText) {
          voiceToggleText.textContent = this.voiceEnabled ? 'ğŸ”‡ éœéŸ³' : 'ğŸ”Š é–‹å•Ÿ';
        }
        
        if (this.voiceEnabled) {
          this.speak('èªéŸ³æ’­å ±å·²é–‹å•Ÿ');
        } else {
          window.speechSynthesis.cancel();
          this.speak('èªéŸ³æ’­å ±å·²éœéŸ³');
        }
      }
      
      // åŠ è¼‰å®¶çš„ä½ç½®
      loadHomePosition() {
        try {
          const savedHome = localStorage.getItem('homePosition');
          if (savedHome) {
            this.homePosition = JSON.parse(savedHome);
            this.updateHomeInfo();
            this.speak('å®¶çš„ä½ç½®å·²è¼‰å…¥ï¼Œå¯ä»¥é–‹å§‹å°èˆª');
          } else {
            this.speak('æ­¡è¿ä½¿ç”¨æ™ºèƒ½é¿éšœå°èˆªç³»çµ±ï¼Œè«‹å…ˆè¨­å®šå®¶çš„ä½ç½®');
          }
        } catch (error) {
          console.error('åŠ è¼‰å®¶çš„ä½ç½®å¤±æ•—:', error);
          this.homePosition = null;
          this.speak('å®¶çš„ä½ç½®æ•¸æ“šæå£ï¼Œè«‹é‡æ–°è¨­å®š');
        }
      }
      
      toggleNavigation() {
        if (this.isNavigating) {
          this.stopNavigation();
        } else {
          this.startNavigation();
        }
      }
      
      async startNavigation() {
        if (!this.homePosition && !this.isIndoorMode) {
          this.speak('è«‹å…ˆè¨­å®šå®¶çš„ä½ç½®');
          return;
        }
        
        this.isNavigating = true;
        this.updateSystemStatus('å°èˆªä¸­');
        
        try {
          await this.initializeCamera();
        } catch (error) {
          console.log('ç›¸æ©Ÿåˆå§‹åŒ–è·³é');
        }
        
        if (this.isIndoorMode) {
          this.speak('å®¤å…§é¿éšœæ¨¡å¼å•Ÿå‹•ï¼Œé–‹å§‹ç’°å¢ƒæƒæ');
        } else {
          this.speak('å®¤å¤–å°èˆªå•Ÿå‹•');
          this.startGPSTracking();
        }
        
        this.updateUI();
      }
      
      stopNavigation() {
        this.isNavigating = false;
        this.isFollowing = false;
        
        if (this.gpsWatchId) {
          navigator.geolocation.clearWatch(this.gpsWatchId);
          this.gpsWatchId = null;
        }
        
        this.updateSystemStatus('å·²åœæ­¢');
        this.speak('å°èˆªå·²åœæ­¢');
        this.hideTrackingIndicator();
        this.hideAllArrows();
        this.updateUI();
      }
      
      togglePersonFollowing() {
        if (!this.isNavigating) {
          this.speak('è«‹å…ˆå•Ÿå‹•å°èˆª');
          return;
        }
        
        if (this.isIndoorMode) {
          this.speak('å®¤å…§æ¨¡å¼ä¸‹ç„¡æ³•ä½¿ç”¨äººå“¡è·Ÿéš¨');
          return;
        }
        
        this.isFollowing = !this.isFollowing;
        
        if (this.isFollowing) {
          this.speak('äººå“¡è·Ÿéš¨å•Ÿå‹•ï¼Œæ­£åœ¨å°‹æ‰¾å¼•å°è€…');
          this.showTrackingIndicator();
        } else {
          this.speak('äººå“¡è·Ÿéš¨åœæ­¢');
          this.hideTrackingIndicator();
        }
        
        this.updateUI();
      }
      
      showHomeSetup() {
        this.speak('è«‹èµ°åˆ°å®¶é–€å£ï¼Œåœ¨å®¤å¤–è¨­å®šå®¶çš„ä½ç½®');
        // ç°¡åŒ–è¨­å®šæµç¨‹
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (position) => {
              this.homePosition = {
                lat: position.coords.latitude,
                lng: position.coords.longitude,
                accuracy: position.coords.accuracy
              };
              localStorage.setItem('homePosition', JSON.stringify(this.homePosition));
              this.updateHomeInfo();
              this.speak('å®¶çš„ä½ç½®è¨­å®šæˆåŠŸ');
            },
            (error) => {
              this.speak('GPSå®šä½å¤±æ•—ï¼Œè«‹ç¢ºä¿åœ¨å®¤å¤–æ“ä½œ');
            }
          );
        }
      }
      
      emergencyAlert() {
        this.speak('ç·Šæ€¥æ±‚åŠ©å·²ç™¼é€ï¼ä½ç½®ä¿¡æ¯å·²å‚³é€çµ¦ç·Šæ€¥è¯çµ¡äºº');
      }
      
      async initializeCamera() {
        try {
          const video = document.getElementById('video');
          const stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: 'environment' }
          });
          video.srcObject = stream;
        } catch (error) {
          console.warn('ç›¸æ©Ÿä¸å¯ç”¨');
        }
      }
      
      startGPSTracking() {
        if (!navigator.geolocation) return;
        
        this.gpsWatchId = navigator.geolocation.watchPosition(
          (position) => {
            this.currentPosition = position.coords;
            this.updateHomeInfo();
          },
          (error) => {
            console.log('GPSè¿½è¸ªéŒ¯èª¤:', error);
          },
          { enableHighAccuracy: true, timeout: 10000 }
        );
      }
      
      updateHomeInfo() {
        if (this.homePosition && this.currentPosition) {
          const distance = this.calculateDistance(
            this.currentPosition.latitude, this.currentPosition.longitude,
            this.homePosition.lat, this.homePosition.lng
          );
          document.getElementById('homeDistance').textContent = distance.toFixed(0) + 'm';
          document.getElementById('distanceBadge').style.display = 'block';
          document.getElementById('directionArrow').classList.add('active');
        }
      }
      
      calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371000;
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
          Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
          Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
      }
      
      updateSystemStatus(status) {
        document.getElementById('systemStatus').textContent = status;
      }
      
      showTrackingIndicator() {
        document.getElementById('trackingIndicator').classList.add('active');
      }
      
      hideTrackingIndicator() {
        document.getElementById('trackingIndicator').classList.remove('active');
      }
      
      updateUI() {
        const startBtn = document.getElementById('btnStart');
        const followBtn = document.getElementById('btnFollow');
        
        if (startBtn) {
          startBtn.textContent = this.isNavigating ? 'åœæ­¢å°èˆª' : 'é–‹å§‹å°èˆª';
          startBtn.classList.toggle('btn-danger', this.isNavigating);
          startBtn.classList.toggle('btn-primary', !this.isNavigating);
          
          // æ·»åŠ æŒ‰éˆ•æç¤ºæ–‡æœ¬
          if (this.isIndoorMode && !this.isNavigating) {
            startBtn.title = 'å®¤å…§æ¨¡å¼ï¼šå•Ÿå‹•é¿éšœå°èˆª';
          } else if (!this.isIndoorMode && !this.isNavigating) {
            startBtn.title = 'å®¤å¤–æ¨¡å¼ï¼šå•Ÿå‹•GPSå°èˆª';
          }
        }
        
        if (followBtn) {
          followBtn.textContent = this.isFollowing ? 'åœæ­¢è·Ÿéš¨' : 'äººå“¡è·Ÿéš¨';
          followBtn.disabled = !this.isNavigating || this.isIndoorMode;
          
          // æ·»åŠ æŒ‰éˆ•æç¤ºæ–‡æœ¬
          if (this.isIndoorMode) {
            followBtn.title = 'å®¤å…§æ¨¡å¼ä¸æ”¯æŒäººå“¡è·Ÿéš¨';
          } else if (this.isNavigating) {
            followBtn.title = this.isFollowing ? 'åœæ­¢è·Ÿéš¨å¼•å°è€…' : 'å•Ÿå‹•äººå“¡è·Ÿéš¨æ¨¡å¼';
          } else {
            followBtn.title = 'è«‹å…ˆå•Ÿå‹•å°èˆª';
          }
        }
      }
      
      speak(message) {
        if (this.voiceEnabled && window.speechSynthesis) {
          window.speechSynthesis.cancel();
          const utterance = new SpeechSynthesisUtterance(message);
          utterance.lang = 'zh-TW';
          utterance.rate = 0.8;
          window.speechSynthesis.speak(utterance);
        }
        document.getElementById('voiceAlert').textContent = message;
      }
    }

    // åˆå§‹åŒ–ç³»çµ±
    const navSystem = new ObstacleAvoidanceSystem();

    // äº‹ä»¶ç›£è½å™¨
    document.getElementById('btnOutdoorMode').addEventListener('click', () => {
      navSystem.switchMode(false);
    });
    
    document.getElementById('btnIndoorMode').addEventListener('click', () => {
      navSystem.switchMode(true);
    });
    
    document.getElementById('btnStart').addEventListener('click', () => {
      navSystem.toggleNavigation();
    });
    
    document.getElementById('btnFollow').addEventListener('click', () => {
      navSystem.togglePersonFollowing();
    });
    
    document.getElementById('btnSetHome').addEventListener('click', () => {
      navSystem.showHomeSetup();
    });
    
    document.getElementById('btnStop').addEventListener('click', () => {
      navSystem.stopNavigation();
    });
    
    document.getElementById('btnEmergency').addEventListener('click', () => {
      navSystem.emergencyAlert();
    });

    // åˆå§‹èªéŸ³æç¤º
    window.addEventListener('DOMContentLoaded', () => {
      setTimeout(() => {
        if (!navSystem.homePosition) {
          navSystem.speak('æ­¡è¿ä½¿ç”¨æ™ºèƒ½é¿éšœå°èˆªç³»çµ±ï¼Œè«‹å…ˆè¨­å®šå®¶çš„ä½ç½®');
        }
      }, 1000);
    });
  </script>
</body>
</html>